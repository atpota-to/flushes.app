(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[297],{41102:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.AtUri=t.ATP_URI_REGEX=void 0,a(r(75505),t),t.ATP_URI_REGEX=/^(at:\/\/)?((?:did:[a-z0-9:%-]+)|(?:[a-z0-9][a-z0-9.:-]*))(\/[^?#\s]*)?(\?[^#\s]+)?(#[^\s]+)?$/i;let o=/^(\/[^?#\s]*)?(\?[^#\s]+)?(#[^\s]+)?$/i;class n{constructor(e,t){let r;if(Object.defineProperty(this,"hash",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"host",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pathname",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"searchParams",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),t){if(!(r=s(t)))throw Error(`Invalid at uri: ${t}`);let i=function(e){let t=o.exec(e);if(t)return{hash:t[3]||"",pathname:t[1]||"",searchParams:new URLSearchParams(t[2]||"")}}(e);if(!i)throw Error(`Invalid path: ${e}`);Object.assign(r,i)}else if(!(r=s(e)))throw Error(`Invalid at uri: ${e}`);this.hash=r.hash,this.host=r.host,this.pathname=r.pathname,this.searchParams=r.searchParams}static make(e,t,r){let i=e;return t&&(i+="/"+t),r&&(i+="/"+r),new n(i)}get protocol(){return"at:"}get origin(){return`at://${this.host}`}get hostname(){return this.host}set hostname(e){this.host=e}get search(){return this.searchParams.toString()}set search(e){this.searchParams=new URLSearchParams(e)}get collection(){return this.pathname.split("/").filter(Boolean)[0]||""}set collection(e){let t=this.pathname.split("/").filter(Boolean);t[0]=e,this.pathname=t.join("/")}get rkey(){return this.pathname.split("/").filter(Boolean)[1]||""}set rkey(e){let t=this.pathname.split("/").filter(Boolean);t[0]||(t[0]="undefined"),t[1]=e,this.pathname=t.join("/")}get href(){return this.toString()}toString(){let e=this.pathname||"/";e.startsWith("/")||(e=`/${e}`);let t=this.searchParams.toString();t&&!t.startsWith("?")&&(t=`?${t}`);let r=this.hash;return r&&!r.startsWith("#")&&(r=`#${r}`),`at://${this.host}${e}${t}${r}`}}function s(e){let r=t.ATP_URI_REGEX.exec(e);if(r)return{hash:r[5]||"",host:r[2]||"",pathname:r[3]||"",searchParams:new URLSearchParams(r[4]||"")}}t.AtUri=n},75505:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ensureValidAtUriRegex=t.ensureValidAtUri=void 0;let i=r(92542),a=r(58613),o=r(74043);t.ensureValidAtUri=e=>{let t=e.split("#");if(t.length>2)throw Error('ATURI can have at most one "#", separating fragment out');let r=t[1]||null;if(e=t[0],!/^[a-zA-Z0-9._~:@!$&')(*+,;=%/-]*$/.test(e))throw Error("Disallowed characters in ATURI (ASCII)");let n=e.split("/");if(n.length>=3&&("at:"!==n[0]||0!==n[1].length))throw Error('ATURI must start with "at://"');if(n.length<3)throw Error("ATURI requires at least method and authority sections");try{n[2].startsWith("did:")?(0,i.ensureValidDid)(n[2]):(0,a.ensureValidHandle)(n[2])}catch{throw Error("ATURI authority must be a valid handle or DID")}if(n.length>=4){if(0===n[3].length)throw Error("ATURI can not have a slash after authority without a path segment");try{(0,o.ensureValidNsid)(n[3])}catch{throw Error("ATURI requires first path segment (if supplied) to be valid NSID")}}if(n.length>=5&&0===n[4].length)throw Error("ATURI can not have a slash after collection, unless record key is provided");if(n.length>=6)throw Error("ATURI path can have at most two parts, and no trailing slash");if(t.length>=2&&null==r)throw Error("ATURI fragment must be non-empty and start with slash");if(null!=r){if(0===r.length||"/"!==r[0])throw Error("ATURI fragment must be non-empty and start with slash");if(!/^\/[a-zA-Z0-9._~:@!$&')(*+,;=%[\]/-]*$/.test(r))throw Error("Disallowed characters in ATURI fragment (ASCII)")}if(e.length>8192)throw Error("ATURI is far too long")},t.ensureValidAtUriRegex=e=>{let t=e.match(/^at:\/\/(?<authority>[a-zA-Z0-9._:%-]+)(\/(?<collection>[a-zA-Z0-9-.]+)(\/(?<rkey>[a-zA-Z0-9._~:@!$&%')(*+,;=-]+))?)?(#(?<fragment>\/[a-zA-Z0-9._~:@!$&%')(*+,;=\-[\]/\\]*))?$/);if(!t||!t.groups)throw Error("ATURI didn't validate via regex");let r=t.groups;try{(0,a.ensureValidHandleRegex)(r.authority)}catch{try{(0,i.ensureValidDidRegex)(r.authority)}catch{throw Error("ATURI authority must be a valid handle or DID")}}if(r.collection)try{(0,o.ensureValidNsidRegex)(r.collection)}catch{throw Error("ATURI collection path segment must be a valid NSID")}if(e.length>8192)throw Error("ATURI is far too long")}},68485:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidDatetimeError=t.normalizeDatetimeAlways=t.normalizeDatetime=t.isValidDatetime=t.ensureValidDatetime=void 0,t.ensureValidDatetime=e=>{let t=new Date(e);if(isNaN(t.getTime()))throw new r("datetime did not parse as ISO 8601");if(t.toISOString().startsWith("-"))throw new r("datetime normalized to a negative time");if(!/^[0-9]{4}-[01][0-9]-[0-3][0-9]T[0-2][0-9]:[0-6][0-9]:[0-6][0-9](.[0-9]{1,20})?(Z|([+-][0-2][0-9]:[0-5][0-9]))$/.test(e))throw new r("datetime didn't validate via regex");if(e.length>64)throw new r("datetime is too long (64 chars max)");if(e.endsWith("-00:00"))throw new r('datetime can not use "-00:00" for UTC timezone');if(e.startsWith("000"))throw new r("datetime so close to year zero not allowed")},t.isValidDatetime=e=>{try{(0,t.ensureValidDatetime)(e)}catch(e){if(e instanceof r)return!1;throw e}return!0},t.normalizeDatetime=e=>{if((0,t.isValidDatetime)(e)){let r=new Date(e).toISOString();if((0,t.isValidDatetime)(r))return r}if(!/.*(([+-]\d\d:?\d\d)|[a-zA-Z])$/.test(e)){let r=new Date(e+"Z");if(!isNaN(r.getTime())){let e=r.toISOString();if((0,t.isValidDatetime)(e))return e}}let i=new Date(e);if(isNaN(i.getTime()))throw new r("datetime did not parse as any timestamp format");let a=i.toISOString();if((0,t.isValidDatetime)(a))return a;throw new r("datetime normalized to invalid timestamp string")},t.normalizeDatetimeAlways=e=>{try{return(0,t.normalizeDatetime)(e)}catch(e){if(e instanceof r)return new Date(0).toISOString();throw e}};class r extends Error{}t.InvalidDatetimeError=r},92542:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidDidError=t.ensureValidDidRegex=t.ensureValidDid=void 0,t.ensureValidDid=e=>{if(!e.startsWith("did:"))throw new r('DID requires "did:" prefix');if(!/^[a-zA-Z0-9._:%-]*$/.test(e))throw new r("Disallowed characters in DID (ASCII letters, digits, and a couple other characters only)");let{length:t,1:i}=e.split(":");if(t<3)throw new r("DID requires prefix, method, and method-specific content");if(!/^[a-z]+$/.test(i))throw new r("DID method must be lower-case letters");if(e.endsWith(":")||e.endsWith("%"))throw new r('DID can not end with ":" or "%"');if(e.length>2048)throw new r("DID is too long (2048 chars max)")},t.ensureValidDidRegex=e=>{if(!/^did:[a-z]+:[a-zA-Z0-9._:%-]*[a-zA-Z0-9._-]$/.test(e))throw new r("DID didn't validate via regex");if(e.length>2048)throw new r("DID is too long (2048 chars max)")};class r extends Error{}t.InvalidDidError=r},58613:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DisallowedDomainError=t.UnsupportedDomainError=t.ReservedHandleError=t.InvalidHandleError=t.isValidTld=t.isValidHandle=t.normalizeAndEnsureValidHandle=t.normalizeHandle=t.ensureValidHandleRegex=t.ensureValidHandle=t.DISALLOWED_TLDS=t.INVALID_HANDLE=void 0,t.INVALID_HANDLE="handle.invalid",t.DISALLOWED_TLDS=[".local",".arpa",".invalid",".localhost",".internal",".example",".alt",".onion"],t.ensureValidHandle=e=>{if(!/^[a-zA-Z0-9.-]*$/.test(e))throw new r("Disallowed characters in handle (ASCII letters, digits, dashes, periods only)");if(e.length>253)throw new r("Handle is too long (253 chars max)");let t=e.split(".");if(t.length<2)throw new r("Handle domain needs at least two parts");for(let e=0;e<t.length;e++){let i=t[e];if(i.length<1)throw new r("Handle parts can not be empty");if(i.length>63)throw new r("Handle part too long (max 63 chars)");if(i.endsWith("-")||i.startsWith("-"))throw new r("Handle parts can not start or end with hyphens");if(e+1===t.length&&!/^[a-zA-Z]/.test(i))throw new r("Handle final component (TLD) must start with ASCII letter")}},t.ensureValidHandleRegex=e=>{if(!/^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/.test(e))throw new r("Handle didn't validate via regex");if(e.length>253)throw new r("Handle is too long (253 chars max)")},t.normalizeHandle=e=>e.toLowerCase(),t.normalizeAndEnsureValidHandle=e=>{let r=(0,t.normalizeHandle)(e);return(0,t.ensureValidHandle)(r),r},t.isValidHandle=e=>{try{(0,t.ensureValidHandle)(e)}catch(e){if(e instanceof r)return!1;throw e}return!0},t.isValidTld=e=>!t.DISALLOWED_TLDS.some(t=>e.endsWith(t));class r extends Error{}t.InvalidHandleError=r;class i extends Error{}t.ReservedHandleError=i;class a extends Error{}t.UnsupportedDomainError=a;class o extends Error{}t.DisallowedDomainError=o},54836:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(58613),t),a(r(92542),t),a(r(74043),t),a(r(41102),t),a(r(75594),t),a(r(18252),t),a(r(68485),t)},74043:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidNsidError=t.ensureValidNsidRegex=t.ensureValidNsid=t.NSID=void 0;class r{static parse(e){return new r(e)}static create(e,t){return new r([...e.split(".").reverse(),t].join("."))}static isValid(e){try{return r.parse(e),!0}catch(e){return!1}}constructor(e){Object.defineProperty(this,"segments",{enumerable:!0,configurable:!0,writable:!0,value:[]}),(0,t.ensureValidNsid)(e),this.segments=e.split(".")}get authority(){return this.segments.slice(0,this.segments.length-1).reverse().join(".")}get name(){return this.segments.at(this.segments.length-1)}toString(){return this.segments.join(".")}}t.NSID=r,t.ensureValidNsid=e=>{if(!/^[a-zA-Z0-9.-]*$/.test(e))throw new i("Disallowed characters in NSID (ASCII letters, digits, dashes, periods only)");if(e.length>317)throw new i("NSID is too long (317 chars max)");let t=e.split(".");if(t.length<3)throw new i("NSID needs at least three parts");for(let e=0;e<t.length;e++){let r=t[e];if(r.length<1)throw new i("NSID parts can not be empty");if(r.length>63)throw new i("NSID part too long (max 63 chars)");if(r.endsWith("-")||r.startsWith("-"))throw new i("NSID parts can not start or end with hyphen");if(/^[0-9]/.test(r)&&0===e)throw new i("NSID first part may not start with a digit");if(!/^[a-zA-Z][a-zA-Z0-9]*$/.test(r)&&e+1===t.length)throw new i("NSID name part must be only letters and digits (and no leading digit)")}},t.ensureValidNsidRegex=e=>{if(!/^[a-zA-Z]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(\.[a-zA-Z]([a-zA-Z0-9]{0,62})?)$/.test(e))throw new i("NSID didn't validate via regex");if(e.length>317)throw new i("NSID is too long (317 chars max)")};class i extends Error{}t.InvalidNsidError=i},18252:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidRecordKeyError=t.isValidRecordKey=t.ensureValidRecordKey=void 0,t.ensureValidRecordKey=e=>{if(e.length>512||e.length<1)throw new r("record key must be 1 to 512 characters");if(!/^[a-zA-Z0-9_~.:-]{1,512}$/.test(e))throw new r("record key syntax not valid (regex)");if("."===e||".."===e)throw new r('record key can not be "." or ".."')},t.isValidRecordKey=e=>{try{(0,t.ensureValidRecordKey)(e)}catch(e){if(e instanceof r)return!1;throw e}return!0};class r extends Error{}t.InvalidRecordKeyError=r},75594:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidTidError=t.isValidTid=t.ensureValidTid=void 0;let r=/^[234567abcdefghij][234567abcdefghijklmnopqrstuvwxyz]{12}$/;t.ensureValidTid=e=>{if(13!==e.length)throw new i("TID must be 13 characters");if(!r.test(e))throw new i("TID syntax not valid (regex)")},t.isValidTid=e=>13===e.length&&r.test(e);class i extends Error{}t.InvalidTidError=i},40257:function(e,t,r){"use strict";var i,a;e.exports=(null==(i=r.g.process)?void 0:i.env)&&"object"==typeof(null==(a=r.g.process)?void 0:a.env)?r.g.process:r(44227)},44227:function(e){!function(){var t={229:function(e){var t,r,i,a=e.exports={};function o(){throw Error("setTimeout has not been defined")}function n(){throw Error("clearTimeout has not been defined")}function s(e){if(t===setTimeout)return setTimeout(e,0);if((t===o||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(r){try{return t.call(null,e,0)}catch(r){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:o}catch(e){t=o}try{r="function"==typeof clearTimeout?clearTimeout:n}catch(e){r=n}}();var c=[],l=!1,d=-1;function u(){l&&i&&(l=!1,i.length?c=i.concat(c):d=-1,c.length&&h())}function h(){if(!l){var e=s(u);l=!0;for(var t=c.length;t;){for(i=c,c=[];++d<t;)i&&i[d].run();d=-1,t=c.length}i=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===n||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function f(){}a.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new p(e,t)),1!==c.length||l||s(h)},p.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=f,a.addListener=f,a.once=f,a.off=f,a.removeListener=f,a.removeAllListeners=f,a.emit=f,a.prependListener=f,a.prependOnceListener=f,a.listeners=function(e){return[]},a.binding=function(e){throw Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw Error("process.chdir is not supported")},a.umask=function(){return 0}}},r={};function i(e){var a=r[e];if(void 0!==a)return a.exports;var o=r[e]={exports:{}},n=!0;try{t[e](o,o.exports,i),n=!1}finally{n&&delete r[e]}return o.exports}i.ab="//";var a=i(229);e.exports=a}()},93901:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DidCacheMemory=void 0;let i=r(69489);class a extends i.SimpleStoreMemory{constructor(e){super(e?.max==null?{ttl:36e5,maxSize:52428800,...e}:{ttl:36e5,...e})}}t.DidCacheMemory=a},82728:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DidResolverCached=void 0;let i=r(96228),a=r(93901);class o{constructor(e,t=new a.DidCacheMemory){Object.defineProperty(this,"getter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.getter=new i.CachedGetter((t,r)=>e.resolve(t,r),t)}async resolve(e,t){return this.getter.get(e,t)}}t.DidResolverCached=o},20802:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},32167:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DidResolverBase=void 0;let i=r(14747),a=r(24146),o=r(10162);class n{constructor(e){Object.defineProperty(this,"methods",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.methods=new Map(Object.entries(e))}async resolve(e,t){t?.signal?.throwIfAborted();let r=(0,a.extractDidMethod)(e),n=this.methods.get(r);if(!n)throw new a.DidError(e,"Unsupported DID method","did-method-invalid",400);try{let r=await n.resolve(e,t);if(r.id!==e)throw new a.DidError(e,`DID document id (${r.id}) does not match DID`,"did-document-id-mismatch",400);return r}catch(t){if(t instanceof o.FetchResponseError){let r=t.response.status>=500?502:t.response.status;throw new a.DidError(e,t.message,"did-fetch-error",r,t)}if(t instanceof o.FetchError)throw new a.DidError(e,t.message,"did-fetch-error",400,t);if(t instanceof i.ZodError)throw new a.DidError(e,t.message,"did-document-format-error",503,t);throw a.DidError.from(t,e)}}}t.DidResolverBase=n},63107:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DidResolverCommon=void 0;let i=r(32167),a=r(80900),o=r(66037);class n extends i.DidResolverBase{constructor(e){super({plc:new a.DidPlcMethod(e),web:new o.DidWebMethod(e)})}}t.DidResolverCommon=n},13925:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},75561:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(24146),t),a(r(93901),t),a(r(82728),t),a(r(20802),t),a(r(63107),t),a(r(13925),t),a(r(32280),t),a(r(30790),t)},32280:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(80900),t),a(r(66037),t)},80900:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DidPlcMethod=void 0;let i=r(24146),a=r(10162),o=(0,r(37319).pipe)((0,a.fetchOkProcessor)(),(0,a.fetchJsonProcessor)(/^application\/(did\+ld\+)?json$/),(0,a.fetchJsonZodProcessor)(i.didDocumentValidator));class n{constructor(e){Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plcDirectoryUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.plcDirectoryUrl=new URL(e?.plcDirectoryUrl||"https://plc.directory/"),this.fetch=(0,a.bindFetch)(e?.fetch)}async resolve(e,t){(0,i.assertDidPlc)(e);let r=new URL(`/${encodeURIComponent(e)}`,this.plcDirectoryUrl);return this.fetch(r,{redirect:"error",headers:{accept:"application/did+ld+json,application/json"},signal:t?.signal}).then(o)}}t.DidPlcMethod=n},66037:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DidWebMethod=void 0,t.buildDidWebDocumentUrl=s;let i=r(24146),a=r(10162),o=(0,r(37319).pipe)((0,a.fetchOkProcessor)(),(0,a.fetchJsonProcessor)(/^application\/(did\+ld\+)?json$/),(0,a.fetchJsonZodProcessor)(i.didDocumentValidator));class n{constructor({fetch:e=globalThis.fetch,allowHttp:t=!0}={}){Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"allowHttp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fetch=(0,a.bindFetch)(e),this.allowHttp=t}async resolve(e,t){let r=s(e);if(!this.allowHttp&&"http:"===r.protocol)throw new i.DidError(e,'Resolution of "http" did:web is not allowed',"did-web-http-not-allowed");return this.fetch(r,{redirect:"error",headers:{accept:"application/did+ld+json,application/json"},signal:t?.signal}).then(o)}}function s(e){let t=(0,i.didWebToUrl)(e);return"/"===t.pathname?new URL("/.well-known/did.json",t):new URL(`${t.pathname}/did.json`,t)}t.DidWebMethod=n},30790:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},22794:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FetchError=void 0;class r extends Error{constructor(e,t,r){super(t,r),Object.defineProperty(this,"statusCode",{enumerable:!0,configurable:!0,writable:!0,value:e})}get expose(){return!0}}t.FetchError=r},53867:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_FORBIDDEN_DOMAIN_NAMES=t.FetchRequestError=void 0,t.protocolCheckRequestTransform=function(e){return(t,r)=>{let{protocol:i,port:s}=(0,o.extractUrl)(t),c=(0,a.asRequest)(t,r),l=Object.hasOwn(e,i)?e[i]:void 0;if(l){if(!0===l);else if(!l.allowCustomPort&&""!==s)throw new n(c,400,`Custom ${i} ports not allowed`)}else throw new n(c,400,`Forbidden protocol "${i}"`);return c}},t.explicitRedirectCheckRequestTransform=function(){return(e,t)=>{let r=(0,a.asRequest)(e,t);if(t?.redirect!=null)return r;if("follow"===r.redirect)throw new n(r,500,'Request redirect must be "error" or "manual"');return r}},t.requireHostHeaderTransform=function(){return(e,t)=>{let{protocol:r,hostname:i}=(0,o.extractUrl)(e),s=(0,a.asRequest)(e,t);if("http:"!==r&&"https:"!==r)throw new n(s,400,`"${r}" requests are not allowed`);if(!i||(0,o.isIp)(i))throw new n(s,400,"Invalid hostname");return s}},t.forbiddenDomainNameRequestTransform=function(e=t.DEFAULT_FORBIDDEN_DOMAIN_NAMES){let r=new Set(e);return 0===r.size?a.asRequest:async(e,t)=>{let{hostname:i}=(0,o.extractUrl)(e),s=(0,a.asRequest)(e,t);if(r.has(i))throw new n(s,403,"Forbidden hostname");let c=i.indexOf(".");for(;-1!==c;){let e=i.slice(c+1);if(r.has(`*.${e}`))throw new n(s,403,"Forbidden hostname");c=i.indexOf(".",c+1)}return s}};let i=r(22794),a=r(97904),o=r(17008);class n extends i.FetchError{constructor(e,t,r,i){if(null==t||!r){var a;let e=function(e){if("string"==typeof e&&e.length>0)return[500,e];if(!(e instanceof Error))return[500,"Failed to fetch"];switch(e.message){case"failed to fetch the data URL":return[400,e.message];case"unexpected redirect":case"cors failure":case"blocked":case"proxy authentication required":return[502,e.message]}let t=e.code;if("string"==typeof t)switch(!0){case"ENOTFOUND"===t:return[400,"Invalid hostname"];case"ECONNREFUSED"===t:return[502,"Connection refused"];case"DEPTH_ZERO_SELF_SIGNED_CERT"===t:return[502,"Self-signed certificate"];case t.startsWith("ERR_TLS"):return[502,"TLS error"];case t.startsWith("ECONN"):return[502,"Connection error"];default:return[500,`${t} error`]}return[500,e.message]}((a=i?.cause)instanceof TypeError&&"fetch failed"===a.message&&void 0!==a.cause?a.cause:a);t??(t=e[0]),r||(r=e[1])}super(t,r,i),Object.defineProperty(this,"request",{enumerable:!0,configurable:!0,writable:!0,value:e})}get expose(){return 500!==this.statusCode}static from(e,t){return t instanceof n?t:new n(e,void 0,void 0,{cause:t})}}t.FetchRequestError=n,t.DEFAULT_FORBIDDEN_DOMAIN_NAMES=["example.com","*.example.com","example.org","*.example.org","example.net","*.example.net","googleusercontent.com","*.googleusercontent.com"]},42383:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fetchJsonZodProcessor=t.FetchResponseError=void 0,t.peekJson=d,t.checkLength=u,t.extractLength=h,t.extractMime=p,t.cancelBodyOnError=f,t.fetchOkProcessor=function(e){return f(t=>y(t,e))},t.fetchOkTransformer=y,t.fetchMaxSizeProcessor=function(e){if(e===1/0)return e=>e;if(!Number.isFinite(e)||e<0)throw TypeError("maxBytes must be a 0, Infinity or a positive number");return f(t=>m(t,e))},t.fetchResponseMaxSizeChecker=m,t.fetchTypeProcessor=w,t.fetchResponseTypeChecker=g,t.fetchResponseJsonTransformer=b,t.fetchJsonProcessor=function(e=s,t=!0){return(0,i.pipe)(w(e,t),f(b))},t.fetchJsonValidatorProcessor=v;let i=r(37319),a=r(22794),o=r(19959),n=r(17008),s=/^application\/(?:[^()<>@,;:/[\]\\?={} \t]+\+)?json$/i;class c extends a.FetchError{constructor(e,t=e.status,r=e.statusText,i){super(t,r,i),Object.defineProperty(this,"response",{enumerable:!0,configurable:!0,writable:!0,value:e})}static async from(e,t=l,r=e.status,i){let a="string"==typeof t?t:"function"==typeof t?await t(e):void 0;return new c(e,r,a,i)}}t.FetchResponseError=c;let l=async e=>{let t=p(e);if(t)try{if("text/plain"===t)return await e.text();if(s.test(t)){let t=await e.json();if("string"==typeof t)return t;if("object"==typeof t&&null!=t){let e=(0,n.ifString)(t.error_description);if(e)return e;let r=(0,n.ifString)(t.error);if(r)return r;let i=(0,n.ifString)(t.message);if(i)return i}}}catch{}};async function d(e,t=1/0){if("application/json"!==p(e))return;u(e,t);let r=e.clone();return(e.body&&t<1/0?new o.TransformedResponse(r,new n.MaxBytesTransformStream(t)):r).json()}function u(e,t){if(!(t>=0))throw TypeError("maxBytes must be a non-negative number");let r=h(e);if(null!=r&&r>t)throw new c(e,502,"Response too large");return r}function h(e){let t=e.headers.get("Content-Length");if(null==t)return;if(!/^\d+$/.test(t))throw new c(e,502,"Invalid Content-Length");let r=Number(t);if(!Number.isSafeInteger(r))throw new c(e,502,"Content-Length too large");return r}function p(e){let t=e.headers.get("Content-Type");if(null!=t)return t.split(";",1)[0].trim()}function f(e,t=n.logCancellationError){return async r=>{try{return await e(r)}catch(e){throw await (0,n.cancelBody)(r,t??void 0),e}}}async function y(e,t){if(e.ok)return e;throw await c.from(e,t)}function m(e,t){if(t===1/0||(u(e,t),!e.body))return e;let r=new n.MaxBytesTransformStream(t);return new o.TransformedResponse(e,r)}function w(e,t=!0){let r="string"==typeof e?t=>t===e:e instanceof RegExp?t=>e.test(t):e;return f(e=>g(e,r,t))}async function g(e,t,r=!0){let i=p(e);if(i){if(!t(i.toLowerCase()))throw await c.from(e,`Unexpected response Content-Type (${i})`,502)}else if(r)throw await c.from(e,"Missing response Content-Type header",502);return e}async function b(e){try{let t=await e.json();return{response:e,json:t}}catch(t){throw new c(e,502,"Unable to parse response as JSON",{cause:t})}}function v(e,t){if("parseAsync"in e&&"function"==typeof e.parseAsync)return async r=>e.parseAsync(r.json,t);if("parse"in e&&"function"==typeof e.parse)return async r=>e.parse(r.json,t);throw TypeError("Invalid schema")}t.fetchJsonZodProcessor=v},9315:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timedFetch=void 0,t.loggedFetch=function({fetch:e=globalThis.fetch,logRequest:t=!0,logResponse:r=!0,logError:i=!0}){let o=!0===t?async e=>{let t=await (0,n.stringifyMessage)(e);console.info(`> ${e.method} ${e.url}
${(0,n.padLines)(t,"  ")}`)}:t||void 0,s=!0===r?async e=>{let t=await (0,n.stringifyMessage)(e.clone());console.info(`< HTTP/1.1 ${e.status} ${e.statusText}
${(0,n.padLines)(t,"  ")}`)}:r||void 0,c=!0===i?async e=>{console.error("< Error:",e)}:i||void 0;return o||s||c?(0,a.toRequestTransformer)(async function(t){o&&await o(t);try{let r=await e.call(this,t);return s&&await s(r,t),r}catch(e){throw c&&await c(e,t),e}}):e},t.bindFetch=function(e=globalThis.fetch,t=globalThis){return(0,a.toRequestTransformer)(async r=>{try{return await e.call(t,r)}catch(e){throw i.FetchRequestError.from(r,e)}})};let i=r(53867),a=r(97904),o=r(19959),n=r(17008);t.timedFetch=(e=6e4,t=globalThis.fetch)=>{if(e===1/0)return t;if(!Number.isFinite(e)||e<=0)throw TypeError("Timeout must be positive");return(0,a.toRequestTransformer)(async function(r){let i=new AbortController,a=i.signal,n=()=>{i.abort()},s=()=>{clearTimeout(c),r.signal?.removeEventListener("abort",n)},c=setTimeout(n,e);"object"==typeof c&&c.unref?.(),r.signal?.addEventListener("abort",n),a.addEventListener("abort",s);let l=await t.call(this,r,{signal:a});if(!l.body)return s(),l;{let e=new TransformStream({flush:s});return new o.TransformedResponse(l,e)}})}},97904:function(e,t){"use strict";function r(e,t){return!t&&e instanceof Request?e:new Request(e,t)}Object.defineProperty(t,"__esModule",{value:!0}),t.toRequestTransformer=function(e){return function(t,i){return e.call(this,r(t,i))}},t.asRequest=r},10162:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(22794),t),a(r(53867),t),a(r(42383),t),a(r(9315),t),a(r(97904),t),a(r(17008),t)},19959:function(e,t){"use strict";var r,i=this&&this.__classPrivateFieldSet||function(e,t,r,i,a){if("m"===i)throw TypeError("Private method is not writable");if("a"===i&&!a)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(e,r):a?a.value=r:t.set(e,r),r},a=this&&this.__classPrivateFieldGet||function(e,t,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.TransformedResponse=void 0;class o extends Response{constructor(e,t){if(!e.body)throw TypeError("Response body is not available");if(e.bodyUsed)throw TypeError("Response body is already used");super(e.body.pipeThrough(t),{status:e.status,statusText:e.statusText,headers:e.headers}),r.set(this,void 0),i(this,r,e,"f")}get url(){return a(this,r,"f").url}get redirected(){return a(this,r,"f").redirected}get type(){return a(this,r,"f").type}get statusText(){return a(this,r,"f").statusText}}t.TransformedResponse=o,r=new WeakMap},17008:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractUrl=t.MaxBytesTransformStream=t.ifString=void 0,t.isIp=function(e){return!!(e.match(/^\d+\.\d+\.\d+\.\d+$/)||e.startsWith("[")&&e.endsWith("]"))},t.padLines=function(e,t){return e?t+e.replace(i,`$&${t}`):e},t.cancelBody=a,t.logCancellationError=o,t.stringifyMessage=n,t.ifString=e=>"string"==typeof e?e:void 0;class r extends TransformStream{constructor(e){if(!(e>=0))throw TypeError("maxBytes must be a non-negative number");let t=0;super({transform:(r,i)=>{(t+=r.length)<=e?i.enqueue(r):i.error(Error("Response too large"))}})}}t.MaxBytesTransformStream=r;let i=/\r?\n/g;async function a(e,t){!e.body||e.bodyUsed||e.body.locked||"function"!=typeof e.body.cancel||("function"==typeof t?e.body.cancel().catch(t):"log"===t?e.body.cancel().catch(o):await e.body.cancel())}function o(e){console.warn("Failed to cancel response body",e)}async function n(e){try{var t;let r=(t=e.headers,Array.from(t).map(([e,t])=>`${e}: ${t}`).join("\n")),i=await s(e);return r&&i?`${r}
${i}`:r||i}finally{a(e,"log")}}async function s(e){try{let t=await e.blob();if(t.type?.startsWith("text/")){let e=await t.text();return JSON.stringify(e)}if(/application\/(?:\w+\+)?json/.test(t.type)){let e=await t.text();return e.includes("\n")?JSON.stringify(JSON.parse(e)):e}return`[Body size: ${t.size}, type: ${JSON.stringify(t.type)} ]`}catch{return"[Body could not be read]"}}t.extractUrl=e=>"string"==typeof e?new URL(e):e instanceof URL?e:new URL(e.url)},66878:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppViewHandleResolver=t.xrpcErrorSchema=void 0;let i=r(14747),a=r(85139);t.xrpcErrorSchema=i.z.object({error:i.z.string(),message:i.z.string().optional()});class o{static from(e,t){return"string"==typeof e||e instanceof URL?new o(e,t):e}constructor(e,t){Object.defineProperty(this,"serviceUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.serviceUrl=new URL(e),this.fetch=t?.fetch??globalThis.fetch}async resolve(e,r){let i=new URL("/xrpc/com.atproto.identity.resolveHandle",this.serviceUrl);i.searchParams.set("handle",e);let o=await this.fetch.call(null,i,{cache:r?.noCache?"no-cache":void 0,signal:r?.signal,redirect:"error"}),n=await o.json();if(400===o.status){let e=t.xrpcErrorSchema.parse(n);if("InvalidRequest"===e.error&&"Unable to resolve handle"===e.message)return null}if(!o.ok)throw TypeError("Invalid response from resolveHandle method");let s=n?.did;if(!(0,a.isResolvedHandle)(s))throw TypeError("Invalid DID returned from resolveHandle method");return s}}t.AppViewHandleResolver=o},8391:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AtprotoDohHandleResolver=void 0;let i=r(77412);class a extends i.AtprotoHandleResolver{constructor(e){super({...e,resolveTxt:function({dohEndpoint:e,fetch:t=globalThis.fetch}){return async r=>{let i=new URL(e);i.searchParams.set("type","TXT"),i.searchParams.set("name",r);let a=await t(i,{method:"GET",headers:{accept:"application/dns-json"},redirect:"follow"});try{let e=a.headers.get("content-type")?.trim();if(a.ok){if(e?.match(/application\/(dns-)?json/i)==null)throw TypeError("Unexpected response from DoH server")}else{let t=e?.startsWith("text/plain")?await a.text():`Failed to resolve ${r}`;throw TypeError(t)}let t=function(e){var t;if("object"==typeof e&&null!==e&&"Status"in e&&"number"==typeof e.Status&&(!("Answer"in e)||(t=e.Answer,Array.isArray(t)&&t.every(n))))return e;throw TypeError("Invalid DoH response")}(await a.json());return t.Answer?.filter(s).map(c)??null}finally{!1===a.bodyUsed&&a.body?.cancel().catch(o)}}}(e),resolveTxtFallback:void 0})}}function o(e){e instanceof DOMException&&"AbortError"===e.name||console.error("An error occurred while cancelling the response body:",e)}function n(e){return"object"==typeof e&&null!==e&&"name"in e&&"string"==typeof e.name&&"type"in e&&"number"==typeof e.type&&"data"in e&&"string"==typeof e.data&&"TTL"in e&&"number"==typeof e.TTL}function s(e){return 16===e.type}function c(e){return e.data.replace(/^"|"$/g,"").replace(/\\"/g,'"')}t.AtprotoDohHandleResolver=a},77412:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AtprotoHandleResolver=void 0;let i=r(49483),a=r(1006),o=()=>{};class n{constructor(e){Object.defineProperty(this,"httpResolver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dnsResolver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dnsResolverFallback",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.httpResolver=new a.WellKnownHandleResolver(e),this.dnsResolver=new i.DnsHandleResolver(e.resolveTxt),this.dnsResolverFallback=e.resolveTxtFallback?new i.DnsHandleResolver(e.resolveTxtFallback):void 0}async resolve(e,t){t?.signal?.throwIfAborted();let r=new AbortController,{signal:i}=r;t?.signal?.addEventListener("abort",()=>r.abort(),{signal:i});let a={...t,signal:i};try{let t=this.dnsResolver.resolve(e,a),r=this.httpResolver.resolve(e,a);r.catch(o);let n=await t;if(n)return n;i.throwIfAborted();let s=await r;if(s)return s;return i.throwIfAborted(),this.dnsResolverFallback?.resolve(e,a)??null}finally{r.abort()}}}t.AtprotoHandleResolver=n},83069:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CachedHandleResolver=void 0;let i=r(96228),a=r(69489);class o{constructor(e,t=new a.SimpleStoreMemory({max:1e3,ttl:6e5})){Object.defineProperty(this,"getter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.getter=new i.CachedGetter((t,r)=>e.resolve(t,r),t)}async resolve(e,t){return this.getter.get(e,t)}}t.CachedHandleResolver=o},77015:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(85139),t),a(r(66878),t),a(r(8391),t),a(r(77412),t),a(r(83069),t)},49483:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DnsHandleResolver=void 0;let i=r(85139),a="did=";class o{constructor(e){Object.defineProperty(this,"resolveTxt",{enumerable:!0,configurable:!0,writable:!0,value:e})}async resolve(e){let t=await this.resolveTxt.call(null,`_atproto.${e}`);if(!t)return null;for(let e=0;e<t.length;e++){if(!t[e].startsWith(a))continue;for(let r=e+1;r<t.length;r++)if(t[r].startsWith(a))return null;let r=t[e].slice(a.length);return(0,i.isResolvedHandle)(r)?r:null}return null}}t.DnsHandleResolver=o},1006:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WellKnownHandleResolver=void 0;let i=r(85139);class a{constructor(e){Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fetch=e?.fetch??globalThis.fetch}async resolve(e,t){let r=new URL("/.well-known/atproto-did",`https://${e}`);try{let e=await this.fetch.call(null,r,{cache:t?.noCache?"no-cache":void 0,signal:t?.signal,redirect:"error"}),a=(await e.text()).split("\n")[0].trim();if((0,i.isResolvedHandle)(a))return a;return null}catch(e){return t?.signal?.throwIfAborted(),null}}}t.WellKnownHandleResolver=a},85139:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isResolvedHandle=function(e){return null===e||(0,i.isAtprotoDid)(e)};let i=r(24146)},28529:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IdentityResolver=void 0;let i=r(54836),a=r(77015);class o{constructor(e,t){Object.defineProperty(this,"didResolver",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handleResolver",{enumerable:!0,configurable:!0,writable:!0,value:t})}async resolve(e,t){let r=(0,a.isResolvedHandle)(e)?await this.getDocumentFromDid(e,t):await this.getDocumentFromHandle(e,t),i=r.service?.find(n,r);if(!i)throw TypeError(`No valid "AtprotoPersonalDataServer" service found in "${r.id}" DID document`);return{did:r.id,pds:new URL(i.serviceEndpoint)}}async getDocumentFromDid(e,t){return this.didResolver.resolve(e,t)}async getDocumentFromHandle(e,t){let r=(0,i.normalizeAndEnsureValidHandle)(e),a=await this.handleResolver.resolve(r,t);if(!a)throw TypeError(`Handle "${r}" does not resolve to a DID`);t?.signal?.throwIfAborted();let o=await this.didResolver.resolve(a,t);if(!o.alsoKnownAs?.includes(`at://${r}`))throw TypeError(`Did document for "${a}" does not include the handle "${r}"`);return o}}function n(e){return"string"==typeof e.serviceEndpoint&&"AtprotoPersonalDataServer"===e.type&&(e.id.startsWith("#")?"#atproto_pds"===e.id:e.id===`${this.id}#atproto_pds`)}t.IdentityResolver=o},17196:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(28529),t)},37319:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pipeTwo=t.pipe=void 0;var i=r(13364);Object.defineProperty(t,"pipe",{enumerable:!0,get:function(){return i.pipe}}),Object.defineProperty(t,"pipeTwo",{enumerable:!0,get:function(){return i.pipeTwo}})},13364:function(e,t){"use strict";function r(e,t){return async(...r)=>t(await e(...r))}Object.defineProperty(t,"__esModule",{value:!0}),t.pipe=function(...e){return e.reduce(r)},t.pipeTwo=r},69489:function(e,t,r){"use strict";var i,a=this&&this.__classPrivateFieldSet||function(e,t,r,i,a){if("m"===i)throw TypeError("Private method is not writable");if("a"===i&&!a)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(e,r):a?a.value=r:t.set(e,r),r},o=this&&this.__classPrivateFieldGet||function(e,t,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleStoreMemory=void 0;let n=r(30329),s=r(51112),c=Symbol("nullItem"),l=e=>null===e?c:e,d=e=>e===c?null:e;class u{constructor({sizeCalculation:e,...t}){i.set(this,void 0),a(this,i,new n.LRUCache({...t,allowStale:!1,updateAgeOnGet:!1,updateAgeOnHas:!1,sizeCalculation:e?(t,r)=>e(d(t),r):null!=t.maxEntrySize||null!=t.maxSize?s.roughSizeOfObject:void 0}),"f")}get(e){let t=o(this,i,"f").get(e);if(void 0!==t)return d(t)}set(e,t){o(this,i,"f").set(e,l(t))}del(e){o(this,i,"f").delete(e)}clear(){o(this,i,"f").clear()}}t.SimpleStoreMemory=u,i=new WeakMap},51112:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.roughSizeOfObject=function(e){let t=new Set,i=[e],a=0;for(;i.length;){let e=i.pop();switch(typeof e){case"string":a+=12+4*Math.ceil(e.length/4);break;case"number":a+=12;break;case"boolean":a+=4;break;case"object":if(a+=4,null===e)break;if(r.has(e)){a+=r.get(e);break}if(t.has(e))continue;if(t.add(e),Array.isArray(e))a+=4,i.push(...e);else{a+=8;let t=Object.getOwnPropertyNames(e);for(let r=0;r<t.length;r++){a+=4;let o=t[r],n=e[o];void 0!==n&&i.push(n),i.push(o)}}break;case"function":case"symbol":a+=8;break;case"bigint":a+=16}}return"object"==typeof e&&null!==e&&r.set(e,a),a};let r=new WeakMap},23446:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CachedGetter=void 0;let r=()=>!0,i=()=>!1;class a{constructor(e,t,r){Object.defineProperty(this,"getter",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"pending",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}async get(e,t={}){let a;t.signal?.throwIfAborted();let o=this.options?.isStale,n=t.noCache?i:t.allowStale||null==o?r:async t=>!await o(e,t);for(;a=this.pending.get(e);){try{let{isFresh:e,value:t}=await a;if(e||await n(t))return t}catch{}t.signal?.throwIfAborted()}let s=Promise.resolve().then(async()=>{let r=await this.getStored(e,t);return void 0!==r&&await n(r)?{isFresh:!1,value:r}:Promise.resolve().then(async()=>(0,this.getter)(e,t,r)).catch(async t=>{if(void 0!==r)try{let i=this.options?.deleteOnError;await i?.(t,e,r)&&await this.delStored(e,t)}catch(e){throw AggregateError([t,e],"Error while deleting stored value")}throw t}).then(async t=>(await this.setStored(e,t),{isFresh:!0,value:t}))}).finally(()=>{this.pending.delete(e)});if(this.pending.has(e))throw Error("Concurrent request for the same key");this.pending.set(e,s);let{value:c}=await s;return c}async getStored(e,t){try{return await this.store.get(e,t)}catch(e){return}}async setStored(e,t){try{await this.store.set(e,t)}catch(i){let r=this.options?.onStoreError;await r?.(i,e,t)}}async delStored(e,t){await this.store.del(e)}}t.CachedGetter=a},96228:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(23446),t),a(r(64513),t)},64513:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},90098:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.atprotoDidSchema=void 0,t.isAtprotoDid=n,t.asAtprotoDid=function(e){return s(e),e},t.assertAtprotoDid=s,t.assertAtprotoDidWeb=c,t.isAtprotoDidWeb=l;let i=r(14747),a=r(45008),o=r(27485);function n(e){return"string"==typeof e&&(e.startsWith(o.DID_PLC_PREFIX)?(0,o.isDidPlc)(e):!!e.startsWith(o.DID_WEB_PREFIX)&&l(e))}function s(e){if("string"!=typeof e)throw new a.InvalidDidError(typeof e,"DID must be a string");if(e.startsWith(o.DID_PLC_PREFIX))(0,o.assertDidPlc)(e);else if(e.startsWith(o.DID_WEB_PREFIX))c(e);else throw new a.InvalidDidError(e,'Atproto only allows "plc" and "web" DID methods')}function c(e){if((0,o.assertDidWeb)(e),e.includes(":",o.DID_WEB_PREFIX.length))throw new a.InvalidDidError(e,"Atproto does not allow path components in Web DIDs");if(e.includes("%3A",o.DID_WEB_PREFIX.length)&&!e.startsWith("did:web:localhost%3A"))throw new a.InvalidDidError(e,"Atproto does not allow port numbers in Web DIDs, except for localhost")}function l(e){try{return c(e),!0}catch{return!1}}t.atprotoDidSchema=i.z.string().refine(n,'Atproto only allows "plc" and "web" DID methods')},8595:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.didDocumentValidator=t.didDocumentSchema=void 0;let i=r(14747),a=r(87391),o=i.z.string().refine(e=>{try{return new URL(e),!0}catch{return!1}},"RFC3968 compliant URI"),n=i.z.union([a.didSchema,i.z.array(a.didSchema)]),s=i.z.union([o,i.z.string().regex(/^#[^#]+$/)]),c=i.z.object({id:s,type:i.z.string().min(1),controller:n,publicKeyJwk:i.z.record(i.z.string(),i.z.unknown()).optional(),publicKeyMultibase:i.z.string().optional()}),l=i.z.union([i.z.string(),i.z.array(i.z.string())]),d=i.z.union([o,i.z.record(i.z.string(),o),i.z.array(i.z.union([o,i.z.record(i.z.string(),o)])).nonempty()]),u=i.z.object({id:s,type:l,serviceEndpoint:d}),h=i.z.union([s,c]);t.didDocumentSchema=i.z.object({"@context":i.z.union([i.z.literal("https://www.w3.org/ns/did/v1"),i.z.array(i.z.string().url()).nonempty().refine(e=>"https://www.w3.org/ns/did/v1"===e[0],{message:"First @context must be https://www.w3.org/ns/did/v1"})]),id:a.didSchema,controller:n.optional(),alsoKnownAs:i.z.array(o).optional(),service:i.z.array(u).optional(),authentication:i.z.array(h).optional(),verificationMethod:i.z.array(i.z.union([c,s])).optional()}),t.didDocumentValidator=t.didDocumentSchema.superRefine(({id:e,service:t},r)=>{if(t){let a=new Set;for(let o=0;o<t.length;o++){let n=t[o],s=n.id.startsWith("#")?`${e}${n.id}`:n.id;a.has(s)?r.addIssue({code:i.z.ZodIssueCode.custom,message:`Duplicate service id (${n.id}) found in the document`,path:["service",o,"id"]}):a.add(s)}}})},45008:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidDidError=t.DidError=void 0;class r extends Error{constructor(e,t,r,i=400,a){super(t,{cause:a}),Object.defineProperty(this,"did",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:i})}get statusCode(){return this.status}toString(){return`${this.constructor.name} ${this.code} (${this.did}): ${this.message}`}static from(e,t){return e instanceof r?e:new r(t,e instanceof Error?e.message:"string"==typeof e?e:"An unknown error occurred","did-unknown-error",("number"==typeof e?.statusCode?e.statusCode:void 0)??("number"==typeof e?.status?e.status:void 0),e)}}t.DidError=r;class i extends r{constructor(e,t,r){super(e,t,"did-invalid",400,r)}}t.InvalidDidError=i},87391:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.didSchema=t.DID_PREFIX=void 0,t.assertDidMethod=s,t.extractDidMethod=function(e){let t=e.indexOf(":",n);return e.slice(n,t)},t.assertDidMsid=c,t.assertDid=l,t.isDid=function(e){try{return l(e),!0}catch(e){if(e instanceof a.DidError)return!1;throw e}},t.asDid=function(e){return l(e),e};let i=r(14747),a=r(45008),o="did:";t.DID_PREFIX=o;let n=o.length;function s(e,t=0,r=e.length){let i;if(!Number.isFinite(r)||!Number.isFinite(t)||r<t||r>e.length)throw TypeError("Invalid start or end position");if(r===t)throw new a.InvalidDidError(e,"Empty method name");for(let o=t;o<r;o++)if(((i=e.charCodeAt(o))<97||i>122)&&(i<48||i>57))throw new a.InvalidDidError(e,`Invalid character at position ${o} in DID method name`)}function c(e,t=0,r=e.length){let i;if(!Number.isFinite(r)||!Number.isFinite(t)||r<t||r>e.length)throw TypeError("Invalid start or end position");if(r===t)throw new a.InvalidDidError(e,"DID method-specific id must not be empty");for(let o=t;o<r;o++)if(((i=e.charCodeAt(o))<97||i>122)&&(i<65||i>90)&&(i<48||i>57)&&46!==i&&45!==i&&95!==i){if(58===i){if(o===r-1)throw new a.InvalidDidError(e,'DID cannot end with ":"');continue}if(37===i){if(((i=e.charCodeAt(++o))<48||i>57)&&(i<65||i>70)||((i=e.charCodeAt(++o))<48||i>57)&&(i<65||i>70))throw new a.InvalidDidError(e,`Invalid pct-encoded character at position ${o}`);if(o>=r)throw new a.InvalidDidError(e,`Incomplete pct-encoded character at position ${o-2}`);continue}throw new a.InvalidDidError(e,`Disallowed character in DID at position ${o}`)}}function l(e){if("string"!=typeof e)throw new a.InvalidDidError(typeof e,"DID must be a string");let{length:t}=e;if(t>2048)throw new a.InvalidDidError(e,"DID is too long (2048 chars max)");if(!e.startsWith(o))throw new a.InvalidDidError(e,`DID requires "${o}" prefix`);let r=e.indexOf(":",n);if(-1===r)throw new a.InvalidDidError(e,"Missing colon after method name");s(e,n,r),c(e,r+1,t)}t.didSchema=i.z.string().superRefine((e,t)=>{try{return l(e),!0}catch(e){return t.addIssue({code:i.z.ZodIssueCode.custom,message:e instanceof Error?e.message:"Unexpected error"}),!1}})},24146:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(90098),t),a(r(8595),t),a(r(45008),t),a(r(87391),t),a(r(27485),t)},27485:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(55616),t),a(r(68718),t)},55616:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DID_PLC_PREFIX=void 0,t.isDidPlc=function(e){if("string"!=typeof e||32!==e.length||!e.startsWith(a))return!1;for(let t=o;t<32;t++)if(!s(e.charCodeAt(t)))return!1;return!0},t.asDidPlc=function(e){return n(e),e},t.assertDidPlc=n;let i=r(45008),a="did:plc:";t.DID_PLC_PREFIX=a;let o=a.length;function n(e){if("string"!=typeof e)throw new i.InvalidDidError(typeof e,"DID must be a string");if(!e.startsWith(a))throw new i.InvalidDidError(e,"Invalid did:plc prefix");if(32!==e.length)throw new i.InvalidDidError(e,"did:plc must be 32 characters long");for(let t=o;t<32;t++)if(!s(e.charCodeAt(t)))throw new i.InvalidDidError(e,`Invalid character at position ${t}`)}let s=e=>e>=97&&e<=122||e>=50&&e<=55},68718:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DID_WEB_PREFIX=void 0,t.isDidWeb=function(e){if("string"!=typeof e||!e.startsWith(t.DID_WEB_PREFIX)||":"===e.charAt(t.DID_WEB_PREFIX.length))return!1;try{return n(e),!0}catch{return!1}},t.asDidWeb=function(e){return o(e),e},t.assertDidWeb=o,t.didWebToUrl=n,t.urlToDidWeb=function(e){let t=e.port?`%3A${e.port}`:"",r="/"===e.pathname?"":e.pathname.replaceAll("/",":");return`did:web:${e.hostname}${t}${r}`};let i=r(45008),a=r(87391);function o(e){if("string"!=typeof e)throw new i.InvalidDidError(typeof e,"DID must be a string");if(!e.startsWith(t.DID_WEB_PREFIX))throw new i.InvalidDidError(e,"Invalid did:web prefix");if(":"===e.charAt(t.DID_WEB_PREFIX.length))throw new i.InvalidDidError(e,"did:web MSID must not start with a colon");n(e)}function n(e){(0,a.assertDidMsid)(e,t.DID_WEB_PREFIX.length);let r=t.DID_WEB_PREFIX.length,o=e.indexOf(":",r),n=-1===o?e.slice(r):e.slice(r,o),s=-1===o?"":e.slice(o);try{let e=new URL(`https://${n.replaceAll("%3A",":")}${s.replaceAll(":","/")}`);return"localhost"===e.hostname&&(e.protocol="http:"),e}catch(t){throw new i.InvalidDidError(e,"Invalid Web DID",t)}}t.DID_WEB_PREFIX="did:web:"},94022:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(83201),t)},83201:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JoseKey=void 0;let i=r(86924),a=r(19538),o=r(68091),{JOSEError:n}=i.errors;class s extends a.Key{async getKeyObj(e){if(!this.algorithms.includes(e))throw new a.JwkError(`Key cannot be used with algorithm "${e}"`);try{return await (0,i.importJWK)(this.jwk,e)}catch(e){throw new a.JwkError("Failed to import JWK",void 0,{cause:e})}}async createJwt(e,t){try{let{kid:r}=e;if(r&&r!==this.kid)throw new a.JwtCreateError(`Invalid "kid" (${r}) used to sign with key "${this.kid}"`);let{alg:o}=e;if(!o)throw new a.JwtCreateError('Missing "alg" in JWT header');let n=await this.getKeyObj(o),s=new i.SignJWT(t).setProtectedHeader({...e,alg:o,kid:this.kid});return await s.sign(n)}catch(e){if(e instanceof n)throw new a.JwtCreateError(e.message,e.code,{cause:e});throw a.JwtCreateError.from(e)}}async verifyJwt(e,t){try{let r=await (0,i.jwtVerify)(e,async({alg:e})=>this.getKeyObj(e),{...t,algorithms:this.algorithms}),o=a.jwtHeaderSchema.safeParse(r.protectedHeader);if(!o.success)throw new a.JwtVerifyError("Invalid JWT header",void 0,{cause:o.error});let n=a.jwtPayloadSchema.safeParse(r.payload);if(!n.success)throw new a.JwtVerifyError("Invalid JWT payload",void 0,{cause:n.error});return{protectedHeader:o.data,payload:n.data}}catch(e){if(e instanceof n)throw new a.JwtVerifyError(e.message,e.code,{cause:e});throw a.JwtVerifyError.from(e)}}static async generateKeyPair(e=["ES256"],t){if(!e.length)throw new a.JwkError("No algorithms provided for key generation");let r=[];for(let a of e)try{return await (0,i.generateKeyPair)(a,t)}catch(e){r.push(e)}throw new a.JwkError("Failed to generate key pair",void 0,{cause:AggregateError(r,"None of the algorithms worked")})}static async generate(e=["ES256"],t,r){let i=await this.generateKeyPair(e,{...r,extractable:!0});return this.fromImportable(i.privateKey,t)}static async fromImportable(e,t){if("string"==typeof e){if(e.startsWith("-----"))return this.fromPKCS8(e,"",t);if(e.startsWith("{"))return this.fromJWK(e,t);throw new a.JwkError("Invalid input")}if("object"==typeof e)return"kty"in e||"alg"in e?this.fromJWK(e,t):this.fromKeyLike(e,t);throw new a.JwkError("Invalid input")}static async fromKeyLike(e,t,r){let o=await (0,i.exportJWK)(e);if(r){if(o.alg){if(o.alg!==r)throw new a.JwkError('Invalid "alg" in JWK')}else o.alg=r}return this.fromJWK(o,t)}static async fromPKCS8(e,t,r){let a=await (0,i.importPKCS8)(e,t,{extractable:!0});return this.fromKeyLike(a,r)}static async fromJWK(e,t){let r="string"==typeof e?JSON.parse(e):e;if(!r||"object"!=typeof r)throw new a.JwkError("Invalid JWK");let i=(0,o.either)(r.kid,t),n=r.use||"sig";return new s(a.jwkValidator.parse({...r,kid:i,use:n}))}}t.JoseKey=s},68091:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.either=function(e,t){if(null!=e&&null!=t&&e!==t)throw TypeError(`Expected "${t}", got "${e}"`);return e??t??void 0}},26784:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(65643),t)},42556:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toSubtleAlgorithm=function(e,t,r){switch(e){case"PS256":case"PS384":case"PS512":return{name:"RSA-PSS",hash:`SHA-${e.slice(-3)}`,modulusLength:r?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};case"RS256":case"RS384":case"RS512":return{name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.slice(-3)}`,modulusLength:r?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};case"ES256":case"ES384":return{name:"ECDSA",namedCurve:`P-${e.slice(-3)}`};case"ES512":return{name:"ECDSA",namedCurve:"P-521"};default:throw TypeError(`Unsupported alg "${e}"`)}},t.fromSubtleAlgorithm=function(e){switch(e.name){case"RSA-PSS":case"RSASSA-PKCS1-v1_5":{let t=e.hash.name;switch(t){case"SHA-256":case"SHA-384":case"SHA-512":{let r="RSA-PSS"===e.name?"PS":"RS";return`${r}${t.slice(-3)}`}default:throw TypeError("unsupported RsaHashedKeyAlgorithm hash")}}case"ECDSA":{let t=e.namedCurve;switch(t){case"P-256":case"P-384":case"P-512":return`ES${t.slice(-3)}`;case"P-521":return"ES512";default:throw TypeError("unsupported EcKeyAlgorithm namedCurve")}}case"Ed448":case"Ed25519":return"EdDSA";default:throw TypeError(`Unexpected algorithm "${e.name}"`)}},t.isCryptoKeyPair=function(e,t){return"object"==typeof e&&null!==e&&"privateKey"in e&&e.privateKey instanceof CryptoKey&&"private"===e.privateKey.type&&(null==t||e.privateKey.extractable===t)&&e.privateKey.usages.includes("sign")&&"publicKey"in e&&e.publicKey instanceof CryptoKey&&"public"===e.publicKey.type&&!0===e.publicKey.extractable&&e.publicKey.usages.includes("verify")}},65643:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebcryptoKey=t.jwkWithAlgSchema=void 0;let i=r(14747),a=r(19538),o=r(94022),n=r(42556);t.jwkWithAlgSchema=i.z.intersection(a.jwkSchema,i.z.object({alg:i.z.string()}));class s extends o.JoseKey{static async generate(e=["ES256"],t=crypto.randomUUID(),r){let i=await this.generateKeyPair(e,r);if(!(0,n.isCryptoKeyPair)(i))throw TypeError("Invalid CryptoKeyPair");return this.fromKeypair(i,t)}static async fromKeypair(e,r){let{key_ops:i,use:a,alg:o=(0,n.fromSubtleAlgorithm)(e.privateKey.algorithm),...c}=await crypto.subtle.exportKey("jwk",e.privateKey.extractable?e.privateKey:e.publicKey);if(a&&"sig"!==a)throw TypeError(`Unsupported JWK use "${a}"`);if(i&&!i.some(e=>"sign"===e||"verify"===e))throw TypeError(`Invalid key_ops "${i}" for "sig" use`);return new s(t.jwkWithAlgSchema.parse({...c,kid:r,alg:o,use:"sig"}),e)}constructor(e,t){super(e),Object.defineProperty(this,"cryptoKeyPair",{enumerable:!0,configurable:!0,writable:!0,value:t})}get isPrivate(){return!0}get privateJwk(){if(super.isPrivate)return this.jwk;throw Error("Private Webcrypto Key not exportable")}async getKeyObj(e){if(this.jwk.alg!==e)throw new a.JwkError(`Key cannot be used with algorithm "${e}"`);return this.cryptoKeyPair.privateKey}}t.WebcryptoKey=s},22040:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jwkAlgorithms=function*(e){if(e.alg){yield e.alg;return}switch(e.kty){case"EC":if(("enc"===e.use||void 0===e.use)&&(yield"ECDH-ES",yield"ECDH-ES+A128KW",yield"ECDH-ES+A192KW",yield"ECDH-ES+A256KW"),"sig"===e.use||void 0===e.use){let t="crv"in e?e.crv:void 0;switch(t){case"P-256":case"P-384":yield`ES${t.slice(-3)}`;break;case"P-521":yield"ES512";break;case"secp256k1":o&&(yield"ES256K");break;default:throw new i.JwkError(`Unsupported crv "${t}"`)}}return;case"OKP":if(!e.use)throw new i.JwkError('Missing "use" Parameter value');yield"ECDH-ES",yield"ECDH-ES+A128KW",yield"ECDH-ES+A192KW",yield"ECDH-ES+A256KW";return;case"RSA":("enc"===e.use||void 0===e.use)&&(yield"RSA-OAEP",yield"RSA-OAEP-256",yield"RSA-OAEP-384",yield"RSA-OAEP-512",o&&(yield"RSA1_5")),("sig"===e.use||void 0===e.use)&&(yield"PS256",yield"PS384",yield"PS512",yield"RS256",yield"RS384",yield"RS512");return;case"oct":("enc"===e.use||void 0===e.use)&&(yield"A128GCMKW",yield"A192GCMKW",yield"A256GCMKW",yield"A128KW",yield"A192KW",yield"A256KW"),("sig"===e.use||void 0===e.use)&&(yield"HS256",yield"HS384",yield"HS512");return;default:throw new i.JwkError(`Unsupported kty "${e.kty}"`)}};let i=r(96456),{process:a}=globalThis,o=void 0!==a&&"string"==typeof a?.versions?.node},96456:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JwtVerifyError=t.JwtCreateError=t.JwkError=t.ERR_JWT_VERIFY=t.ERR_JWT_CREATE=t.ERR_JWT_INVALID=t.ERR_JWK_NOT_FOUND=t.ERR_JWK_INVALID=t.ERR_JWKS_NO_MATCHING_KEY=void 0,t.ERR_JWKS_NO_MATCHING_KEY="ERR_JWKS_NO_MATCHING_KEY",t.ERR_JWK_INVALID="ERR_JWK_INVALID",t.ERR_JWK_NOT_FOUND="ERR_JWK_NOT_FOUND",t.ERR_JWT_INVALID="ERR_JWT_INVALID",t.ERR_JWT_CREATE="ERR_JWT_CREATE",t.ERR_JWT_VERIFY="ERR_JWT_VERIFY";class r extends TypeError{constructor(e="JWK error",r=t.ERR_JWK_INVALID,i){super(e,i),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:r})}}t.JwkError=r;class i extends Error{constructor(e="Unable to create JWT",r=t.ERR_JWT_CREATE,i){super(e,i),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:r})}static from(e,t,a){return e instanceof i?e:e instanceof r?new i(a,e.code,{cause:e}):new i(a,t,{cause:e})}}t.JwtCreateError=i;class a extends Error{constructor(e="Invalid JWT",r=t.ERR_JWT_VERIFY,i){super(e,i),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:r})}static from(e,t,i){return e instanceof a?e:e instanceof r?new a(i,e.code,{cause:e}):new a(i,t,{cause:e})}}t.JwtVerifyError=a},19538:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.ValidationError=void 0;var o=r(14747);Object.defineProperty(t,"ValidationError",{enumerable:!0,get:function(){return o.ZodError}}),a(r(22040),t),a(r(96456),t),a(r(18068),t),a(r(30503),t),a(r(7612),t),a(r(27454),t),a(r(30145),t),a(r(77046),t),a(r(80372),t),a(r(6735),t)},18068:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jwkPubSchema=t.jwkValidator=t.jwkSchema=t.jwkUnknownKeySchema=t.jwkSymKeySchema=t.jwkOkpKeySchema=t.jwkEcSecp256k1KeySchema=t.jwkEcKeySchema=t.jwkRsaKeySchema=t.jwkBaseSchema=t.keyUsageSchema=void 0;let i=r(14747);t.keyUsageSchema=i.z.enum(["sign","verify","encrypt","decrypt","wrapKey","unwrapKey","deriveKey","deriveBits"]),t.jwkBaseSchema=i.z.object({kty:i.z.string().min(1),alg:i.z.string().min(1).optional(),kid:i.z.string().min(1).optional(),ext:i.z.boolean().optional(),use:i.z.enum(["sig","enc"]).optional(),key_ops:i.z.array(t.keyUsageSchema).optional(),x5c:i.z.array(i.z.string()).optional(),x5t:i.z.string().min(1).optional(),"x5t#S256":i.z.string().min(1).optional(),x5u:i.z.string().url().optional()}),t.jwkRsaKeySchema=t.jwkBaseSchema.extend({kty:i.z.literal("RSA"),alg:i.z.enum(["RS256","RS384","RS512","PS256","PS384","PS512"]).optional(),n:i.z.string().min(1),e:i.z.string().min(1),d:i.z.string().min(1).optional(),p:i.z.string().min(1).optional(),q:i.z.string().min(1).optional(),dp:i.z.string().min(1).optional(),dq:i.z.string().min(1).optional(),qi:i.z.string().min(1).optional(),oth:i.z.array(i.z.object({r:i.z.string().optional(),d:i.z.string().optional(),t:i.z.string().optional()})).nonempty().optional()}),t.jwkEcKeySchema=t.jwkBaseSchema.extend({kty:i.z.literal("EC"),alg:i.z.enum(["ES256","ES384","ES512"]).optional(),crv:i.z.enum(["P-256","P-384","P-521"]),x:i.z.string().min(1),y:i.z.string().min(1),d:i.z.string().min(1).optional()}),t.jwkEcSecp256k1KeySchema=t.jwkBaseSchema.extend({kty:i.z.literal("EC"),alg:i.z.enum(["ES256K"]).optional(),crv:i.z.enum(["secp256k1"]),x:i.z.string().min(1),y:i.z.string().min(1),d:i.z.string().min(1).optional()}),t.jwkOkpKeySchema=t.jwkBaseSchema.extend({kty:i.z.literal("OKP"),alg:i.z.enum(["EdDSA"]).optional(),crv:i.z.enum(["Ed25519","Ed448"]),x:i.z.string().min(1),d:i.z.string().min(1).optional()}),t.jwkSymKeySchema=t.jwkBaseSchema.extend({kty:i.z.literal("oct"),alg:i.z.enum(["HS256","HS384","HS512"]).optional(),k:i.z.string()}),t.jwkUnknownKeySchema=t.jwkBaseSchema.extend({kty:i.z.string().refine(e=>"RSA"!==e&&"EC"!==e&&"OKP"!==e&&"oct"!==e)}),t.jwkSchema=i.z.union([t.jwkUnknownKeySchema,t.jwkRsaKeySchema,t.jwkEcKeySchema,t.jwkEcSecp256k1KeySchema,t.jwkOkpKeySchema,t.jwkSymKeySchema]),t.jwkValidator=t.jwkSchema.refine(e=>null!=e.use||null!=e.key_ops,"use or key_ops required").refine(e=>!e.use||!e.key_ops||e.key_ops.every(t=>"sig"===e.use?"sign"===t||"verify"===t:"encrypt"===t||"decrypt"===t),"use and key_ops must be consistent"),t.jwkPubSchema=t.jwkValidator.refine(e=>null!=e.kid,"kid is required").refine(e=>!("k"in e)&&!("d"in e),"private key not allowed")},30503:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jwksPubSchema=t.jwksSchema=void 0;let i=r(14747),a=r(18068);t.jwksSchema=i.z.object({keys:i.z.array(a.jwkSchema)}),t.jwksPubSchema=i.z.object({keys:i.z.array(a.jwkPubSchema)})},7612:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unsafeDecodeJwt=function(e){let{0:t,1:r,length:n}=e.split(".");if(n>3||n<2)throw new i.JwtVerifyError(void 0,i.ERR_JWT_INVALID);let s=a.jwtHeaderSchema.parse((0,o.parseB64uJson)(t));if(2===n&&s?.alg!=="none")throw new i.JwtVerifyError(void 0,i.ERR_JWT_INVALID);return{header:s,payload:a.jwtPayloadSchema.parse((0,o.parseB64uJson)(r))}};let i=r(96456),a=r(30145),o=r(6735)},27454:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},30145:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jwtPayloadSchema=t.jwtHeaderSchema=t.isUnsignedJwt=t.unsignedJwtSchema=t.isSignedJwt=t.signedJwtSchema=void 0;let i=r(14747),a=r(18068),o=r(6735);t.signedJwtSchema=i.z.string().superRefine(o.jwtCharsRefinement).superRefine((0,o.segmentedStringRefinementFactory)(3)),t.isSignedJwt=e=>t.signedJwtSchema.safeParse(e).success,t.unsignedJwtSchema=i.z.string().superRefine(o.jwtCharsRefinement).superRefine((0,o.segmentedStringRefinementFactory)(2)),t.isUnsignedJwt=e=>t.unsignedJwtSchema.safeParse(e).success,t.jwtHeaderSchema=i.z.object({alg:i.z.string(),jku:i.z.string().url().optional(),jwk:i.z.object({kty:i.z.string(),crv:i.z.string().optional(),x:i.z.string().optional(),y:i.z.string().optional(),e:i.z.string().optional(),n:i.z.string().optional()}).optional(),kid:i.z.string().optional(),x5u:i.z.string().optional(),x5c:i.z.array(i.z.string()).optional(),x5t:i.z.string().optional(),"x5t#S256":i.z.string().optional(),typ:i.z.string().optional(),cty:i.z.string().optional(),crit:i.z.array(i.z.string()).optional()}).passthrough(),t.jwtPayloadSchema=i.z.object({iss:i.z.string().optional(),aud:i.z.union([i.z.string(),i.z.array(i.z.string()).nonempty()]).optional(),sub:i.z.string().optional(),exp:i.z.number().int().optional(),nbf:i.z.number().int().optional(),iat:i.z.number().int().optional(),jti:i.z.string().optional(),htm:i.z.string().optional(),htu:i.z.string().optional(),ath:i.z.string().optional(),acr:i.z.string().optional(),azp:i.z.string().optional(),amr:i.z.array(i.z.string()).optional(),cnf:i.z.object({kid:i.z.string().optional(),jwk:a.jwkPubSchema.optional(),jwe:i.z.string().optional(),jku:i.z.string().url().optional(),jkt:i.z.string().optional(),"x5t#S256":i.z.string().optional(),osc:i.z.string().optional()}).optional(),client_id:i.z.string().optional(),scope:i.z.string().optional(),nonce:i.z.string().optional(),at_hash:i.z.string().optional(),c_hash:i.z.string().optional(),s_hash:i.z.string().optional(),auth_time:i.z.number().int().optional(),name:i.z.string().optional(),family_name:i.z.string().optional(),given_name:i.z.string().optional(),middle_name:i.z.string().optional(),nickname:i.z.string().optional(),preferred_username:i.z.string().optional(),gender:i.z.string().optional(),picture:i.z.string().url().optional(),profile:i.z.string().url().optional(),website:i.z.string().url().optional(),birthdate:i.z.string().regex(/\d{4}-\d{2}-\d{2}/).optional(),zoneinfo:i.z.string().regex(/^[A-Za-z0-9_/]+$/).optional(),locale:i.z.string().regex(/^[a-z]{2,3}(-[A-Z]{2})?$/).optional(),updated_at:i.z.number().int().optional(),email:i.z.string().optional(),email_verified:i.z.boolean().optional(),phone_number:i.z.string().optional(),phone_number_verified:i.z.boolean().optional(),address:i.z.object({formatted:i.z.string().optional(),street_address:i.z.string().optional(),locality:i.z.string().optional(),region:i.z.string().optional(),postal_code:i.z.string().optional(),country:i.z.string().optional()}).optional(),authorization_details:i.z.array(i.z.object({type:i.z.string(),locations:i.z.array(i.z.string()).optional(),actions:i.z.array(i.z.string()).optional(),datatypes:i.z.array(i.z.string()).optional(),identifier:i.z.string().optional(),privileges:i.z.array(i.z.string()).optional()}).passthrough()).optional()}).passthrough()},77046:function(e,t,r){"use strict";let i,a,o,n;var s,c=this&&this.__runInitializers||function(e,t,r){for(var i=arguments.length>2,a=0;a<t.length;a++)r=i?t[a].call(e,r):t[a].call(e);return i?r:void 0},l=this&&this.__esDecorate||function(e,t,r,i,a,o){function n(e){if(void 0!==e&&"function"!=typeof e)throw TypeError("Function expected");return e}for(var s,c=i.kind,l="getter"===c?"get":"setter"===c?"set":"value",d=!t&&e?i.static?e:e.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,i.name):{}),h=!1,p=r.length-1;p>=0;p--){var f={};for(var y in i)f[y]="access"===y?{}:i[y];for(var y in i.access)f.access[y]=i.access[y];f.addInitializer=function(e){if(h)throw TypeError("Cannot add initializers after decoration has completed");o.push(n(e||null))};var m=(0,r[p])("accessor"===c?{get:u.get,set:u.set}:u[l],f);if("accessor"===c){if(void 0===m)continue;if(null===m||"object"!=typeof m)throw TypeError("Object expected");(s=n(m.get))&&(u.get=s),(s=n(m.set))&&(u.set=s),(s=n(m.init))&&a.unshift(s)}else(s=n(m))&&("field"===c?a.unshift(s):u[l]=s)}d&&Object.defineProperty(d,i.name,u),h=!0};Object.defineProperty(t,"__esModule",{value:!0}),t.Key=void 0;let d=r(22040),u=r(96456),h=r(18068),p=r(6735),f=h.jwkSchema.readonly(),y=(n=[],s=class{constructor(e){if(Object.defineProperty(this,"jwk",{enumerable:!0,configurable:!0,writable:!0,value:(c(this,n),e)}),!e.use)throw new u.JwkError('Missing "use" Parameter value')}get isPrivate(){let{jwk:e}=this;return"d"in e&&void 0!==e.d||"k"in e&&void 0!==e.k}get isSymetric(){let{jwk:e}=this;return"k"in e&&void 0!==e.k}get privateJwk(){return this.isPrivate?this.jwk:void 0}get publicJwk(){if(!this.isSymetric)return f.parse({...this.jwk,d:void 0,k:void 0})}get bareJwk(){if(this.isSymetric)return;let{kty:e,crv:t,e:r,n:i,x:a,y:o}=this.jwk;return f.parse({crv:t,e:r,kty:e,n:i,x:a,y:o})}get use(){return this.jwk.use}get alg(){return this.jwk.alg}get kid(){return this.jwk.kid}get crv(){return this.jwk.crv}get algorithms(){return Object.freeze(Array.from((0,d.jwkAlgorithms)(this.jwk)))}},(()=>{let e="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;i=[p.cachedGetter],a=[p.cachedGetter],o=[p.cachedGetter],l(s,null,i,{kind:"getter",name:"publicJwk",static:!1,private:!1,access:{has:e=>"publicJwk"in e,get:e=>e.publicJwk},metadata:e},null,n),l(s,null,a,{kind:"getter",name:"bareJwk",static:!1,private:!1,access:{has:e=>"bareJwk"in e,get:e=>e.bareJwk},metadata:e},null,n),l(s,null,o,{kind:"getter",name:"algorithms",static:!1,private:!1,access:{has:e=>"algorithms"in e,get:e=>e.algorithms},metadata:e},null,n),e&&Object.defineProperty(s,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:e})})(),s);t.Key=y},80372:function(e,t,r){"use strict";let i,a,o,n;var s,c=this&&this.__runInitializers||function(e,t,r){for(var i=arguments.length>2,a=0;a<t.length;a++)r=i?t[a].call(e,r):t[a].call(e);return i?r:void 0},l=this&&this.__esDecorate||function(e,t,r,i,a,o){function n(e){if(void 0!==e&&"function"!=typeof e)throw TypeError("Function expected");return e}for(var s,c=i.kind,l="getter"===c?"get":"setter"===c?"set":"value",d=!t&&e?i.static?e:e.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,i.name):{}),h=!1,p=r.length-1;p>=0;p--){var f={};for(var y in i)f[y]="access"===y?{}:i[y];for(var y in i.access)f.access[y]=i.access[y];f.addInitializer=function(e){if(h)throw TypeError("Cannot add initializers after decoration has completed");o.push(n(e||null))};var m=(0,r[p])("accessor"===c?{get:u.get,set:u.set}:u[l],f);if("accessor"===c){if(void 0===m)continue;if(null===m||"object"!=typeof m)throw TypeError("Object expected");(s=n(m.get))&&(u.get=s),(s=n(m.set))&&(u.set=s),(s=n(m.init))&&a.unshift(s)}else(s=n(m))&&("field"===c?a.unshift(s):u[l]=s)}d&&Object.defineProperty(d,i.name,u),h=!0};Object.defineProperty(t,"__esModule",{value:!0}),t.Keyset=void 0;let d=r(96456),u=r(7612),h=r(6735),p=e=>e.privateJwk,f=e=>e.publicJwk,y=(n=[],s=class{constructor(e,t=e instanceof s?[...e.preferredSigningAlgorithms]:["EdDSA","ES256K","ES256","PS256","PS384","PS512","HS256","HS384","HS512"]){Object.defineProperty(this,"preferredSigningAlgorithms",{enumerable:!0,configurable:!0,writable:!0,value:(c(this,n),t)}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=[],i=new Set;for(let t of e)if(t&&(r.push(t),t.kid)){if(i.has(t.kid))throw new d.JwkError(`Duplicate key: ${t.kid}`);i.add(t.kid)}this.keys=Object.freeze(r)}get size(){return this.keys.length}get signAlgorithms(){let e=new Set;for(let t of this)if("sig"===t.use)for(let r of t.algorithms)e.add(r);return Object.freeze([...e].sort((0,h.preferredOrderCmp)(this.preferredSigningAlgorithms)))}get publicJwks(){return{keys:Array.from(this,f).filter(h.isDefined)}}get privateJwks(){return{keys:Array.from(this,p).filter(h.isDefined)}}has(e){return this.keys.some(t=>t.kid===e)}get(e){for(let t of this.list(e))return t;throw new d.JwkError(`Key not found ${e.kid||e.alg||"<unknown>"}`,d.ERR_JWK_NOT_FOUND)}*list(e){if(e.kid?.length!==0&&e.alg?.length!==0){for(let t of this)if(!e.use||t.use===e.use){if(Array.isArray(e.kid)){if(!t.kid||!e.kid.includes(t.kid))continue}else if(e.kid&&t.kid!==e.kid)continue;if(Array.isArray(e.alg)){if(!e.alg.some(e=>t.algorithms.includes(e)))continue}else if("string"==typeof e.alg&&!t.algorithms.includes(e.alg))continue;yield t}}}findKey({kid:e,alg:t,use:r}){let i=[];for(let a of this.list({kid:e,alg:t,use:r}))if(a.isPrivate){if("string"==typeof t)return[a,t];i.push(a)}let a=(0,h.matchesAny)(t),o=i.map(e=>[e,e.algorithms.filter(a)]);for(let e of this.preferredSigningAlgorithms)for(let[t,r]of o)if(r.includes(e))return[t,e];for(let[e,t]of o)for(let r of t)return[e,r];throw new d.JwkError(`No signing key found for ${e||t||r||"<unknown>"}`,d.ERR_JWK_NOT_FOUND)}[(i=[h.cachedGetter],a=[h.cachedGetter],o=[h.cachedGetter],Symbol.iterator)](){return this.keys.values()}async createJwt({alg:e,kid:t,...r},i){try{let[a,o]=this.findKey({alg:e,kid:t,use:"sig"}),n={...r,alg:o,kid:a.kid};return"function"==typeof i&&(i=await i(n,a)),await a.createJwt(n,i)}catch(e){throw d.JwtCreateError.from(e)}}async verifyJwt(e,t){let{header:r}=(0,u.unsafeDecodeJwt)(e),{kid:i,alg:a}=r,o=[];for(let r of this.list({kid:i,alg:a}))try{return{...await r.verifyJwt(e,t),key:r}}catch(e){o.push(e)}switch(o.length){case 0:throw new d.JwtVerifyError("No key matched",d.ERR_JWKS_NO_MATCHING_KEY);case 1:throw d.JwtVerifyError.from(o[0],d.ERR_JWT_INVALID);default:throw d.JwtVerifyError.from(o,d.ERR_JWT_INVALID)}}toJSON(){return structuredClone(this.publicJwks)}},(()=>{let e="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;l(s,null,i,{kind:"getter",name:"signAlgorithms",static:!1,private:!1,access:{has:e=>"signAlgorithms"in e,get:e=>e.signAlgorithms},metadata:e},null,n),l(s,null,a,{kind:"getter",name:"publicJwks",static:!1,private:!1,access:{has:e=>"publicJwks"in e,get:e=>e.publicJwks},metadata:e},null,n),l(s,null,o,{kind:"getter",name:"privateJwks",static:!1,private:!1,access:{has:e=>"privateJwks"in e,get:e=>e.privateJwks},metadata:e},null,n),e&&Object.defineProperty(s,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:e})})(),s);t.Keyset=y},6735:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.segmentedStringRefinementFactory=t.jwtCharsRefinement=t.cachedGetter=t.preferredOrderCmp=t.isDefined=void 0,t.matchesAny=function(e){return null==e?e=>!0:Array.isArray(e)?t=>e.includes(t):t=>t===e},t.parseB64uJson=function(e){let t=i.base64url.baseDecode(e);return JSON.parse(o.decode(t))};let i=r(31080),a=r(14747);t.isDefined=e=>void 0!==e,t.preferredOrderCmp=e=>(t,r)=>{let i=e.indexOf(t),a=e.indexOf(r);return i===a?0:-1===i?1:-1===a?-1:i-a},t.cachedGetter=(e,t)=>function(){let t=e.call(this);return Object.defineProperty(this,e.name,{get:()=>t,enumerable:!0,configurable:!0}),t};let o=new TextDecoder;t.jwtCharsRefinement=(e,t)=>{let r;for(let i=0;i<e.length;i++)if(65<=(r=e.charCodeAt(i))&&r<=90||97<=r&&r<=122||48<=r&&r<=57||45===r||95===r||46===r);else{let r=String.fromCodePoint(e.codePointAt(i));return t.addIssue({code:a.ZodIssueCode.custom,message:`Invalid character "${r}" in JWT at position ${i}`})}},t.segmentedStringRefinementFactory=(e,t=2)=>{if(!Number.isFinite(e)||e<1||(0|e)!==e)throw TypeError(`Count must be a natural number (got ${e})`);let r=e*t+(e-1),i="Invalid JWT format";return(o,n)=>{if(o.length<r)return n.addIssue({code:a.ZodIssueCode.custom,message:`${i}: too short`}),!1;let s=0;for(let r=0;r<e-1;r++){let c=o.indexOf(".",s);if(-1===c)return n.addIssue({code:a.ZodIssueCode.custom,message:`${i}: expected ${e} segments, got ${r+1}`}),!1;if(c-s<t)return n.addIssue({code:a.ZodIssueCode.custom,message:`${i}: segment ${r+1} is too short`}),!1;s=c+1}return -1!==o.indexOf(".",s)?(n.addIssue({code:a.ZodIssueCode.custom,message:`${i}: too many segments`}),!1):!(o.length-s<t)||(n.addIssue({code:a.ZodIssueCode.custom,message:`${i}: last segment is too short`}),!1)}}},16948:function(e,t,r){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.BrowserOAuthClient=void 0;let a=r(32495),o=r(23377),n=r(50605),s=r(33681),c=r(4062),l=r(55766),d="@@atproto/oauth-client-browser",u=`${d}(popup-channel)`,h=`${d}(popup-state):`,p=new BroadcastChannel(`${d}(synchronization-channel)`);class f extends a.OAuthClient{static async load({clientId:e,...t}){if(e.startsWith("http:"))return new f({clientMetadata:(0,o.atprotoLoopbackClientMetadata)(e),...t});if(e.startsWith("https:"))return(0,o.assertOAuthDiscoverableClientId)(e),new f({clientMetadata:await a.OAuthClient.fetchMetadata({clientId:e,...t}),...t});throw TypeError(`Invalid client id: ${e}`)}constructor({clientMetadata:e=(0,o.atprotoLoopbackClientMetadata)((0,l.buildLoopbackClientId)(window.location)),responseMode:t="fragment",...r}){if(!globalThis.crypto?.subtle)throw Error("WebCrypto API is required");if(!["query","fragment"].includes(t))throw TypeError(`Invalid response mode: ${t}`);let a=new n.BrowserOAuthDatabase;super({...r,clientMetadata:e,responseMode:t,keyset:void 0,runtimeImplementation:new s.BrowserRuntimeImplementation,sessionStore:a.getSessionStore(),stateStore:a.getStateStore(),didCache:a.getDidCache(),handleCache:a.getHandleCache(),dpopNonceCache:a.getDpopNonceCache(),authorizationServerMetadataCache:a.getAuthorizationServerMetadataCache(),protectedResourceMetadataCache:a.getProtectedResourceMetadataCache()}),Object.defineProperty(this,i,{enumerable:!0,configurable:!0,writable:!0,value:void 0});let c=new AbortController,{signal:u}=c;for(let e of(this[Symbol.dispose]=()=>c.abort(),u.addEventListener("abort",()=>a[Symbol.asyncDispose](),{once:!0}),this.addEventListener("deleted",({detail:{sub:e}})=>{localStorage.getItem(`${d}(sub)`)===e&&localStorage.removeItem(`${d}(sub)`)}),["deleted","updated"]))this.sessionGetter.addEventListener(e,({detail:t})=>{p.postMessage([e,t])});p.addEventListener("message",e=>{if(e.source!==window){let[t,r]=e.data;this.dispatchCustomEvent(t,r)}},{signal:u})}async init(e){await function(e){if(!(0,o.isOAuthClientIdLoopback)(e.client_id)||"localhost"!==window.location.hostname)return;let t=new URL(window.location.href);for(let r of e.redirect_uris){let e=new URL(r);if(("127.0.0.1"===e.hostname||"[::1]"===e.hostname)&&(!e.port||e.port===t.port)&&e.protocol===t.protocol&&e.pathname===t.pathname)throw e.port=t.port,window.location.href=e.href,Error("Redirecting to loopback IP...")}throw Error(`Please use the loopback IP address instead of ${t}`)}(this.clientMetadata);let t=await this.signInCallback();if(t)return localStorage.setItem(`${d}(sub)`,t.session.sub),t;let r=localStorage.getItem(`${d}(sub)`);if(r)try{return{session:await this.restore(r,e)}}catch(e){throw localStorage.removeItem(`${d}(sub)`),e}}async restore(e,t){let r=await super.restore(e,t);return localStorage.setItem(`${d}(sub)`,r.sub),r}async revoke(e){return localStorage.removeItem(`${d}(sub)`),super.revoke(e)}async signIn(e,t){return t?.display==="popup"?this.signInPopup(e,t):this.signInRedirect(e,t)}async signInRedirect(e,t){let r=await this.authorize(e,t);return window.location.href=r.href,new Promise((e,t)=>{setTimeout(e=>{this.abortRequest(r).then(()=>t(e),r=>t(AggregateError([e,r])))},5e3,Error("User navigated back"))})}async signInPopup(e,t){let r="width=600,height=600,menubar=no,toolbar=no",i=window.open("about:blank","_blank",r),o=`${Math.random().toString(36).slice(2)}`,n=await this.authorize(e,{...t,state:`${h}${o}`,display:t?.display??"popup"});return t?.signal?.throwIfAborted(),i?i.window.location.href=n.href:i=window.open(n.href,"_blank",r),i?.focus(),new Promise((e,r)=>{let n=new BroadcastChannel(u),s=()=>{clearTimeout(l),n.removeEventListener("message",d),n.close(),t?.signal?.removeEventListener("abort",c),i?.close()},c=()=>{r(Error(t?.signal?.aborted?"Aborted":"Timeout")),s()};t?.signal?.addEventListener("abort",c);let l=setTimeout(c,3e5),d=async({data:i})=>{if(i.key!==o||!("result"in i))return;n.postMessage({key:o,ack:!0}),s();let{result:c}=i;if("fulfilled"===c.status){let i=c.value;try{t?.signal?.throwIfAborted(),e(await this.restore(i,!1))}catch(e){r(e),this.revoke(i)}}else{let{message:e,params:t}=c.reason;r(new a.OAuthCallbackError(new URLSearchParams(t),e))}};n.addEventListener("message",d)})}readCallbackParams(){let e=new URLSearchParams("fragment"===this.responseMode?location.hash.slice(1):location.search);return e.has("state")&&(e.has("code")||e.has("error"))&&this.clientMetadata.redirect_uris.map(e=>new URL(e)).some(e=>location.origin===e.origin&&location.pathname===e.pathname)?e:null}async signInCallback(){let e=this.readCallbackParams();if(!e)return null;"fragment"===this.responseMode?history.replaceState(null,"",location.pathname+location.search):"query"===this.responseMode&&history.replaceState(null,"",location.pathname);let t=e=>{let t=new BroadcastChannel(u);return new Promise(r=>{let i=e=>{clearTimeout(o),t.removeEventListener("message",a),t.close(),r(e)},a=({data:t})=>{"ack"in t&&e.key===t.key&&i(!0)};t.addEventListener("message",a),t.postMessage(e);let o=setTimeout(i,500,!1)})};return this.callback(e).then(async e=>{if(e.state?.startsWith(h))throw await t({key:e.state.slice(h.length),result:{status:"fulfilled",value:e.session.sub}})||await e.session.signOut(),new c.LoginContinuedInParentWindowError;return e}).catch(async e=>{if(e instanceof a.OAuthCallbackError&&e.state?.startsWith(h))throw await t({key:e.state.slice(h.length),result:{status:"rejected",reason:{message:e.message,params:Array.from(e.params.entries())}}}),new c.LoginContinuedInParentWindowError;throw e}).catch(e=>{throw e instanceof c.LoginContinuedInParentWindowError&&window.close(),e})}dispose(){this[Symbol.dispose]()}}t.BrowserOAuthClient=f,i=Symbol.dispose},50605:function(e,t,r){"use strict";var i,a,o=this&&this.__classPrivateFieldSet||function(e,t,r,i,a){if("m"===i)throw TypeError("Private method is not writable");if("a"===i&&!a)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(e,r):a?a.value=r:t.set(e,r),r},n=this&&this.__classPrivateFieldGet||function(e,t,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.BrowserOAuthDatabase=void 0;let s=r(26784),c=r(60259);function l(e){if(!(e instanceof s.WebcryptoKey)||!e.kid)throw Error("Invalid key object");return{keyId:e.kid,keyPair:e.cryptoKeyPair}}async function d(e){return s.WebcryptoKey.fromKeypair(e.keyPair,e.keyId)}let u=["state","session","didCache","dpopNonceCache","handleCache","authorizationServerMetadataCache","protectedResourceMetadataCache"];class h{constructor(e){i.set(this,void 0),a.set(this,void 0),o(this,i,c.DB.open(e?.name??"@atproto-oauth-client",[e=>{for(let t of u)e.createObjectStore(t,{autoIncrement:!0}).createIndex("expiresAt","expiresAt",{unique:!1})}],{durability:e?.durability??"strict"}),"f"),o(this,a,setInterval(()=>{this.cleanup()},e?.cleanupInterval??3e4),"f")}async run(e,t,r){let a=await n(this,i,"f");return await a.transaction([e],t,t=>r(t.objectStore(e)))}createStore(e,{encode:t,decode:r,expiresAt:i}){return{get:async t=>{let i=await this.run(e,"readonly",e=>e.get(t));if(void 0!==i){if(null!=i.expiresAt&&new Date(i.expiresAt)<new Date){await this.run(e,"readwrite",e=>e.delete(t));return}return r(i.value)}},set:async(r,a)=>{let o={value:await t(a),expiresAt:i(a)?.toISOString()};await this.run(e,"readwrite",e=>e.put(o,r))},del:async t=>{await this.run(e,"readwrite",e=>e.delete(t))}}}getSessionStore(){return this.createStore("session",{expiresAt:({tokenSet:e})=>e.refresh_token||null==e.expires_at?null:new Date(e.expires_at),encode:({dpopKey:e,...t})=>({...t,dpopKey:l(e)}),decode:async({dpopKey:e,...t})=>({...t,dpopKey:await d(e)})})}getStateStore(){return this.createStore("state",{expiresAt:e=>new Date(Date.now()+6e5),encode:({dpopKey:e,...t})=>({...t,dpopKey:l(e)}),decode:async({dpopKey:e,...t})=>({...t,dpopKey:await d(e)})})}getDpopNonceCache(){return this.createStore("dpopNonceCache",{expiresAt:e=>new Date(Date.now()+6e5),encode:e=>e,decode:e=>e})}getDidCache(){return this.createStore("didCache",{expiresAt:e=>new Date(Date.now()+6e4),encode:e=>e,decode:e=>e})}getHandleCache(){return this.createStore("handleCache",{expiresAt:e=>new Date(Date.now()+6e4),encode:e=>e,decode:e=>e})}getAuthorizationServerMetadataCache(){return this.createStore("authorizationServerMetadataCache",{expiresAt:e=>new Date(Date.now()+6e4),encode:e=>e,decode:e=>e})}getProtectedResourceMetadataCache(){return this.createStore("protectedResourceMetadataCache",{expiresAt:e=>new Date(Date.now()+6e4),encode:e=>e,decode:e=>e})}async cleanup(){let e=await n(this,i,"f");for(let t of u)await e.transaction([t],"readwrite",e=>e.objectStore(t).index("expiresAt").deleteAll(IDBKeyRange.upperBound(Date.now())))}async [(i=new WeakMap,a=new WeakMap,Symbol.asyncDispose)](){clearInterval(n(this,a,"f")),o(this,a,void 0,"f");let e=n(this,i,"f");o(this,i,Promise.reject(Error("Database has been disposed")),"f"),n(this,i,"f").catch(()=>null);let t=await e.catch(()=>null);t&&await (t[Symbol.asyncDispose]||t[Symbol.dispose]).call(t)}}t.BrowserOAuthDatabase=h},33681:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BrowserRuntimeImplementation=void 0;let i=r(26784),a=navigator.locks?.request?(e,t)=>navigator.locks.request(e,{mode:"exclusive"},async()=>t()):void 0;class o{constructor(){if(Object.defineProperty(this,"requestLock",{enumerable:!0,configurable:!0,writable:!0,value:a}),"object"!=typeof crypto||!crypto?.subtle)throw Error("Crypto with CryptoSubtle is required. If running in a browser, make sure the current page is loaded over HTTPS.");this.requestLock||console.warn("Locks API not available. You should consider using a more recent browser.")}async createKey(e){return i.WebcryptoKey.generate(e)}getRandomValues(e){return crypto.getRandomValues(new Uint8Array(e))}async digest(e,{name:t}){switch(t){case"sha256":case"sha384":case"sha512":return new Uint8Array(await crypto.subtle.digest(`SHA-${t.slice(3)}`,e));default:throw Error(`Unsupported digest algorithm: ${t}`)}}}t.BrowserRuntimeImplementation=o},69416:function(){"use strict";Symbol.dispose??(Symbol.dispose=Symbol("@@dispose")),Symbol.asyncDispose??(Symbol.asyncDispose=Symbol("@@asyncDispose"))},4062:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoginContinuedInParentWindowError=void 0;class r extends Error{constructor(){super("Login complete, please close the popup window."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:"LOGIN_CONTINUED_IN_PARENT_WINDOW"})}}t.LoginContinuedInParentWindowError=r},16297:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.buildLoopbackClientId=void 0,r(69416),a(r(26784),t),a(r(32495),t),a(r(16948),t),a(r(4062),t);var o=r(55766);Object.defineProperty(t,"buildLoopbackClientId",{enumerable:!0,get:function(){return o.buildLoopbackClientId}})},12414:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBIndex=void 0;let i=r(79761);class a{constructor(e){Object.defineProperty(this,"idbIndex",{enumerable:!0,configurable:!0,writable:!0,value:e})}count(e){return(0,i.promisify)(this.idbIndex.count(e))}get(e){return(0,i.promisify)(this.idbIndex.get(e))}getKey(e){return(0,i.promisify)(this.idbIndex.getKey(e))}getAll(e,t){return(0,i.promisify)(this.idbIndex.getAll(e,t))}getAllKeys(e,t){return(0,i.promisify)(this.idbIndex.getAllKeys(e,t))}deleteAll(e){return new Promise((t,r)=>{let i=this.idbIndex.openCursor(e);i.onsuccess=function(e){let r=e.target.result;r?(r.delete(),r.continue()):t()},i.onerror=function(e){r(e.target?.error||Error("Unexpected error"))}})}}t.DBIndex=a},31292:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBObjectStore=void 0;let i=r(12414),a=r(79761);class o{constructor(e){Object.defineProperty(this,"idbObjStore",{enumerable:!0,configurable:!0,writable:!0,value:e})}get name(){return this.idbObjStore.name}index(e){return new i.DBIndex(this.idbObjStore.index(e))}get(e){return(0,a.promisify)(this.idbObjStore.get(e))}getKey(e){return(0,a.promisify)(this.idbObjStore.getKey(e))}getAll(e,t){return(0,a.promisify)(this.idbObjStore.getAll(e,t))}getAllKeys(e,t){return(0,a.promisify)(this.idbObjStore.getAllKeys(e,t))}add(e,t){return(0,a.promisify)(this.idbObjStore.add(e,t))}put(e,t){return(0,a.promisify)(this.idbObjStore.put(e,t))}delete(e){return(0,a.promisify)(this.idbObjStore.delete(e))}clear(){return(0,a.promisify)(this.idbObjStore.clear())}}t.DBObjectStore=o},62703:function(e,t,r){"use strict";var i,a=this&&this.__classPrivateFieldSet||function(e,t,r,i,a){if("m"===i)throw TypeError("Private method is not writable");if("a"===i&&!a)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(e,r):a?a.value=r:t.set(e,r),r},o=this&&this.__classPrivateFieldGet||function(e,t,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.DBTransaction=void 0;let n=r(31292);class s{constructor(e){i.set(this,void 0),a(this,i,e,"f");let t=()=>{o()},r=()=>{o()},o=()=>{a(this,i,null,"f"),e.removeEventListener("abort",t),e.removeEventListener("complete",r)};e.addEventListener("abort",t),e.addEventListener("complete",r)}get tx(){if(!o(this,i,"f"))throw Error("Transaction already ended");return o(this,i,"f")}async abort(){let{tx:e}=this;a(this,i,null,"f"),e.abort()}async commit(){let{tx:e}=this;a(this,i,null,"f"),e.commit?.()}objectStore(e){let t=this.tx.objectStore(e);return new n.DBObjectStore(t)}[(i=new WeakMap,Symbol.dispose)](){o(this,i,"f")&&this.commit()}}t.DBTransaction=s},28810:function(e,t,r){"use strict";var i,a=this&&this.__classPrivateFieldSet||function(e,t,r,i,a){if("m"===i)throw TypeError("Private method is not writable");if("a"===i&&!a)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(e,r):a?a.value=r:t.set(e,r),r},o=this&&this.__classPrivateFieldGet||function(e,t,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.DB=void 0;let n=r(62703);class s{static async open(e,t,r){return new s(await new Promise((r,i)=>{let a=indexedDB.open(e,t.length);a.onerror=()=>i(a.error),a.onsuccess=()=>r(a.result),a.onupgradeneeded=({oldVersion:e,newVersion:r})=>{let o=a.result;try{for(let i=e;i<(r??t.length);++i){let e=t[i];if(e)e(o);else throw Error(`Missing migration for version ${i}`)}}catch(e){o.close(),i(e)}}}),r)}constructor(e,t){Object.defineProperty(this,"txOptions",{enumerable:!0,configurable:!0,writable:!0,value:t}),i.set(this,void 0),a(this,i,e,"f");let r=()=>{a(this,i,null,"f"),e.removeEventListener("versionchange",r),e.removeEventListener("close",r),e.close()};e.addEventListener("versionchange",r),e.addEventListener("close",r)}get db(){if(!o(this,i,"f"))throw Error("Database closed");return o(this,i,"f")}get name(){return this.db.name}get objectStoreNames(){return this.db.objectStoreNames}get version(){return this.db.version}async transaction(e,t,r){return new Promise(async(i,a)=>{try{let o=this.db.transaction(e,t,this.txOptions),s={done:!1};o.oncomplete=()=>{s.done?i(s.value):a(Error("Transaction completed without result"))},o.onerror=()=>a(o.error),o.onabort=()=>a(o.error||Error("Transaction aborted"));try{let e=await r(new n.DBTransaction(o));s={done:!0,value:e},o.commit()}catch(e){throw o.abort(),e}}catch(e){a(e)}})}close(){let{db:e}=this;a(this,i,null,"f"),e.close()}[(i=new WeakMap,Symbol.dispose)](){if(o(this,i,"f"))return this.close()}}t.DB=s},60259:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),r(69416),a(r(28810),t),a(r(12414),t),a(r(31292),t),a(r(62703),t)},79761:function(e,t){"use strict";function r(e,t,r){let i=()=>{e.removeEventListener("success",a),e.removeEventListener("error",o)},a=()=>{t(e.result),i()},o=()=>{r(e.error||Error("Unknown error")),i()};e.addEventListener("success",a),e.addEventListener("error",o)}Object.defineProperty(t,"__esModule",{value:!0}),t.handleRequest=r,t.promisify=function(e){return new Promise((t,i)=>{r(e,t,i)})}},55766:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildLoopbackClientId=function(e,t="127.0.0.1"){if(!(0,i.isLoopbackHost)(e.hostname))throw TypeError(`Expected a loopback host, got ${e.hostname}`);let r=`http://${"localhost"===e.hostname?t:e.hostname}${e.port&&!e.port.startsWith(":")?`:${e.port}`:e.port}${e.pathname}`;return`http://localhost${"/"===e.pathname?"":e.pathname}?redirect_uri=${encodeURIComponent(r)}`};let i=r(23377)},86238:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.atprotoTokenResponseSchema=t.atprotoScopeSchema=t.isAtprotoScope=void 0;let i=r(14747),a=r(24146),o=r(23377),n=r(6815);t.isAtprotoScope=e=>(0,n.includesSpaceSeparatedValue)(e,"atproto"),t.atprotoScopeSchema=i.z.string().refine(t.isAtprotoScope,'The "atproto" scope is required'),t.atprotoTokenResponseSchema=o.oauthTokenResponseSchema.extend({token_type:i.z.literal("DPoP"),sub:a.atprotoDidSchema,scope:t.atprotoScopeSchema,id_token:i.z.never().optional()})},82091:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FALLBACK_ALG=void 0,t.FALLBACK_ALG="ES256"},63871:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TokenInvalidError=void 0;class r extends Error{constructor(e,t=`The session for "${e}" is invalid`,r){super(t,r),Object.defineProperty(this,"sub",{enumerable:!0,configurable:!0,writable:!0,value:e})}}t.TokenInvalidError=r},15054:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TokenRefreshError=void 0;class r extends Error{constructor(e,t,r){super(t,r),Object.defineProperty(this,"sub",{enumerable:!0,configurable:!0,writable:!0,value:e})}}t.TokenRefreshError=r},36861:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TokenRevokedError=void 0;class r extends Error{constructor(e,t=`The session for "${e}" was successfully revoked`,r){super(t,r),Object.defineProperty(this,"sub",{enumerable:!0,configurable:!0,writable:!0,value:e})}}t.TokenRevokedError=r},85121:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dpopFetchWrapper=function({key:e,iss:t,supportedAlgs:r,nonces:i,sha256:d=void 0!==o?l:void 0,isAuthServer:u,fetch:h=globalThis.fetch}){if(!d)throw TypeError("crypto.subtle is not available in this environment. Please provide a sha256 function.");let p=function(e,t){if(t){let r=t.find(t=>e.algorithms.includes(t));if(r)return r}else{let[t]=e.algorithms;if(t)return t}throw Error("Key does not match any alg supported by the server")}(e,r);return async function(r,o){let l;if(!e.algorithms.includes(p))throw TypeError(`Key does not support the algorithm ${p}`);let f=null==o&&r instanceof Request?r:new Request(r,o),y=f.headers.get("Authorization"),m=y?.startsWith("DPoP ")?await d(y.slice(5)):void 0,{method:w,url:g}=f,{origin:b}=new URL(g);try{l=await i.get(b)}catch{}let v=await s(e,p,t,w,g,l,m);f.headers.set("DPoP",v);let _=await h.call(this,f),S=_.headers.get("DPoP-Nonce");if(!S||S===l)return _;try{await i.set(b,S)}catch{}if(!await c(_,u)||r===f||n&&o?.body instanceof n)return _;await (0,a.cancelBody)(_,"log");let E=await s(e,p,t,w,g,S,m),A=new Request(r,o);return A.headers.set("DPoP",E),h.call(this,A)}};let i=r(31080),a=r(10162),o=globalThis.crypto?.subtle,n=globalThis.ReadableStream;async function s(e,t,r,i,a,o,n){if(!e.bareJwk)throw Error("Only asymmetric keys can be used as DPoP proofs");let s=Math.floor(Date.now()/1e3);return e.createJwt({alg:t,typ:"dpop+jwt",jwk:e.bareJwk},{iss:r,iat:s,jti:Math.random().toString(36).slice(2),htm:i,htu:a,nonce:o,ath:n})}async function c(e,t){if((void 0===t||!1===t)&&401===e.status){let t=e.headers.get("WWW-Authenticate");if(t?.startsWith("DPoP"))return t.includes('error="use_dpop_nonce"')}if((void 0===t||!0===t)&&400===e.status)try{let t=await (0,a.peekJson)(e,10240);return"object"==typeof t&&t?.error==="use_dpop_nonce"}catch{}return!1}async function l(e){if(null==o)throw Error("crypto.subtle is not available in this environment. Please provide a sha256 function.");let t=new TextEncoder().encode(e),r=new Uint8Array(await o.digest("SHA-256",t));return i.base64url.baseEncode(r)}},32495:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.FetchResponseError=t.FetchRequestError=t.FetchError=void 0,a(r(75561),t);var o=r(10162);Object.defineProperty(t,"FetchError",{enumerable:!0,get:function(){return o.FetchError}}),Object.defineProperty(t,"FetchRequestError",{enumerable:!0,get:function(){return o.FetchRequestError}}),Object.defineProperty(t,"FetchResponseError",{enumerable:!0,get:function(){return o.FetchResponseError}}),a(r(77015),t),a(r(24146),t),a(r(23377),t),a(r(76797),t),a(r(96185),t),a(r(23903),t),a(r(22744),t),a(r(30966),t),a(r(16189),t),a(r(97751),t),a(r(4605),t),a(r(14222),t),a(r(68576),t),a(r(9460),t),a(r(45485),t),a(r(82972),t),a(r(63871),t),a(r(15054),t),a(r(36861),t)},34129:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.requestLocalLock=void 0;let r=new Map;t.requestLocalLock=(e,t)=>new Promise(t=>{let i=(r.get(e)??Promise.resolve()).then(()=>new Promise(a=>{t(()=>{r.get(e)===i&&r.delete(e),a()})}));r.set(e,i)}).then(async e=>{try{return await t()}finally{e()}})},76797:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthAuthorizationServerMetadataResolver=void 0;let i=r(23377),a=r(10162),o=r(96228),n=r(6815);class s extends o.CachedGetter{constructor(e,t,r){super(async(e,t)=>this.fetchMetadata(e,t),e),Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"allowHttpIssuer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fetch=(0,a.bindFetch)(t),this.allowHttpIssuer=r?.allowHttpIssuer===!0}async get(e,t){let r=i.oauthIssuerIdentifierSchema.parse(e);if(!this.allowHttpIssuer&&r.startsWith("http:"))throw TypeError("Unsecure issuer URL protocol only allowed in development and test environments");return super.get(r,t)}async fetchMetadata(e,t){let r=new URL("/.well-known/oauth-authorization-server",e),o=new Request(r,{headers:{accept:"application/json"},cache:t?.noCache?"no-cache":void 0,signal:t?.signal,redirect:"manual"}),s=await this.fetch(o);if(200!==s.status)throw await (0,a.cancelBody)(s,"log"),await a.FetchResponseError.from(s,`Unexpected status code ${s.status} for "${r}"`,void 0,{cause:o});if("application/json"!==(0,n.contentMime)(s.headers))throw await (0,a.cancelBody)(s,"log"),await a.FetchResponseError.from(s,`Unexpected content type for "${r}"`,void 0,{cause:o});let c=i.oauthAuthorizationServerMetadataValidator.parse(await s.json());if(c.issuer!==e)throw TypeError(`Invalid issuer ${c.issuer}`);if(!0!==c.client_id_metadata_document_supported)throw TypeError(`Authorization server "${e}" does not support client_id_metadata_document`);return c}}t.OAuthAuthorizationServerMetadataResolver=s},96185:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthCallbackError=void 0;class r extends Error{static from(e,t,i){return e instanceof r?e:new r(t,e instanceof Error?e.message:void 0,i,e)}constructor(e,t=e.get("error_description")||"OAuth callback error",r,i){super(t,{cause:i}),Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:r})}}t.OAuthCallbackError=r},23903:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthClient=void 0;let i=r(19538),a=r(23377),o=r(75561),n=r(77015),s=r(17196),c=r(69489),l=r(82091),d=r(36861),u=r(76797),h=r(96185),p=r(22744),f=r(41181),y=r(4605),m=r(14222),w=r(14546),g=r(9460),b=r(6815),v=r(97567);class _ extends b.CustomEventTarget{static async fetchMetadata({clientId:e,fetch:t=globalThis.fetch,signal:r}){r?.throwIfAborted();let i=new Request(e,{redirect:"error",signal:r}),o=await t(i);if(200!==o.status)throw o.body?.cancel?.(),TypeError(`Failed to fetch client metadata: ${o.status}`);let n=o.headers.get("content-type")?.split(";")[0].trim();if("application/json"!==n)throw o.body?.cancel?.(),TypeError(`Invalid client metadata content type: ${n}`);let s=await o.json();return r?.throwIfAborted(),a.oauthClientMetadataSchema.parse(s)}constructor({fetch:e=globalThis.fetch,allowHttp:t=!1,stateStore:r,sessionStore:a,didCache:l,dpopNonceCache:d=new c.SimpleStoreMemory({ttl:6e4,max:100}),handleCache:h,authorizationServerMetadataCache:m=new c.SimpleStoreMemory({ttl:6e4,max:100}),protectedResourceMetadataCache:b=new c.SimpleStoreMemory({ttl:6e4,max:100}),responseMode:_,clientMetadata:S,handleResolver:E,plcDirectoryUrl:A,runtimeImplementation:k,keyset:P}){for(let c of(super(),Object.defineProperty(this,"clientMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"responseMode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyset",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oauthResolver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serverFactory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sessionGetter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stateStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyset=P?P instanceof i.Keyset?P:new i.Keyset(P):void 0,this.clientMetadata=(0,v.validateClientMetadata)(S,this.keyset),this.responseMode=_,this.runtime=new w.Runtime(k),this.fetch=e,this.oauthResolver=new f.OAuthResolver(new s.IdentityResolver(new o.DidResolverCached(new o.DidResolverCommon({fetch:e,plcDirectoryUrl:A,allowHttp:t}),l),new n.CachedHandleResolver(n.AppViewHandleResolver.from(E,{fetch:e}),h)),new p.OAuthProtectedResourceMetadataResolver(b,e,{allowHttpResource:t}),new u.OAuthAuthorizationServerMetadataResolver(m,e,{allowHttpIssuer:t})),this.serverFactory=new y.OAuthServerFactory(this.clientMetadata,this.runtime,this.oauthResolver,this.fetch,this.keyset,d),this.sessionGetter=new g.SessionGetter(a,this.serverFactory,this.runtime),this.stateStore=r,["deleted","updated"]))this.sessionGetter.addEventListener(c,e=>{this.dispatchCustomEvent(c,e.detail)||e.preventDefault()})}get identityResolver(){return this.oauthResolver.identityResolver}get didResolver(){return this.identityResolver.didResolver}get handleResolver(){return this.identityResolver.handleResolver}get jwks(){return this.keyset?.publicJwks??{keys:[]}}async authorize(e,{signal:t,...r}={}){let i=r?.redirect_uri??this.clientMetadata.redirect_uris[0];if(!this.clientMetadata.redirect_uris.includes(i))throw TypeError("Invalid redirect_uri");let{identity:a,metadata:o}=await this.oauthResolver.resolve(e,{signal:t}),n=await this.runtime.generatePKCE(),s=await this.runtime.generateKey(o.dpop_signing_alg_values_supported||[l.FALLBACK_ALG]),c=await this.runtime.generateNonce();await this.stateStore.set(c,{iss:o.issuer,dpopKey:s,verifier:n.verifier,appState:r?.state});let d={...r,client_id:this.clientMetadata.client_id,redirect_uri:i,code_challenge:n.challenge,code_challenge_method:n.method,state:c,login_hint:a?e:void 0,response_mode:this.responseMode,response_type:"code",scope:r?.scope??this.clientMetadata.scope},u=new URL(o.authorization_endpoint);if("https:"!==u.protocol&&"http:"!==u.protocol)throw TypeError(`Invalid authorization endpoint protocol: ${u.protocol}`);if(o.pushed_authorization_request_endpoint){let e=await this.serverFactory.fromMetadata(o,s),t=await e.request("pushed_authorization_request",d);return u.searchParams.set("client_id",this.clientMetadata.client_id),u.searchParams.set("request_uri",t.request_uri),u}if(o.require_pushed_authorization_requests)throw Error("Server requires pushed authorization requests (PAR) but no PAR endpoint is available");for(let[e,t]of Object.entries(d))t&&u.searchParams.set(e,String(t));if(u.pathname.length+u.search.length<2048)return u;if(!o.pushed_authorization_request_endpoint)throw Error("Login URL too long");throw Error("Server does not support pushed authorization requests (PAR)")}async abortRequest(e){if(!e.searchParams.get("request_uri"))return}async callback(e){if(null!=e.get("response"))throw new h.OAuthCallbackError(e,"JARM not supported");let t=e.get("iss"),r=e.get("state"),i=e.get("error"),a=e.get("code");if(!r)throw new h.OAuthCallbackError(e,'Missing "state" parameter');let o=await this.stateStore.get(r);if(o)await this.stateStore.del(r);else throw new h.OAuthCallbackError(e,`Unknown authorization session "${r}"`);try{if(null!=i)throw new h.OAuthCallbackError(e,void 0,o.appState);if(!a)throw new h.OAuthCallbackError(e,'Missing "code" query param',o.appState);let r=await this.serverFactory.fromIssuer(o.iss,o.dpopKey);if(null!=t){if(!r.issuer)throw new h.OAuthCallbackError(e,"Issuer not found in metadata",o.appState);if(r.issuer!==t)throw new h.OAuthCallbackError(e,"Issuer mismatch",o.appState)}else if(r.serverMetadata.authorization_response_iss_parameter_supported)throw new h.OAuthCallbackError(e,"iss missing from the response",o.appState);let n=await r.exchangeCode(a,o.verifier);try{return await this.sessionGetter.setStored(n.sub,{dpopKey:o.dpopKey,tokenSet:n}),{session:this.createSession(r,n.sub),state:o.appState??null}}catch(e){throw await r.revoke(n.refresh_token||n.access_token),e}}catch(t){throw h.OAuthCallbackError.from(t,e,o.appState)}}async restore(e,t="auto"){(0,o.assertAtprotoDid)(e);let{dpopKey:r,tokenSet:i}=await this.sessionGetter.get(e,{noCache:!0===t,allowStale:!1===t}),a=await this.serverFactory.fromIssuer(i.iss,r,{noCache:!0===t,allowStale:!1===t});return this.createSession(a,e)}async revoke(e){(0,o.assertAtprotoDid)(e);let{dpopKey:t,tokenSet:r}=await this.sessionGetter.get(e,{allowStale:!0});try{let e=await this.serverFactory.fromIssuer(r.iss,t);await e.revoke(r.access_token)}finally{await this.sessionGetter.delStored(e,new d.TokenRevokedError(e))}}createSession(e,t){return new m.OAuthSession(e,t,this.sessionGetter,this.fetch)}}t.OAuthClient=_},22744:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthProtectedResourceMetadataResolver=void 0;let i=r(23377),a=r(10162),o=r(96228),n=r(6815);class s extends o.CachedGetter{constructor(e,t=globalThis.fetch,r){super(async(e,t)=>this.fetchMetadata(e,t),e),Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"allowHttpResource",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fetch=(0,a.bindFetch)(t),this.allowHttpResource=r?.allowHttpResource===!0}async get(e,t){let{protocol:r,origin:i}=new URL(e);if("https:"!==r&&"http:"!==r)throw TypeError(`Invalid protected resource metadata URL protocol: ${r}`);if("http:"===r&&!this.allowHttpResource)throw TypeError(`Unsecure resource metadata URL (${r}) only allowed in development and test environments`);return super.get(i,t)}async fetchMetadata(e,t){let r=new URL("/.well-known/oauth-protected-resource",e),o=new Request(r,{signal:t?.signal,headers:{accept:"application/json"},cache:t?.noCache?"no-cache":void 0,redirect:"manual"}),s=await this.fetch(o);if(200!==s.status)throw await (0,a.cancelBody)(s,"log"),await a.FetchResponseError.from(s,`Unexpected status code ${s.status} for "${r}"`,void 0,{cause:o});if("application/json"!==(0,n.contentMime)(s.headers))throw await (0,a.cancelBody)(s,"log"),await a.FetchResponseError.from(s,`Unexpected content type for "${r}"`,void 0,{cause:o});let c=i.oauthProtectedResourceMetadataSchema.parse(await s.json());if(c.resource!==e)throw TypeError(`Invalid issuer ${c.resource}`);return c}}t.OAuthProtectedResourceMetadataResolver=s},30966:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthResolverError=void 0;let i=r(14747);class a extends Error{constructor(e,t){super(e,t)}static from(e,t){if(e instanceof a)return e;let r=e instanceof i.ZodError?`${e.errors[0].path} ${e.errors[0].message}`:null;return new a((t??"Unable to resolve identity")+(r?` (${r})`:""),{cause:e})}}t.OAuthResolverError=a},41181:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthResolver=void 0;let i=r(23377),a=r(30966);class o{constructor(e,t,r){Object.defineProperty(this,"identityResolver",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"protectedResourceMetadataResolver",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"authorizationServerMetadataResolver",{enumerable:!0,configurable:!0,writable:!0,value:r})}async resolve(e,t){return/^https?:\/\//.test(e)?this.resolveFromService(e,t):this.resolveFromIdentity(e,t)}async resolveFromService(e,t){try{return{metadata:await this.getResourceServerMetadata(e,t)}}catch(r){if(!t?.signal?.aborted&&r instanceof a.OAuthResolverError)try{let r=i.oauthIssuerIdentifierSchema.safeParse(e);if(r.success)return{metadata:await this.getAuthorizationServerMetadata(r.data,t)}}catch{}throw r}}async resolveFromIdentity(e,t){let r=await this.resolveIdentity(e,t);t?.signal?.throwIfAborted();let i=await this.getResourceServerMetadata(r.pds,t);return{identity:r,metadata:i}}async resolveIdentity(e,t){try{return await this.identityResolver.resolve(e,t)}catch(t){throw a.OAuthResolverError.from(t,`Failed to resolve identity: ${e}`)}}async getAuthorizationServerMetadata(e,t){try{return await this.authorizationServerMetadataResolver.get(e,t)}catch(t){throw a.OAuthResolverError.from(t,`Failed to resolve OAuth server metadata for issuer: ${e}`)}}async getResourceServerMetadata(e,t){try{let r=await this.protectedResourceMetadataResolver.get(e,t);if(r.authorization_servers?.length!==1)throw new a.OAuthResolverError(r.authorization_servers?.length?`Unable to determine authorization server for PDS: ${e}`:`No authorization servers found for PDS: ${e}`);let i=r.authorization_servers[0];t?.signal?.throwIfAborted();let o=await this.getAuthorizationServerMetadata(i,t);if(o.protected_resources&&!o.protected_resources.includes(r.resource))throw new a.OAuthResolverError(`PDS "${e}" not protected by issuer "${i}"`);return o}catch(t){throw a.OAuthResolverError.from(t,`Failed to resolve OAuth server metadata for resource: ${e}`)}}}t.OAuthResolver=o},16189:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthResponseError=void 0;let i=r(6815);class a extends Error{constructor(e,t){let r="object"==typeof t?t:void 0,a=(0,i.ifString)(r?.error),o=(0,i.ifString)(r?.error_description);super(`OAuth ${a?`"${a}"`:"unknown"} error${o?`: ${o}`:""}`),Object.defineProperty(this,"response",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"payload",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"errorDescription",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.error=a,this.errorDescription=o}get status(){return this.response.status}get headers(){return this.response.headers}}t.OAuthResponseError=a},97751:function(e,t,r){"use strict";var i,a=this&&this.__addDisposableResource||function(e,t,r){if(null!=t){var i,a;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(r){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");i=t[Symbol.asyncDispose]}if(void 0===i){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");i=t[Symbol.dispose],r&&(a=i)}if("function"!=typeof i)throw TypeError("Object not disposable.");a&&(i=function(){try{a.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:i,async:r})}else r&&e.stack.push({async:!0});return t},o=this&&this.__disposeResources||(i="function"==typeof SuppressedError?SuppressedError:function(e,t,r){var i=Error(r);return i.name="SuppressedError",i.error=e,i.suppressed=t,i},function(e){function t(t){e.error=e.hasError?new i(t,e.error,"An error was suppressed during disposal."):t,e.hasError=!0}var r,a=0;return function i(){for(;r=e.stack.pop();)try{if(!r.async&&1===a)return a=0,e.stack.push(r),Promise.resolve().then(i);if(r.dispose){var o=r.dispose.call(r.value);if(r.async)return a|=2,Promise.resolve(o).then(i,function(e){return t(e),i()})}else a|=1}catch(e){t(e)}if(1===a)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()});Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthServerAgent=void 0;let n=r(23377),s=r(10162),c=r(86238),l=r(82091),d=r(15054),u=r(85121),h=r(16189),p=r(6815);class f{constructor(e,t,r,i,a,o,n,c){Object.defineProperty(this,"dpopKey",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"serverMetadata",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"clientMetadata",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"dpopNonces",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"oauthResolver",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"keyset",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"dpopFetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.dpopFetch=(0,u.dpopFetchWrapper)({fetch:(0,s.bindFetch)(c),iss:r.client_id,key:e,supportedAlgs:t.dpop_signing_alg_values_supported,sha256:async e=>o.sha256(e),nonces:i,isAuthServer:!0})}get issuer(){return this.serverMetadata.issuer}async revoke(e){try{await this.request("revocation",{token:e})}catch{}}async exchangeCode(e,t){let r=Date.now(),i=await this.request("token",{grant_type:"authorization_code",redirect_uri:this.clientMetadata.redirect_uris[0],code:e,code_verifier:t});try{return{aud:await this.verifyIssuer(i.sub),sub:i.sub,iss:this.issuer,scope:i.scope,refresh_token:i.refresh_token,access_token:i.access_token,token_type:i.token_type,expires_at:"number"==typeof i.expires_in?new Date(r+1e3*i.expires_in).toISOString():void 0}}catch(e){throw await this.revoke(i.access_token),e}}async refresh(e){if(!e.refresh_token)throw new d.TokenRefreshError(e.sub,"No refresh token available");let t=await this.verifyIssuer(e.sub),r=Date.now(),i=await this.request("token",{grant_type:"refresh_token",refresh_token:e.refresh_token});return{aud:t,sub:e.sub,iss:this.issuer,scope:i.scope,refresh_token:i.refresh_token,access_token:i.access_token,token_type:i.token_type,expires_at:"number"==typeof i.expires_in?new Date(r+1e3*i.expires_in).toISOString():void 0}}async verifyIssuer(e){let t={stack:[],error:void 0,hasError:!1};try{let r=a(t,(0,p.timeoutSignal)(1e4),!1),i=await this.oauthResolver.resolveFromIdentity(e,{noCache:!0,allowStale:!1,signal:r});if(this.issuer!==i.metadata.issuer)throw TypeError("Issuer mismatch");return i.identity.pds.href}catch(e){t.error=e,t.hasError=!0}finally{o(t)}}async request(e,t){let r=this.serverMetadata[`${e}_endpoint`];if(!r)throw Error(`No ${e} endpoint available`);let i=await this.buildClientAuth(e),{response:a,json:o}=await this.dpopFetch(r,{method:"POST",headers:{...i.headers,"Content-Type":"application/json"},body:JSON.stringify({...t,...i.payload})}).then((0,s.fetchJsonProcessor)());if(a.ok)switch(e){case"token":return c.atprotoTokenResponseSchema.parse(o);case"pushed_authorization_request":return n.oauthParResponseSchema.parse(o);default:return o}else throw new h.OAuthResponseError(a,o)}async buildClientAuth(e){let t=this.serverMetadata.token_endpoint_auth_methods_supported,r=this.clientMetadata.token_endpoint_auth_method;if("private_key_jwt"===r||this.keyset&&!r&&t?.includes("private_key_jwt")){if(!this.keyset)throw Error("No keyset available");try{let e=this.serverMetadata.token_endpoint_auth_signing_alg_values_supported??l.FALLBACK_ALG,t=this.clientMetadata.jwks?.keys.map(({kid:e})=>e).filter(e=>"string"==typeof e);return{payload:{client_id:this.clientMetadata.client_id,client_assertion_type:n.CLIENT_ASSERTION_TYPE_JWT_BEARER,client_assertion:await this.keyset.createJwt({alg:e,kid:t},{iss:this.clientMetadata.client_id,sub:this.clientMetadata.client_id,aud:this.serverMetadata.issuer,jti:await this.runtime.generateNonce(),iat:Math.floor(Date.now()/1e3)})}}}catch(e){if("private_key_jwt"===r)throw e}}if("none"===r||!r&&(t?.includes("none")??!0))return{payload:{client_id:this.clientMetadata.client_id}};throw Error(`Unsupported ${e} authentication method`)}}t.OAuthServerAgent=f},4605:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthServerFactory=void 0;let i=r(97751);class a{constructor(e,t,r,i,a,o){Object.defineProperty(this,"clientMetadata",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"resolver",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"keyset",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"dpopNonceCache",{enumerable:!0,configurable:!0,writable:!0,value:o})}async fromIssuer(e,t,r){let i=await this.resolver.getAuthorizationServerMetadata(e,r);return this.fromMetadata(i,t)}async fromMetadata(e,t){return new i.OAuthServerAgent(t,e,this.clientMetadata,this.dpopNonceCache,this.resolver,this.runtime,this.keyset,this.fetch)}}t.OAuthServerFactory=a},14222:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuthSession=void 0;let i=r(10162),a=r(63871),o=r(36861),n=r(85121),s=globalThis.ReadableStream;class c{constructor(e,t,r,a=globalThis.fetch){Object.defineProperty(this,"server",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"sub",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"sessionGetter",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"dpopFetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.dpopFetch=(0,n.dpopFetchWrapper)({fetch:(0,i.bindFetch)(a),iss:e.clientMetadata.client_id,key:e.dpopKey,supportedAlgs:e.serverMetadata.dpop_signing_alg_values_supported,sha256:async t=>e.runtime.sha256(t),nonces:e.dpopNonces,isAuthServer:!1})}get did(){return this.sub}get serverMetadata(){return this.server.serverMetadata}async getTokenSet(e){let{tokenSet:t}=await this.sessionGetter.get(this.sub,{noCache:!0===e,allowStale:!1===e});return t}async getTokenInfo(e="auto"){let t=await this.getTokenSet(e),r=null==t.expires_at?void 0:new Date(t.expires_at);return{expiresAt:r,get expired(){return null==r?void 0:r.getTime()<Date.now()-5e3},scope:t.scope,iss:t.iss,aud:t.aud,sub:t.sub}}async signOut(){try{let e=await this.getTokenSet(!1);await this.server.revoke(e.access_token)}finally{await this.sessionGetter.delStored(this.sub,new o.TokenRevokedError(this.sub))}}async fetchHandler(e,t){let r;let i=await this.getTokenSet("auto"),o=new URL(e,i.aud),n=`${i.token_type} ${i.access_token}`,c=new Headers(t?.headers);c.set("Authorization",n);let d=await this.dpopFetch(o,{...t,headers:c});if(!l(d))return d;try{r=await this.getTokenSet(!0)}catch(e){return d}if(s&&t?.body instanceof s)return d;let u=`${r.token_type} ${r.access_token}`,h=new URL(e,r.aud);c.set("Authorization",u);let p=await this.dpopFetch(h,{...t,headers:c});return l(p)&&await this.sessionGetter.delStored(this.sub,new a.TokenInvalidError(this.sub)),p}}function l(e){if(401!==e.status)return!1;let t=e.headers.get("WWW-Authenticate");return null!=t&&(t.startsWith("Bearer ")||t.startsWith("DPoP "))&&t.includes('error="invalid_token"')}t.OAuthSession=c},68576:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},14546:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Runtime=void 0;let i=r(31080),a=r(34129);class o{constructor(e){Object.defineProperty(this,"implementation",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"hasImplementationLock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usingLock",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{requestLock:t}=e;this.hasImplementationLock=null!=t,this.usingLock=t?.bind(e)||a.requestLocalLock}async generateKey(e){let t=Array.from(e).sort(n);return this.implementation.createKey(t)}async sha256(e){let t=new TextEncoder().encode(e),r=await this.implementation.digest(t,{name:"sha256"});return i.base64url.baseEncode(r)}async generateNonce(e=16){let t=await this.implementation.getRandomValues(e);return i.base64url.baseEncode(t)}async generatePKCE(e){let t=await this.generateVerifier(e);return{verifier:t,challenge:await this.sha256(t),method:"S256"}}async calculateJwkThumbprint(e){let t=JSON.stringify(function(e){let t=t=>{let r=e[t];if("string"!=typeof r||!r)throw TypeError(`"${t}" Parameter missing or invalid`);return r};switch(e.kty){case"EC":return{crv:t("crv"),kty:t("kty"),x:t("x"),y:t("y")};case"OKP":return{crv:t("crv"),kty:t("kty"),x:t("x")};case"RSA":return{e:t("e"),kty:t("kty"),n:t("n")};case"oct":return{k:t("k"),kty:t("kty")};default:throw TypeError('"kty" (Key Type) Parameter missing or unsupported')}}(e));return this.sha256(t)}async generateVerifier(e=32){if(e<32||e>96)throw TypeError("Invalid code_verifier length");let t=await this.implementation.getRandomValues(e);return i.base64url.baseEncode(t)}}function n(e,t){if("ES256K"===e)return -1;if("ES256K"===t)return 1;for(let r of["ES","PS","RS"]){if(e.startsWith(r)){if(t.startsWith(r))return parseInt(e.slice(2,5))-parseInt(t.slice(2,5));return -1}if(t.startsWith(r))return 1}return 0}t.Runtime=o},9460:function(e,t,r){"use strict";var i,a=this&&this.__addDisposableResource||function(e,t,r){if(null!=t){var i,a;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(r){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");i=t[Symbol.asyncDispose]}if(void 0===i){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");i=t[Symbol.dispose],r&&(a=i)}if("function"!=typeof i)throw TypeError("Object not disposable.");a&&(i=function(){try{a.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:i,async:r})}else r&&e.stack.push({async:!0});return t},o=this&&this.__disposeResources||(i="function"==typeof SuppressedError?SuppressedError:function(e,t,r){var i=Error(r);return i.name="SuppressedError",i.error=e,i.suppressed=t,i},function(e){function t(t){e.error=e.hasError?new i(t,e.error,"An error was suppressed during disposal."):t,e.hasError=!0}var r,a=0;return function i(){for(;r=e.stack.pop();)try{if(!r.async&&1===a)return a=0,e.stack.push(r),Promise.resolve().then(i);if(r.dispose){var o=r.dispose.call(r.value);if(r.async)return a|=2,Promise.resolve(o).then(i,function(e){return t(e),i()})}else a|=1}catch(e){t(e)}if(1===a)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()});Object.defineProperty(t,"__esModule",{value:!0}),t.SessionGetter=void 0;let n=r(96228),s=r(63871),c=r(15054),l=r(36861),d=r(16189),u=r(6815);class h extends n.CachedGetter{constructor(e,t,r){super(async(e,i,a)=>{if(void 0===a){let t=new c.TokenRefreshError(e,"The session was deleted by another process");throw this.dispatchEvent("deleted",{sub:e,cause:t}),t}let{dpopKey:o,tokenSet:n}=a;if(e!==n.sub)throw new c.TokenRefreshError(e,"Stored session sub mismatch");if(!n.refresh_token)throw new c.TokenRefreshError(e,"No refresh token available");let s=await t.fromIssuer(n.iss,o);i?.signal?.throwIfAborted();try{let t=await s.refresh(n);if(e!==t.sub)throw new c.TokenRefreshError(e,"Token set sub mismatch");return{dpopKey:o,tokenSet:t}}catch(t){if(t instanceof d.OAuthResponseError&&400===t.status&&"invalid_grant"===t.error){if(!r.hasImplementationLock){await new Promise(e=>setTimeout(e,1e3));let r=await this.getStored(e);if(void 0===r)throw new c.TokenRefreshError(e,"The session was deleted by another process",{cause:t});if(r.tokenSet.access_token!==n.access_token||r.tokenSet.refresh_token!==n.refresh_token)return r}let i=t.errorDescription??"The session was revoked";throw new c.TokenRefreshError(e,i,{cause:t})}throw t}},e,{isStale:(e,{tokenSet:t})=>null!=t.expires_at&&new Date(t.expires_at).getTime()<Date.now()+1e4+3e4*Math.random(),onStoreError:async(e,r,{tokenSet:i,dpopKey:a})=>{let o=await t.fromIssuer(i.iss,a);throw await o.revoke(i.refresh_token??i.access_token),e},deleteOnError:async e=>e instanceof c.TokenRefreshError||e instanceof l.TokenRevokedError||e instanceof s.TokenInvalidError}),Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"eventTarget",{enumerable:!0,configurable:!0,writable:!0,value:new u.CustomEventTarget})}addEventListener(e,t,r){this.eventTarget.addEventListener(e,t,r)}removeEventListener(e,t,r){this.eventTarget.removeEventListener(e,t,r)}dispatchEvent(e,t){return this.eventTarget.dispatchCustomEvent(e,t)}async setStored(e,t){if(e!==t.tokenSet.sub)throw TypeError("Token set does not match the expected sub");await super.setStored(e,t),this.dispatchEvent("updated",{sub:e,...t})}async delStored(e,t){await super.delStored(e,t),this.dispatchEvent("deleted",{sub:e,cause:t})}async getSession(e,t){return this.get(e,{noCache:!0===t,allowStale:!1===t})}async get(e,t){let r=await this.runtime.usingLock(`@atproto-oauth-client-${e}`,async()=>{let r={stack:[],error:void 0,hasError:!1};try{let i=a(r,(0,u.timeoutSignal)(3e4,t),!1),o=a(r,(0,u.combineSignals)([t?.signal,i]),!1);return await super.get(e,{...t,signal:o.signal})}catch(e){r.error=e,r.hasError=!0}finally{o(r)}});if(e!==r.tokenSet.sub)throw Error("Token set does not match the expected sub");return r}}t.SessionGetter=h},45485:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},82972:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clientMetadataSchema=void 0;let i=r(14747),a=r(23377);t.clientMetadataSchema=a.oauthClientMetadataSchema.extend({client_id:i.z.union([a.oauthClientIdDiscoverableSchema,a.oauthClientIdLoopbackSchema])})},6815:function(e,t){"use strict";var r=this&&this.__classPrivateFieldSet||function(e,t,r,i,a){if("m"===i)throw TypeError("Private method is not writable");if("a"===i&&!a)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(e,r):a?a.value=r:t.set(e,r),r},i=this&&this.__classPrivateFieldGet||function(e,t,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.includesSpaceSeparatedValue=t.CustomEventTarget=t.CustomEvent=t.timeoutSignal=t.ifString=void 0,t.contentMime=function(e){return e.get("content-type")?.split(";")[0].trim()},t.combineSignals=function(e){let t=new AbortController,r=function(e){let r=Error("This operation was aborted",{cause:this.reason});t.abort(r)};for(let i of e)if(i){if(i.aborted)throw t.abort(),Error("One of the signals is already aborted",{cause:i.reason});i.addEventListener("abort",r,{signal:t.signal})}return t[Symbol.dispose]=()=>{let e=Error("AbortController was disposed");t.abort(e)},t},Symbol.dispose??(Symbol.dispose=Symbol("@@dispose")),t.ifString=e=>"string"==typeof e?e:void 0,t.timeoutSignal=(e,t)=>{if(!Number.isInteger(e)||e<0)throw TypeError("Expected a positive integer");t?.signal?.throwIfAborted();let r=new AbortController,{signal:i}=r;t?.signal?.addEventListener("abort",e=>r.abort(e),{once:!0,signal:i});let a=setTimeout(e=>r.abort(e),e,Error("Timeout"));return a?.unref?.(),i.addEventListener("abort",()=>clearTimeout(a),{once:!0,signal:i}),Object.defineProperty(i,Symbol.dispose,{value:()=>r.abort()}),i},t.CustomEvent=globalThis.CustomEvent??(()=>{var e;class t extends Event{constructor(t,i){if(!arguments.length)throw TypeError("type argument is required");super(t,i),e.set(this,void 0),r(this,e,i?.detail??null,"f")}get detail(){return i(this,e,"f")}}return e=new WeakMap,Object.defineProperties(t.prototype,{[Symbol.toStringTag]:{writable:!1,enumerable:!1,configurable:!0,value:"CustomEvent"},detail:{enumerable:!0}}),t})();class a{constructor(){Object.defineProperty(this,"eventTarget",{enumerable:!0,configurable:!0,writable:!0,value:new EventTarget})}addEventListener(e,t,r){this.eventTarget.addEventListener(e,t,r)}removeEventListener(e,t,r){this.eventTarget.removeEventListener(e,t,r)}dispatchCustomEvent(e,r,i){return this.eventTarget.dispatchEvent(new t.CustomEvent(e,{...i,detail:r}))}}t.CustomEventTarget=a,t.includesSpaceSeparatedValue=(e,t)=>{let r;if(0===t.length)throw TypeError("Value cannot be empty");if(t.includes(" "))throw TypeError("Value cannot contain spaces");let i=e.length,a=t.length;if(i<a)return!1;let o=e.indexOf(t);for(;-1!==o;){if(r=o+a,(0===o||" "===e[o-1])&&(r===i||" "===e[r]))return!0;o=e.indexOf(t,r+1)}return!1}},97567:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateClientMetadata=function(e,t){if(e.jwks){if(!t)throw TypeError("Keyset must not be provided when jwks is provided");for(let r of e.jwks.keys)if(r.kid){if(!t.has(r.kid))throw TypeError(`Key with kid "${r.kid}" not found in keyset`)}else throw TypeError('Key must have a "kid" property')}!e.jwks&&!e.jwks_uri&&t?.size&&(e={...e,jwks:t.toJSON()});let r=a.clientMetadataSchema.parse(e);r.client_id.startsWith("http:")?(0,i.assertOAuthLoopbackClientId)(r.client_id):(0,i.assertOAuthDiscoverableClientId)(r.client_id);let s=r.scope?.split(" ");if(!s?.includes("atproto"))throw TypeError('Client metadata must include the "atproto" scope');if(!r.response_types.includes("code"))throw TypeError('"response_types" must include "code"');if(!r.grant_types.includes("authorization_code"))throw TypeError('"grant_types" must include "authorization_code"');let c=r[o];switch(c){case void 0:throw TypeError(`${o} must be provided`);case"none":if(r[n])throw TypeError(`${n} must not be provided when ${o} is "${c}"`);break;case"private_key_jwt":if(!t?.size)throw TypeError(`A non-empty keyset must be provided when ${o} is "${c}"`);if(!r[n])throw TypeError(`${n} must be provided when ${o} is "${c}"`);break;default:throw TypeError(`Invalid "token_endpoint_auth_method" value: ${c}`)}return r};let i=r(23377),a=r(82972),o="token_endpoint_auth_method",n="token_endpoint_auth_signing_alg"},60970:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.atprotoLoopbackClientMetadata=function(e){let{scope:t="atproto",redirect_uris:r=["http://127.0.0.1/","http://[::1]/"]}=(0,i.parseOAuthLoopbackClientId)(e);return{client_id:e,scope:t,redirect_uris:r,response_types:["code"],grant_types:["authorization_code","refresh_token"],token_endpoint_auth_method:"none",application_type:"native",dpop_bound_access_tokens:!0}};let i=r(49460)},62761:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CLIENT_ASSERTION_TYPE_JWT_BEARER=void 0,t.CLIENT_ASSERTION_TYPE_JWT_BEARER="urn:ietf:params:oauth:client-assertion-type:jwt-bearer"},23377:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(62761),t),a(r(81130),t),a(r(64798),t),a(r(60970),t),a(r(62437),t),a(r(43509),t),a(r(72989),t),a(r(33001),t),a(r(17727),t),a(r(52250),t),a(r(1681),t),a(r(19169),t),a(r(13668),t),a(r(38792),t),a(r(48815),t),a(r(5943),t),a(r(75572),t),a(r(49460),t),a(r(44984),t),a(r(44991),t),a(r(18799),t),a(r(77230),t),a(r(94636),t),a(r(2332),t),a(r(18708),t),a(r(34862),t),a(r(94857),t),a(r(46318),t),a(r(81377),t),a(r(84587),t),a(r(89003),t),a(r(32663),t),a(r(21289),t),a(r(26028),t),a(r(63106),t),a(r(93805),t),a(r(61603),t),a(r(84728),t),a(r(94032),t),a(r(32274),t),a(r(91376),t),a(r(44903),t),a(r(16454),t),a(r(21153),t)},62437:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAccessTokenSchema=void 0;let i=r(14747);t.oauthAccessTokenSchema=i.z.string().min(1)},43509:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthenticationErrorResponseSchema=void 0;let i=r(14747);t.oauthAuthenticationErrorResponseSchema=i.z.enum(["invalid_request","unauthorized_client","access_denied","unsupported_response_type","invalid_scope","server_error","temporarily_unavailable"])},72989:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthorizationCodeGrantTokenRequestSchema=void 0;let i=r(14747),a=r(81377);t.oauthAuthorizationCodeGrantTokenRequestSchema=i.z.object({grant_type:i.z.literal("authorization_code"),code:i.z.string().min(1),redirect_uri:a.oauthRedirectUriSchema,code_verifier:i.z.string().min(43).max(128).regex(/^[a-zA-Z0-9-._~]+$/).optional()})},33001:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthorizationDetailsSchema=t.oauthAuthorizationDetailSchema=void 0;let i=r(14747),a=r(81130);t.oauthAuthorizationDetailSchema=i.z.object({type:i.z.string(),locations:i.z.array(a.dangerousUriSchema).optional(),actions:i.z.array(i.z.string()).optional(),datatypes:i.z.array(i.z.string()).optional(),identifier:i.z.string().optional(),privileges:i.z.array(i.z.string()).optional()}),t.oauthAuthorizationDetailsSchema=i.z.array(t.oauthAuthorizationDetailSchema)},17727:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthorizationRequestJarSchema=void 0;let i=r(14747),a=r(19538);t.oauthAuthorizationRequestJarSchema=i.z.object({request:i.z.union([a.signedJwtSchema,a.unsignedJwtSchema])})},52250:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthorizationRequestParSchema=void 0;let i=r(14747),a=r(17727),o=r(1681);t.oauthAuthorizationRequestParSchema=i.z.union([o.oauthAuthorizationRequestParametersSchema,a.oauthAuthorizationRequestJarSchema])},1681:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthorizationRequestParametersSchema=void 0;let i=r(14747),a=r(19538),o=r(33001),n=r(44984),s=r(17559),c=r(81377),l=r(21289),d=r(26028),u=r(63106),h=r(91376),p=r(44903),f=r(16454);t.oauthAuthorizationRequestParametersSchema=i.z.object({client_id:n.oauthClientIdSchema,state:i.z.string().optional(),redirect_uri:c.oauthRedirectUriSchema.optional(),scope:u.oauthScopeSchema.optional(),response_type:d.oauthResponseTypeSchema,code_challenge:i.z.string().optional(),code_challenge_method:s.oauthCodeChallengeMethodSchema.default("S256").optional(),dpop_jkt:i.z.string().optional(),response_mode:l.oauthResponseModeSchema.optional(),nonce:i.z.string().optional(),max_age:i.z.number().int().min(0).optional(),claims:i.z.record(f.oidcEntityTypeSchema,i.z.record(h.oidcClaimsParameterSchema,i.z.union([i.z.literal(null),p.oidcClaimsPropertiesSchema]))).optional(),login_hint:i.z.string().min(1).optional(),ui_locales:i.z.string().regex(/^[a-z]{2,3}(-[A-Z]{2})?( [a-z]{2,3}(-[A-Z]{2})?)*$/).optional(),id_token_hint:a.signedJwtSchema.optional(),display:i.z.enum(["page","popup","touch","wap"]).optional(),prompt:i.z.enum(["none","login","consent","select_account"]).optional(),authorization_details:o.oauthAuthorizationDetailsSchema.optional()})},19169:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthorizationRequestQuerySchema=void 0;let i=r(14747),a=r(17727),o=r(1681),n=r(13668);t.oauthAuthorizationRequestQuerySchema=i.z.union([o.oauthAuthorizationRequestParametersSchema,a.oauthAuthorizationRequestJarSchema,n.oauthAuthorizationRequestUriSchema])},13668:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthorizationRequestUriSchema=void 0;let i=r(14747),a=r(32663);t.oauthAuthorizationRequestUriSchema=i.z.object({request_uri:a.oauthRequestUriSchema})},38792:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthAuthorizationServerMetadataValidator=t.oauthAuthorizationServerMetadataSchema=void 0;let i=r(14747),a=r(17559),o=r(18708),n=r(81130);t.oauthAuthorizationServerMetadataSchema=i.z.object({issuer:o.oauthIssuerIdentifierSchema,claims_supported:i.z.array(i.z.string()).optional(),claims_locales_supported:i.z.array(i.z.string()).optional(),claims_parameter_supported:i.z.boolean().optional(),request_parameter_supported:i.z.boolean().optional(),request_uri_parameter_supported:i.z.boolean().optional(),require_request_uri_registration:i.z.boolean().optional(),scopes_supported:i.z.array(i.z.string()).optional(),subject_types_supported:i.z.array(i.z.string()).optional(),response_types_supported:i.z.array(i.z.string()).optional(),response_modes_supported:i.z.array(i.z.string()).optional(),grant_types_supported:i.z.array(i.z.string()).optional(),code_challenge_methods_supported:i.z.array(a.oauthCodeChallengeMethodSchema).min(1).optional(),ui_locales_supported:i.z.array(i.z.string()).optional(),id_token_signing_alg_values_supported:i.z.array(i.z.string()).optional(),display_values_supported:i.z.array(i.z.string()).optional(),request_object_signing_alg_values_supported:i.z.array(i.z.string()).optional(),authorization_response_iss_parameter_supported:i.z.boolean().optional(),authorization_details_types_supported:i.z.array(i.z.string()).optional(),request_object_encryption_alg_values_supported:i.z.array(i.z.string()).optional(),request_object_encryption_enc_values_supported:i.z.array(i.z.string()).optional(),jwks_uri:n.webUriSchema.optional(),authorization_endpoint:n.webUriSchema,token_endpoint:n.webUriSchema,token_endpoint_auth_methods_supported:i.z.array(i.z.string()).optional(),token_endpoint_auth_signing_alg_values_supported:i.z.array(i.z.string()).optional(),revocation_endpoint:n.webUriSchema.optional(),introspection_endpoint:n.webUriSchema.optional(),pushed_authorization_request_endpoint:n.webUriSchema.optional(),require_pushed_authorization_requests:i.z.boolean().optional(),userinfo_endpoint:n.webUriSchema.optional(),end_session_endpoint:n.webUriSchema.optional(),registration_endpoint:n.webUriSchema.optional(),dpop_signing_alg_values_supported:i.z.array(i.z.string()).optional(),protected_resources:i.z.array(n.webUriSchema).optional(),client_id_metadata_document_supported:i.z.boolean().optional()}),t.oauthAuthorizationServerMetadataValidator=t.oauthAuthorizationServerMetadataSchema.superRefine((e,t)=>{e.require_pushed_authorization_requests&&!e.pushed_authorization_request_endpoint&&t.addIssue({code:i.z.ZodIssueCode.custom,message:'"pushed_authorization_request_endpoint" required when "require_pushed_authorization_requests" is true'})}).superRefine((e,t)=>{e.response_types_supported&&!e.response_types_supported.includes("code")&&t.addIssue({code:i.z.ZodIssueCode.custom,message:'Response type "code" is required'})})},48815:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthClientCredentialsGrantTokenRequestSchema=void 0;let i=r(14747);t.oauthClientCredentialsGrantTokenRequestSchema=i.z.object({grant_type:i.z.literal("client_credentials")})},5943:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthClientCredentialsSchema=t.oauthClientCredentialsNoneSchema=t.oauthClientCredentialsSecretPostSchema=t.oauthClientCredentialsJwtBearerSchema=void 0;let i=r(14747),a=r(19538),o=r(62761),n=r(44984);t.oauthClientCredentialsJwtBearerSchema=i.z.object({client_id:n.oauthClientIdSchema,client_assertion_type:i.z.literal(o.CLIENT_ASSERTION_TYPE_JWT_BEARER),client_assertion:a.signedJwtSchema}),t.oauthClientCredentialsSecretPostSchema=i.z.object({client_id:n.oauthClientIdSchema,client_secret:i.z.string()}),t.oauthClientCredentialsNoneSchema=i.z.object({client_id:n.oauthClientIdSchema}),t.oauthClientCredentialsSchema=i.z.union([t.oauthClientCredentialsJwtBearerSchema,t.oauthClientCredentialsSecretPostSchema,t.oauthClientCredentialsNoneSchema])},75572:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.conventionalOAuthClientIdSchema=t.oauthClientIdDiscoverableSchema=void 0,t.isOAuthClientIdDiscoverable=function(e){return t.oauthClientIdDiscoverableSchema.safeParse(e).success},t.isConventionalOAuthClientId=function(e){return t.conventionalOAuthClientIdSchema.safeParse(e).success},t.assertOAuthDiscoverableClientId=function(e){t.oauthClientIdDiscoverableSchema.parse(e)},t.parseOAuthDiscoverableClientId=function(e){return new URL(t.oauthClientIdDiscoverableSchema.parse(e))};let i=r(14747),a=r(44984),o=r(81130),n=r(64798);t.oauthClientIdDiscoverableSchema=i.z.intersection(a.oauthClientIdSchema,o.httpsUriSchema).superRefine((e,t)=>{let r=new URL(e);return r.username||r.password?(t.addIssue({code:i.z.ZodIssueCode.custom,message:"ClientID must not contain credentials"}),!1):r.hash?(t.addIssue({code:i.z.ZodIssueCode.custom,message:"ClientID must not contain a fragment"}),!1):"/"===r.pathname?(t.addIssue({code:i.z.ZodIssueCode.custom,message:'ClientID must contain a path component (e.g. "/client-metadata.json")'}),!1):r.pathname.endsWith("/")?(t.addIssue({code:i.z.ZodIssueCode.custom,message:"ClientID path must not end with a trailing slash"}),!1):(0,n.isHostnameIP)(r.hostname)?(t.addIssue({code:i.z.ZodIssueCode.custom,message:"ClientID hostname must not be an IP address"}),!1):(0,n.extractUrlPath)(e)===r.pathname||(t.addIssue({code:i.z.ZodIssueCode.custom,message:`ClientID must be in canonical form ("${r.href}", got "${e}")`}),!1)}),t.conventionalOAuthClientIdSchema=t.oauthClientIdDiscoverableSchema.superRefine((e,t)=>{let r=new URL(e);return r.port?(t.addIssue({code:i.z.ZodIssueCode.custom,message:"ClientID must not contain a port"}),!1):r.search?(t.addIssue({code:i.z.ZodIssueCode.custom,message:"ClientID must not contain a query string"}),!1):"/oauth-client-metadata.json"===r.pathname||(t.addIssue({code:i.z.ZodIssueCode.custom,message:'ClientID must be "/oauth-client-metadata.json"'}),!1)})},49460:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthClientIdLoopbackSchema=void 0,t.isOAuthClientIdLoopback=function(e){try{return c(e),!0}catch{return!1}},t.assertOAuthLoopbackClientId=function(e){c(e)},t.parseOAuthLoopbackClientId=c;let i=r(14747),a=r(44984),o=r(81377),n=r(63106),s="http://localhost";function c(e){if(e.startsWith(s)){if(e.includes("#",s.length))throw TypeError("Loopback ClientID must not contain a hash component")}else throw TypeError(`Loopback ClientID must start with "${s}"`);let t=e.length>s.length&&"/"===e[s.length]?s.length+1:s.length;if(e.length===t)return{};if("?"!==e[t])throw TypeError("Loopback ClientID must not contain a path component");let r=new URLSearchParams(e.slice(t+1));for(let e of r.keys())if("redirect_uri"!==e&&"scope"!==e)throw TypeError(`Invalid query parameter "${e}" in client ID`);let i=r.get("scope")??void 0;if(null!=i){if(r.getAll("scope").length>1)throw TypeError("Loopback ClientID must contain at most one scope query parameter");if(!n.oauthScopeSchema.safeParse(i).success)throw TypeError("Invalid scope query parameter in client ID")}return{scope:i,redirect_uris:r.has("redirect_uri")?r.getAll("redirect_uri").map(e=>o.oauthLoopbackRedirectURISchema.parse(e)):void 0}}t.oauthClientIdLoopbackSchema=a.oauthClientIdSchema.superRefine((e,t)=>{try{return c(e),!0}catch(e){return t.addIssue({code:i.ZodIssueCode.custom,message:e instanceof TypeError?e.message:"Invalid loopback client ID"}),!1}})},44984:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthClientIdSchema=void 0;let i=r(14747);t.oauthClientIdSchema=i.z.string().min(1)},44991:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthClientMetadataSchema=void 0;let i=r(14747),a=r(19538),o=r(44984),n=r(18799),s=r(94636),c=r(81377),l=r(26028),d=r(63106),u=r(81130);t.oauthClientMetadataSchema=i.z.object({redirect_uris:i.z.array(c.oauthRedirectUriSchema).nonempty(),response_types:i.z.array(l.oauthResponseTypeSchema).nonempty().default(["code"]),grant_types:i.z.array(s.oauthGrantTypeSchema).nonempty().default(["authorization_code"]),scope:d.oauthScopeSchema.optional(),token_endpoint_auth_method:n.oauthEndpointAuthMethod.default("none").optional(),token_endpoint_auth_signing_alg:i.z.string().optional(),userinfo_signed_response_alg:i.z.string().optional(),userinfo_encrypted_response_alg:i.z.string().optional(),jwks_uri:u.webUriSchema.optional(),jwks:a.jwksPubSchema.optional(),application_type:i.z.enum(["web","native"]).default("web").optional(),subject_type:i.z.enum(["public","pairwise"]).default("public").optional(),request_object_signing_alg:i.z.string().optional(),id_token_signed_response_alg:i.z.string().optional(),authorization_signed_response_alg:i.z.string().default("RS256").optional(),authorization_encrypted_response_enc:i.z.enum(["A128CBC-HS256"]).optional(),authorization_encrypted_response_alg:i.z.string().optional(),client_id:o.oauthClientIdSchema.optional(),client_name:i.z.string().optional(),client_uri:u.webUriSchema.optional(),policy_uri:u.webUriSchema.optional(),tos_uri:u.webUriSchema.optional(),logo_uri:u.webUriSchema.optional(),default_max_age:i.z.number().optional(),require_auth_time:i.z.boolean().optional(),contacts:i.z.array(i.z.string().email()).optional(),tls_client_certificate_bound_access_tokens:i.z.boolean().optional(),dpop_bound_access_tokens:i.z.boolean().optional(),authorization_details_types:i.z.array(i.z.string()).optional()})},17559:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthCodeChallengeMethodSchema=void 0;let i=r(14747);t.oauthCodeChallengeMethodSchema=i.z.enum(["S256","plain"])},18799:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthEndpointAuthMethod=void 0;let i=r(14747);t.oauthEndpointAuthMethod=i.z.enum(["client_secret_basic","client_secret_jwt","client_secret_post","none","private_key_jwt","self_signed_tls_client_auth","tls_client_auth"])},77230:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAUTH_ENDPOINT_NAMES=void 0,t.OAUTH_ENDPOINT_NAMES=["token","revocation","introspection","pushed_authorization_request"]},94636:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthGrantTypeSchema=void 0;let i=r(14747);t.oauthGrantTypeSchema=i.z.enum(["authorization_code","implicit","refresh_token","password","client_credentials","urn:ietf:params:oauth:grant-type:jwt-bearer","urn:ietf:params:oauth:grant-type:saml2-bearer"])},2332:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},18708:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthIssuerIdentifierSchema=void 0;let i=r(14747),a=r(81130);t.oauthIssuerIdentifierSchema=a.webUriSchema.superRefine((e,t)=>{if(e.endsWith("/"))return t.addIssue({code:i.z.ZodIssueCode.custom,message:"Issuer URL must not end with a slash"}),!1;let r=new URL(e);return r.username||r.password?(t.addIssue({code:i.z.ZodIssueCode.custom,message:"Issuer URL must not contain a username or password"}),!1):r.hash||r.search?(t.addIssue({code:i.z.ZodIssueCode.custom,message:"Issuer URL must not contain a query or fragment"}),!1):e===("/"===r.pathname?r.origin:r.href)||(t.addIssue({code:i.z.ZodIssueCode.custom,message:"Issuer URL must be in the canonical form"}),!1)})},34862:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthParResponseSchema=void 0;let i=r(14747);t.oauthParResponseSchema=i.z.object({request_uri:i.z.string(),expires_in:i.z.number().int().positive()})},94857:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthPasswordGrantTokenRequestSchema=void 0;let i=r(14747);t.oauthPasswordGrantTokenRequestSchema=i.z.object({grant_type:i.z.literal("password"),username:i.z.string(),password:i.z.string()})},46318:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthProtectedResourceMetadataSchema=void 0;let i=r(14747),a=r(18708),o=r(81130);t.oauthProtectedResourceMetadataSchema=i.z.object({resource:o.webUriSchema.refine(e=>!e.includes("?"),{message:"Resource URL must not contain query parameters"}).refine(e=>!e.includes("#"),{message:"Resource URL must not contain a fragment"}),authorization_servers:i.z.array(a.oauthIssuerIdentifierSchema).optional(),jwks_uri:o.webUriSchema.optional(),scopes_supported:i.z.array(i.z.string()).optional(),bearer_methods_supported:i.z.array(i.z.enum(["header","body","query"])).optional(),resource_signing_alg_values_supported:i.z.array(i.z.string()).optional(),resource_documentation:o.webUriSchema.optional(),resource_policy_uri:o.webUriSchema.optional(),resource_tos_uri:o.webUriSchema.optional()})},81377:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthRedirectUriSchema=t.oauthPrivateUseRedirectURISchema=t.oauthHttpsRedirectURISchema=t.oauthLoopbackRedirectURISchema=void 0;let i=r(14747),a=r(81130);t.oauthLoopbackRedirectURISchema=a.loopbackUriSchema.superRefine((e,t)=>!e.startsWith("http://localhost")||(t.addIssue({code:i.ZodIssueCode.custom,message:'Use of "localhost" hostname is not allowed (RFC 8252), use a loopback IP such as "127.0.0.1" instead'}),!1)),t.oauthHttpsRedirectURISchema=a.httpsUriSchema,t.oauthPrivateUseRedirectURISchema=a.privateUseUriSchema,t.oauthRedirectUriSchema=i.z.union([t.oauthLoopbackRedirectURISchema,t.oauthHttpsRedirectURISchema,t.oauthPrivateUseRedirectURISchema],{message:'URL must use the "https:" or "http:" protocol, or a private-use URI scheme (RFC 8252)'})},84587:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthRefreshTokenGrantTokenRequestSchema=void 0;let i=r(14747),a=r(89003);t.oauthRefreshTokenGrantTokenRequestSchema=i.z.object({grant_type:i.z.literal("refresh_token"),refresh_token:a.oauthRefreshTokenSchema})},89003:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthRefreshTokenSchema=void 0;let i=r(14747);t.oauthRefreshTokenSchema=i.z.string().min(1)},32663:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthRequestUriSchema=void 0;let i=r(14747);t.oauthRequestUriSchema=i.z.string()},21289:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthResponseModeSchema=void 0;let i=r(14747);t.oauthResponseModeSchema=i.z.enum(["query","fragment","form_post"])},26028:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthResponseTypeSchema=void 0;let i=r(14747);t.oauthResponseTypeSchema=i.z.enum(["code","token","none","code id_token token","code id_token","code token","id_token token","id_token"])},63106:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthScopeSchema=void 0;let i=r(14747);t.oauthScopeSchema=i.z.string().regex(/^[\x21\x23-\x5B\x5D-\x7E]+(?: [\x21\x23-\x5B\x5D-\x7E]+)*$/)},93805:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthTokenIdentificationSchema=void 0;let i=r(14747),a=r(62437),o=r(89003);t.oauthTokenIdentificationSchema=i.z.object({token:i.z.union([a.oauthAccessTokenSchema,o.oauthRefreshTokenSchema]),token_type_hint:i.z.enum(["access_token","refresh_token"]).optional()})},61603:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthTokenRequestSchema=void 0;let i=r(14747),a=r(72989),o=r(48815),n=r(94857),s=r(84587);t.oauthTokenRequestSchema=i.z.discriminatedUnion("grant_type",[a.oauthAuthorizationCodeGrantTokenRequestSchema,s.oauthRefreshTokenGrantTokenRequestSchema,n.oauthPasswordGrantTokenRequestSchema,o.oauthClientCredentialsGrantTokenRequestSchema])},84728:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthTokenResponseSchema=void 0;let i=r(14747),a=r(19538),o=r(33001),n=r(94032);t.oauthTokenResponseSchema=i.z.object({access_token:i.z.string(),token_type:n.oauthTokenTypeSchema,scope:i.z.string().optional(),refresh_token:i.z.string().optional(),expires_in:i.z.number().optional(),id_token:a.signedJwtSchema.optional(),authorization_details:o.oauthAuthorizationDetailsSchema.optional()}).passthrough()},94032:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oauthTokenTypeSchema=void 0;let i=r(14747);t.oauthTokenTypeSchema=i.z.union([i.z.string().regex(/^DPoP$/i).transform(()=>"DPoP"),i.z.string().regex(/^Bearer$/i).transform(()=>"Bearer")])},32274:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oidcAuthenticationErrorResponseSchema=void 0;let i=r(14747);t.oidcAuthenticationErrorResponseSchema=i.z.enum(["interaction_required","login_required","account_selection_required","consent_required","invalid_request_uri","invalid_request_object","request_not_supported","request_uri_not_supported","registration_not_supported"])},91376:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oidcClaimsParameterSchema=void 0;let i=r(14747);t.oidcClaimsParameterSchema=i.z.enum(["auth_time","nonce","acr","name","family_name","given_name","middle_name","nickname","preferred_username","gender","picture","profile","website","birthdate","zoneinfo","locale","updated_at","email","email_verified","phone_number","phone_number_verified","address"])},44903:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oidcClaimsPropertiesSchema=void 0;let i=r(14747),a=i.z.union([i.z.string(),i.z.number(),i.z.boolean()]);t.oidcClaimsPropertiesSchema=i.z.object({essential:i.z.boolean().optional(),value:a.optional(),values:i.z.array(a).optional()})},16454:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oidcEntityTypeSchema=void 0;let i=r(14747);t.oidcEntityTypeSchema=i.z.enum(["userinfo","id_token"])},21153:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oidcUserinfoSchema=void 0;let i=r(14747);t.oidcUserinfoSchema=i.z.object({sub:i.z.string(),iss:i.z.string().url().optional(),aud:i.z.union([i.z.string(),i.z.array(i.z.string()).min(1)]).optional(),email:i.z.string().email().optional(),email_verified:i.z.boolean().optional(),name:i.z.string().optional(),preferred_username:i.z.string().optional(),picture:i.z.string().url().optional()})},81130:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.privateUseUriSchema=t.webUriSchema=t.httpsUriSchema=t.loopbackUriSchema=t.dangerousUriSchema=void 0;let i=r(14747),a=r(64798),o=URL.canParse??(e=>{try{return new URL(e),!0}catch{return!1}});t.dangerousUriSchema=i.z.string().refine(e=>e.includes(":")&&o(e),{message:"Invalid URL"}),t.loopbackUriSchema=t.dangerousUriSchema.superRefine((e,t)=>{if(!e.startsWith("http://"))return t.addIssue({code:i.ZodIssueCode.custom,message:'URL must use the "http:" protocol'}),!1;let r=new URL(e);return!!(0,a.isLoopbackHost)(r.hostname)||(t.addIssue({code:i.ZodIssueCode.custom,message:'URL must use "localhost", "127.0.0.1" or "[::1]" as hostname'}),!1)}),t.httpsUriSchema=t.dangerousUriSchema.superRefine((e,t)=>{if(!e.startsWith("https://"))return t.addIssue({code:i.ZodIssueCode.custom,message:'URL must use the "https:" protocol'}),!1;let r=new URL(e);if((0,a.isLoopbackHost)(r.hostname))return t.addIssue({code:i.ZodIssueCode.custom,message:"https: URL must not use a loopback host"}),!1;if((0,a.isHostnameIP)(r.hostname));else{if(!r.hostname.includes("."))return t.addIssue({code:i.ZodIssueCode.custom,message:"Domain name must contain at least two segments"}),!1;if(r.hostname.endsWith(".local"))return t.addIssue({code:i.ZodIssueCode.custom,message:'Domain name must not end with ".local"'}),!1}return!0}),t.webUriSchema=i.z.string().superRefine((e,r)=>{if(e.startsWith("http://")){let i=t.loopbackUriSchema.safeParse(e);return i.success||i.error.issues.forEach(r.addIssue,r),i.success}if(e.startsWith("https://")){let i=t.httpsUriSchema.safeParse(e);return i.success||i.error.issues.forEach(r.addIssue,r),i.success}return r.addIssue({code:i.ZodIssueCode.custom,message:'URL must use the "http:" or "https:" protocol'}),!1}),t.privateUseUriSchema=t.dangerousUriSchema.superRefine((e,t)=>{let r=e.indexOf("."),a=e.indexOf(":");if(-1===r||-1===a||r>a)return t.addIssue({code:i.ZodIssueCode.custom,message:'Private-use URI scheme requires a "." as part of the protocol'}),!1;let o=new URL(e);return o.protocol.includes(".")?!o.hostname||(t.addIssue({code:i.ZodIssueCode.custom,message:'Private-use URI schemes must not include a hostname (only one "/" is allowed after the protocol, as per RFC 8252)'}),!1):(t.addIssue({code:i.ZodIssueCode.custom,message:"Invalid private-use URI scheme"}),!1)})},64798:function(e,t){"use strict";function r(e){return"localhost"===e||"127.0.0.1"===e||"[::1]"===e}Object.defineProperty(t,"__esModule",{value:!0}),t.isHostnameIP=function(e){return!!(e.match(/^\d+\.\d+\.\d+\.\d+$/)||e.startsWith("[")&&e.endsWith("]"))},t.isLoopbackHost=r,t.isLoopbackUrl=function(e){return r(("string"==typeof e?new URL(e):e).hostname)},t.safeUrl=function(e){try{return new URL(e)}catch{return null}},t.extractUrlPath=function(e){let t=e.startsWith("https://")?8:e.startsWith("http://")?7:-1;if(-1===t)throw TypeError('URL must use the "https:" or "http:" protocol');let r=e.indexOf("#",t),i=e.indexOf("?",t),a=-1!==i&&(-1===r||i<r)?i:-1,o=-1===r?-1===a?e.length:a:-1===a?r:Math.min(r,a),n=e.indexOf("/",t),s=-1===n||n>o?o:n;if(t===s)throw TypeError("URL must contain a host");return e.substring(s,o)}},30329:function(e,t,r){"use strict";var i=r(40257);Object.defineProperty(t,"__esModule",{value:!0}),t.LRUCache=void 0;let a="object"==typeof performance&&performance&&"function"==typeof performance.now?performance:Date,o=new Set,n="object"==typeof i&&i?i:{},s=(e,t,r,i)=>{"function"==typeof n.emitWarning?n.emitWarning(e,t,r,i):console.error(`[${r}] ${t}: ${e}`)},c=globalThis.AbortController,l=globalThis.AbortSignal;if(void 0===c){l=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(e,t){this._onabort.push(t)}},c=class{constructor(){t()}signal=new l;abort(e){if(!this.signal.aborted){for(let t of(this.signal.reason=e,this.signal.aborted=!0,this.signal._onabort))t(e);this.signal.onabort?.(e)}}};let e=n.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",t=()=>{e&&(e=!1,s("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",t))}}let d=e=>!o.has(e);Symbol("type");let u=e=>e&&e===Math.floor(e)&&e>0&&isFinite(e),h=e=>u(e)?e<=256?Uint8Array:e<=65536?Uint16Array:e<=4294967296?Uint32Array:e<=Number.MAX_SAFE_INTEGER?p:null:null;class p extends Array{constructor(e){super(e),this.fill(0)}}class f{heap;length;static #e=!1;static create(e){let t=h(e);if(!t)return[];f.#e=!0;let r=new f(e,t);return f.#e=!1,r}constructor(e,t){if(!f.#e)throw TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}}class y{#t;#r;#i;#a;#o;#n;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#s;#c;#l;#d;#u;#h;#p;#f;#y;#m;#w;#g;#b;#v;#_;#S;#E;static unsafeExposeInternals(e){return{starts:e.#b,ttls:e.#v,sizes:e.#g,keyMap:e.#l,keyList:e.#d,valList:e.#u,next:e.#h,prev:e.#p,get head(){return e.#f},get tail(){return e.#y},free:e.#m,isBackgroundFetch:t=>e.#A(t),backgroundFetch:(t,r,i,a)=>e.#k(t,r,i,a),moveToTail:t=>e.#P(t),indexes:t=>e.#R(t),rindexes:t=>e.#O(t),isStale:t=>e.#I(t)}}get max(){return this.#t}get maxSize(){return this.#r}get calculatedSize(){return this.#c}get size(){return this.#s}get fetchMethod(){return this.#o}get memoMethod(){return this.#n}get dispose(){return this.#i}get disposeAfter(){return this.#a}constructor(e){let{max:t=0,ttl:r,ttlResolution:i=1,ttlAutopurge:a,updateAgeOnGet:n,updateAgeOnHas:c,allowStale:l,dispose:p,disposeAfter:m,noDisposeOnSet:w,noUpdateTTL:g,maxSize:b=0,maxEntrySize:v=0,sizeCalculation:_,fetchMethod:S,memoMethod:E,noDeleteOnFetchRejection:A,noDeleteOnStaleGet:k,allowStaleOnFetchRejection:P,allowStaleOnFetchAbort:R,ignoreFetchAbort:O}=e;if(0!==t&&!u(t))throw TypeError("max option must be a nonnegative integer");let I=t?h(t):Array;if(!I)throw Error("invalid max value: "+t);if(this.#t=t,this.#r=b,this.maxEntrySize=v||this.#r,this.sizeCalculation=_,this.sizeCalculation){if(!this.#r&&!this.maxEntrySize)throw TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if("function"!=typeof this.sizeCalculation)throw TypeError("sizeCalculation set to non-function")}if(void 0!==E&&"function"!=typeof E)throw TypeError("memoMethod must be a function if defined");if(this.#n=E,void 0!==S&&"function"!=typeof S)throw TypeError("fetchMethod must be a function if specified");if(this.#o=S,this.#S=!!S,this.#l=new Map,this.#d=Array(t).fill(void 0),this.#u=Array(t).fill(void 0),this.#h=new I(t),this.#p=new I(t),this.#f=0,this.#y=0,this.#m=f.create(t),this.#s=0,this.#c=0,"function"==typeof p&&(this.#i=p),"function"==typeof m?(this.#a=m,this.#w=[]):(this.#a=void 0,this.#w=void 0),this.#_=!!this.#i,this.#E=!!this.#a,this.noDisposeOnSet=!!w,this.noUpdateTTL=!!g,this.noDeleteOnFetchRejection=!!A,this.allowStaleOnFetchRejection=!!P,this.allowStaleOnFetchAbort=!!R,this.ignoreFetchAbort=!!O,0!==this.maxEntrySize){if(0!==this.#r&&!u(this.#r))throw TypeError("maxSize must be a positive integer if specified");if(!u(this.maxEntrySize))throw TypeError("maxEntrySize must be a positive integer if specified");this.#T()}if(this.allowStale=!!l,this.noDeleteOnStaleGet=!!k,this.updateAgeOnGet=!!n,this.updateAgeOnHas=!!c,this.ttlResolution=u(i)||0===i?i:1,this.ttlAutopurge=!!a,this.ttl=r||0,this.ttl){if(!u(this.ttl))throw TypeError("ttl must be a positive integer if specified");this.#j()}if(0===this.#t&&0===this.ttl&&0===this.#r)throw TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#t&&!this.#r){let e="LRU_CACHE_UNBOUNDED";d(e)&&(o.add(e),s("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",e,y))}}getRemainingTTL(e){return this.#l.has(e)?1/0:0}#j(){let e=new p(this.#t),t=new p(this.#t);this.#v=e,this.#b=t,this.#z=(r,i,o=a.now())=>{if(t[r]=0!==i?o:0,e[r]=i,0!==i&&this.ttlAutopurge){let e=setTimeout(()=>{this.#I(r)&&this.#C(this.#d[r],"expire")},i+1);e.unref&&e.unref()}},this.#D=r=>{t[r]=0!==e[r]?a.now():0},this.#x=(a,o)=>{if(e[o]){let n=e[o],s=t[o];if(!n||!s)return;a.ttl=n,a.start=s,a.now=r||i();let c=a.now-s;a.remainingTTL=n-c}};let r=0,i=()=>{let e=a.now();if(this.ttlResolution>0){r=e;let t=setTimeout(()=>r=0,this.ttlResolution);t.unref&&t.unref()}return e};this.getRemainingTTL=a=>{let o=this.#l.get(a);if(void 0===o)return 0;let n=e[o],s=t[o];return n&&s?n-((r||i())-s):1/0},this.#I=a=>{let o=t[a],n=e[a];return!!n&&!!o&&(r||i())-o>n}}#D=()=>{};#x=()=>{};#z=()=>{};#I=()=>!1;#T(){let e=new p(this.#t);this.#c=0,this.#g=e,this.#M=t=>{this.#c-=e[t],e[t]=0},this.#W=(e,t,r,i)=>{if(this.#A(t))return 0;if(!u(r)){if(i){if("function"!=typeof i)throw TypeError("sizeCalculation must be a function");if(!u(r=i(t,e)))throw TypeError("sizeCalculation return invalid (expect positive integer)")}else throw TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.")}return r},this.#H=(t,r,i)=>{if(e[t]=r,this.#r){let r=this.#r-e[t];for(;this.#c>r;)this.#K(!0)}this.#c+=e[t],i&&(i.entrySize=r,i.totalCalculatedSize=this.#c)}}#M=e=>{};#H=(e,t,r)=>{};#W=(e,t,r,i)=>{if(r||i)throw TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#R({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#y;this.#U(t)&&((e||!this.#I(t))&&(yield t),t!==this.#f);)t=this.#p[t]}*#O({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#f;this.#U(t)&&((e||!this.#I(t))&&(yield t),t!==this.#y);)t=this.#h[t]}#U(e){return void 0!==e&&this.#l.get(this.#d[e])===e}*entries(){for(let e of this.#R())void 0===this.#u[e]||void 0===this.#d[e]||this.#A(this.#u[e])||(yield[this.#d[e],this.#u[e]])}*rentries(){for(let e of this.#O())void 0===this.#u[e]||void 0===this.#d[e]||this.#A(this.#u[e])||(yield[this.#d[e],this.#u[e]])}*keys(){for(let e of this.#R()){let t=this.#d[e];void 0===t||this.#A(this.#u[e])||(yield t)}}*rkeys(){for(let e of this.#O()){let t=this.#d[e];void 0===t||this.#A(this.#u[e])||(yield t)}}*values(){for(let e of this.#R())void 0===this.#u[e]||this.#A(this.#u[e])||(yield this.#u[e])}*rvalues(){for(let e of this.#O())void 0===this.#u[e]||this.#A(this.#u[e])||(yield this.#u[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(let r of this.#R()){let i=this.#u[r],a=this.#A(i)?i.__staleWhileFetching:i;if(void 0!==a&&e(a,this.#d[r],this))return this.get(this.#d[r],t)}}forEach(e,t=this){for(let r of this.#R()){let i=this.#u[r],a=this.#A(i)?i.__staleWhileFetching:i;void 0!==a&&e.call(t,a,this.#d[r],this)}}rforEach(e,t=this){for(let r of this.#O()){let i=this.#u[r],a=this.#A(i)?i.__staleWhileFetching:i;void 0!==a&&e.call(t,a,this.#d[r],this)}}purgeStale(){let e=!1;for(let t of this.#O({allowStale:!0}))this.#I(t)&&(this.#C(this.#d[t],"expire"),e=!0);return e}info(e){let t=this.#l.get(e);if(void 0===t)return;let r=this.#u[t],i=this.#A(r)?r.__staleWhileFetching:r;if(void 0===i)return;let o={value:i};if(this.#v&&this.#b){let e=this.#v[t],r=this.#b[t];if(e&&r){let t=e-(a.now()-r);o.ttl=t,o.start=Date.now()}}return this.#g&&(o.size=this.#g[t]),o}dump(){let e=[];for(let t of this.#R({allowStale:!0})){let r=this.#d[t],i=this.#u[t],o=this.#A(i)?i.__staleWhileFetching:i;if(void 0===o||void 0===r)continue;let n={value:o};if(this.#v&&this.#b){n.ttl=this.#v[t];let e=a.now()-this.#b[t];n.start=Math.floor(Date.now()-e)}this.#g&&(n.size=this.#g[t]),e.unshift([r,n])}return e}load(e){for(let[t,r]of(this.clear(),e)){if(r.start){let e=Date.now()-r.start;r.start=a.now()-e}this.set(t,r.value,r)}}set(e,t,r={}){if(void 0===t)return this.delete(e),this;let{ttl:i=this.ttl,start:a,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:n=this.sizeCalculation,status:s}=r,{noUpdateTTL:c=this.noUpdateTTL}=r,l=this.#W(e,t,r.size||0,n);if(this.maxEntrySize&&l>this.maxEntrySize)return s&&(s.set="miss",s.maxEntrySizeExceeded=!0),this.#C(e,"set"),this;let d=0===this.#s?void 0:this.#l.get(e);if(void 0===d)d=0===this.#s?this.#y:0!==this.#m.length?this.#m.pop():this.#s===this.#t?this.#K(!1):this.#s,this.#d[d]=e,this.#u[d]=t,this.#l.set(e,d),this.#h[this.#y]=d,this.#p[d]=this.#y,this.#y=d,this.#s++,this.#H(d,l,s),s&&(s.set="add"),c=!1;else{this.#P(d);let r=this.#u[d];if(t!==r){if(this.#S&&this.#A(r)){r.__abortController.abort(Error("replaced"));let{__staleWhileFetching:t}=r;void 0!==t&&!o&&(this.#_&&this.#i?.(t,e,"set"),this.#E&&this.#w?.push([t,e,"set"]))}else!o&&(this.#_&&this.#i?.(r,e,"set"),this.#E&&this.#w?.push([r,e,"set"]));if(this.#M(d),this.#H(d,l,s),this.#u[d]=t,s){s.set="replace";let e=r&&this.#A(r)?r.__staleWhileFetching:r;void 0!==e&&(s.oldValue=e)}}else s&&(s.set="update")}if(0===i||this.#v||this.#j(),this.#v&&(c||this.#z(d,i,a),s&&this.#x(s,d)),!o&&this.#E&&this.#w){let e;let t=this.#w;for(;e=t?.shift();)this.#a?.(...e)}return this}pop(){try{for(;this.#s;){let e=this.#u[this.#f];if(this.#K(!0),this.#A(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(void 0!==e)return e}}finally{if(this.#E&&this.#w){let e;let t=this.#w;for(;e=t?.shift();)this.#a?.(...e)}}}#K(e){let t=this.#f,r=this.#d[t],i=this.#u[t];return this.#S&&this.#A(i)?i.__abortController.abort(Error("evicted")):(this.#_||this.#E)&&(this.#_&&this.#i?.(i,r,"evict"),this.#E&&this.#w?.push([i,r,"evict"])),this.#M(t),e&&(this.#d[t]=void 0,this.#u[t]=void 0,this.#m.push(t)),1===this.#s?(this.#f=this.#y=0,this.#m.length=0):this.#f=this.#h[t],this.#l.delete(r),this.#s--,t}has(e,t={}){let{updateAgeOnHas:r=this.updateAgeOnHas,status:i}=t,a=this.#l.get(e);if(void 0!==a){let e=this.#u[a];if(this.#A(e)&&void 0===e.__staleWhileFetching)return!1;if(!this.#I(a))return r&&this.#D(a),i&&(i.has="hit",this.#x(i,a)),!0;i&&(i.has="stale",this.#x(i,a))}else i&&(i.has="miss");return!1}peek(e,t={}){let{allowStale:r=this.allowStale}=t,i=this.#l.get(e);if(void 0===i||!r&&this.#I(i))return;let a=this.#u[i];return this.#A(a)?a.__staleWhileFetching:a}#k(e,t,r,i){let a=void 0===t?void 0:this.#u[t];if(this.#A(a))return a;let o=new c,{signal:n}=r;n?.addEventListener("abort",()=>o.abort(n.reason),{signal:o.signal});let s={signal:o.signal,options:r,context:i},l=(i,a=!1)=>{let{aborted:n}=o.signal,c=r.ignoreFetchAbort&&void 0!==i;return(r.status&&(n&&!a?(r.status.fetchAborted=!0,r.status.fetchError=o.signal.reason,c&&(r.status.fetchAbortIgnored=!0)):r.status.fetchResolved=!0),!n||c||a)?(this.#u[t]===u&&(void 0===i?u.__staleWhileFetching?this.#u[t]=u.__staleWhileFetching:this.#C(e,"fetch"):(r.status&&(r.status.fetchUpdated=!0),this.set(e,i,s.options))),i):d(o.signal.reason)},d=i=>{let{aborted:a}=o.signal,n=a&&r.allowStaleOnFetchAbort,s=n||r.allowStaleOnFetchRejection,c=s||r.noDeleteOnFetchRejection;if(this.#u[t]!==u||(c&&void 0!==u.__staleWhileFetching?n||(this.#u[t]=u.__staleWhileFetching):this.#C(e,"fetch")),s)return r.status&&void 0!==u.__staleWhileFetching&&(r.status.returnedStale=!0),u.__staleWhileFetching;if(u.__returned===u)throw i};r.status&&(r.status.fetchDispatched=!0);let u=new Promise((t,i)=>{let n=this.#o?.(e,a,s);n&&n instanceof Promise&&n.then(e=>t(void 0===e?void 0:e),i),o.signal.addEventListener("abort",()=>{(!r.ignoreFetchAbort||r.allowStaleOnFetchAbort)&&(t(void 0),r.allowStaleOnFetchAbort&&(t=e=>l(e,!0)))})}).then(l,e=>(r.status&&(r.status.fetchRejected=!0,r.status.fetchError=e),d(e))),h=Object.assign(u,{__abortController:o,__staleWhileFetching:a,__returned:void 0});return void 0===t?(this.set(e,h,{...s.options,status:void 0}),t=this.#l.get(e)):this.#u[t]=h,h}#A(e){return!!this.#S&&!!e&&e instanceof Promise&&e.hasOwnProperty("__staleWhileFetching")&&e.__abortController instanceof c}async fetch(e,t={}){let{allowStale:r=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:a=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:n=this.noDisposeOnSet,size:s=0,sizeCalculation:c=this.sizeCalculation,noUpdateTTL:l=this.noUpdateTTL,noDeleteOnFetchRejection:d=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:u=this.allowStaleOnFetchRejection,ignoreFetchAbort:h=this.ignoreFetchAbort,allowStaleOnFetchAbort:p=this.allowStaleOnFetchAbort,context:f,forceRefresh:y=!1,status:m,signal:w}=t;if(!this.#S)return m&&(m.fetch="get"),this.get(e,{allowStale:r,updateAgeOnGet:i,noDeleteOnStaleGet:a,status:m});let g={allowStale:r,updateAgeOnGet:i,noDeleteOnStaleGet:a,ttl:o,noDisposeOnSet:n,size:s,sizeCalculation:c,noUpdateTTL:l,noDeleteOnFetchRejection:d,allowStaleOnFetchRejection:u,allowStaleOnFetchAbort:p,ignoreFetchAbort:h,status:m,signal:w},b=this.#l.get(e);if(void 0===b){m&&(m.fetch="miss");let t=this.#k(e,b,g,f);return t.__returned=t}{let t=this.#u[b];if(this.#A(t)){let e=r&&void 0!==t.__staleWhileFetching;return m&&(m.fetch="inflight",e&&(m.returnedStale=!0)),e?t.__staleWhileFetching:t.__returned=t}let a=this.#I(b);if(!y&&!a)return m&&(m.fetch="hit"),this.#P(b),i&&this.#D(b),m&&this.#x(m,b),t;let o=this.#k(e,b,g,f),n=void 0!==o.__staleWhileFetching&&r;return m&&(m.fetch=a?"stale":"refresh",n&&a&&(m.returnedStale=!0)),n?o.__staleWhileFetching:o.__returned=o}}async forceFetch(e,t={}){let r=await this.fetch(e,t);if(void 0===r)throw Error("fetch() returned undefined");return r}memo(e,t={}){let r=this.#n;if(!r)throw Error("no memoMethod provided to constructor");let{context:i,forceRefresh:a,...o}=t,n=this.get(e,o);if(!a&&void 0!==n)return n;let s=r(e,n,{options:o,context:i});return this.set(e,s,o),s}get(e,t={}){let{allowStale:r=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:a=this.noDeleteOnStaleGet,status:o}=t,n=this.#l.get(e);if(void 0!==n){let t=this.#u[n],s=this.#A(t);return(o&&this.#x(o,n),this.#I(n))?(o&&(o.get="stale"),s)?(o&&r&&void 0!==t.__staleWhileFetching&&(o.returnedStale=!0),r?t.__staleWhileFetching:void 0):(a||this.#C(e,"expire"),o&&r&&(o.returnedStale=!0),r?t:void 0):(o&&(o.get="hit"),s)?t.__staleWhileFetching:(this.#P(n),i&&this.#D(n),t)}o&&(o.get="miss")}#J(e,t){this.#p[t]=e,this.#h[e]=t}#P(e){e!==this.#y&&(e===this.#f?this.#f=this.#h[e]:this.#J(this.#p[e],this.#h[e]),this.#J(this.#y,e),this.#y=e)}delete(e){return this.#C(e,"delete")}#C(e,t){let r=!1;if(0!==this.#s){let i=this.#l.get(e);if(void 0!==i){if(r=!0,1===this.#s)this.#L(t);else{this.#M(i);let r=this.#u[i];if(this.#A(r)?r.__abortController.abort(Error("deleted")):(this.#_||this.#E)&&(this.#_&&this.#i?.(r,e,t),this.#E&&this.#w?.push([r,e,t])),this.#l.delete(e),this.#d[i]=void 0,this.#u[i]=void 0,i===this.#y)this.#y=this.#p[i];else if(i===this.#f)this.#f=this.#h[i];else{let e=this.#p[i];this.#h[e]=this.#h[i];let t=this.#h[i];this.#p[t]=this.#p[i]}this.#s--,this.#m.push(i)}}}if(this.#E&&this.#w?.length){let e;let t=this.#w;for(;e=t?.shift();)this.#a?.(...e)}return r}clear(){return this.#L("delete")}#L(e){for(let t of this.#O({allowStale:!0})){let r=this.#u[t];if(this.#A(r))r.__abortController.abort(Error("deleted"));else{let i=this.#d[t];this.#_&&this.#i?.(r,i,e),this.#E&&this.#w?.push([r,i,e])}}if(this.#l.clear(),this.#u.fill(void 0),this.#d.fill(void 0),this.#v&&this.#b&&(this.#v.fill(0),this.#b.fill(0)),this.#g&&this.#g.fill(0),this.#f=0,this.#y=0,this.#m.length=0,this.#c=0,this.#s=0,this.#E&&this.#w){let e;let t=this.#w;for(;e=t?.shift();)this.#a?.(...e)}}}t.LRUCache=y},86924:function(e,t,r){"use strict";let i,a,o;r.r(t),r.d(t,{CompactEncrypt:function(){return t_},CompactSign:function(){return tA},EmbeddedJWK:function(){return tD},EncryptJWT:function(){return tT},FlattenedEncrypt:function(){return ta},FlattenedSign:function(){return tE},GeneralEncrypt:function(){return tn},GeneralSign:function(){return tP},SignJWT:function(){return tI},UnsecuredJWT:function(){return tN},base64url:function(){return s},calculateJwkThumbprint:function(){return tz},calculateJwkThumbprintUri:function(){return tC},compactDecrypt:function(){return e8},compactVerify:function(){return tu},createLocalJWKSet:function(){return tK},createRemoteJWKSet:function(){return t$},cryptoRuntime:function(){return t1},decodeJwt:function(){return tG},decodeProtectedHeader:function(){return tV},errors:function(){return n},experimental_jwksCache:function(){return tF},exportJWK:function(){return tr},exportPKCS8:function(){return tt},exportSPKI:function(){return te},flattenedDecrypt:function(){return e6},flattenedVerify:function(){return td},generalDecrypt:function(){return e3},generalVerify:function(){return th},generateKeyPair:function(){return tQ},generateSecret:function(){return t0},importJWK:function(){return e$},importPKCS8:function(){return eL},importSPKI:function(){return eU},importX509:function(){return eJ},jwksCache:function(){return tJ},jwtDecrypt:function(){return tv},jwtVerify:function(){return tb}});var n={};r.r(n),r.d(n,{JOSEAlgNotAllowed:function(){return P},JOSEError:function(){return E},JOSENotSupported:function(){return R},JWEDecryptionFailed:function(){return O},JWEInvalid:function(){return I},JWKInvalid:function(){return z},JWKSInvalid:function(){return C},JWKSMultipleMatchingKeys:function(){return x},JWKSNoMatchingKey:function(){return D},JWKSTimeout:function(){return M},JWSInvalid:function(){return T},JWSSignatureVerificationFailed:function(){return W},JWTClaimValidationFailed:function(){return A},JWTExpired:function(){return k},JWTInvalid:function(){return j}});var s={};r.r(s),r.d(s,{decode:function(){return tq},encode:function(){return tB}});var c=crypto;let l=e=>e instanceof CryptoKey,d=async(e,t)=>{let r=`SHA-${e.slice(-3)}`;return new Uint8Array(await c.subtle.digest(r,t))},u=new TextEncoder,h=new TextDecoder;function p(...e){let t=new Uint8Array(e.reduce((e,{length:t})=>e+t,0)),r=0;for(let i of e)t.set(i,r),r+=i.length;return t}function f(e,t,r){if(t<0||t>=4294967296)throw RangeError(`value must be >= 0 and <= ${4294967296-1}. Received ${t}`);e.set([t>>>24,t>>>16,t>>>8,255&t],r)}function y(e){let t=new Uint8Array(8);return f(t,Math.floor(e/4294967296),0),f(t,e%4294967296,4),t}function m(e){let t=new Uint8Array(4);return f(t,e),t}function w(e){return p(m(e.length),e)}async function g(e,t,r){let i=Math.ceil((t>>3)/32),a=new Uint8Array(32*i);for(let t=0;t<i;t++){let i=new Uint8Array(4+e.length+r.length);i.set(m(t+1)),i.set(e,4),i.set(r,4+e.length),a.set(await d("sha256",i),32*t)}return a.slice(0,t>>3)}let b=e=>{let t=e;"string"==typeof t&&(t=u.encode(t));let r=[];for(let e=0;e<t.length;e+=32768)r.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return btoa(r.join(""))},v=e=>b(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),_=e=>{let t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r},S=e=>{let t=e;t instanceof Uint8Array&&(t=h.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return _(t)}catch{throw TypeError("The input to be decoded is not correctly encoded.")}};class E extends Error{constructor(e,t){super(e,t),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}E.code="ERR_JOSE_GENERIC";class A extends E{constructor(e,t,r="unspecified",i="unspecified"){super(e,{cause:{claim:r,reason:i,payload:t}}),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=r,this.reason=i,this.payload=t}}A.code="ERR_JWT_CLAIM_VALIDATION_FAILED";class k extends E{constructor(e,t,r="unspecified",i="unspecified"){super(e,{cause:{claim:r,reason:i,payload:t}}),this.code="ERR_JWT_EXPIRED",this.claim=r,this.reason=i,this.payload=t}}k.code="ERR_JWT_EXPIRED";class P extends E{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}}P.code="ERR_JOSE_ALG_NOT_ALLOWED";class R extends E{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}}R.code="ERR_JOSE_NOT_SUPPORTED";class O extends E{constructor(e="decryption operation failed",t){super(e,t),this.code="ERR_JWE_DECRYPTION_FAILED"}}O.code="ERR_JWE_DECRYPTION_FAILED";class I extends E{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}}I.code="ERR_JWE_INVALID";class T extends E{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}}T.code="ERR_JWS_INVALID";class j extends E{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}}j.code="ERR_JWT_INVALID";class z extends E{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}}z.code="ERR_JWK_INVALID";class C extends E{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}}C.code="ERR_JWKS_INVALID";class D extends E{constructor(e="no applicable key found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_NO_MATCHING_KEY"}}D.code="ERR_JWKS_NO_MATCHING_KEY";class x extends E{constructor(e="multiple matching keys found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}x.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";class M extends E{constructor(e="request timed out",t){super(e,t),this.code="ERR_JWKS_TIMEOUT"}}M.code="ERR_JWKS_TIMEOUT";class W extends E{constructor(e="signature verification failed",t){super(e,t),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}W.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";var H=c.getRandomValues.bind(c);function K(e){switch(e){case"A128GCM":case"A128GCMKW":case"A192GCM":case"A192GCMKW":case"A256GCM":case"A256GCMKW":return 96;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return 128;default:throw new R(`Unsupported JWE Algorithm: ${e}`)}}var U=e=>H(new Uint8Array(K(e)>>3)),J=(e,t)=>{if(t.length<<3!==K(e))throw new I("Invalid Initialization Vector length")},L=(e,t)=>{let r=e.byteLength<<3;if(r!==t)throw new I(`Invalid Content Encryption Key length. Expected ${t} bits, got ${r} bits`)},$=(e,t)=>{if(!(e instanceof Uint8Array))throw TypeError("First argument must be a buffer");if(!(t instanceof Uint8Array))throw TypeError("Second argument must be a buffer");if(e.length!==t.length)throw TypeError("Input buffers must have the same length");let r=e.length,i=0,a=-1;for(;++a<r;)i|=e[a]^t[a];return 0===i};function F(e,t="algorithm.name"){return TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function N(e,t){return e.name===t}function B(e){return parseInt(e.name.slice(4),10)}function q(e,t){if(t.length&&!t.some(t=>e.usages.includes(t))){let e="CryptoKey does not support this operation, its usages must include ";if(t.length>2){let r=t.pop();e+=`one of ${t.join(", ")}, or ${r}.`}else 2===t.length?e+=`one of ${t[0]} or ${t[1]}.`:e+=`${t[0]}.`;throw TypeError(e)}}function V(e,t,...r){switch(t){case"A128GCM":case"A192GCM":case"A256GCM":{if(!N(e.algorithm,"AES-GCM"))throw F("AES-GCM");let r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw F(r,"algorithm.length");break}case"A128KW":case"A192KW":case"A256KW":{if(!N(e.algorithm,"AES-KW"))throw F("AES-KW");let r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw F(r,"algorithm.length");break}case"ECDH":switch(e.algorithm.name){case"ECDH":case"X25519":case"X448":break;default:throw F("ECDH, X25519, or X448")}break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(!N(e.algorithm,"PBKDF2"))throw F("PBKDF2");break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if(!N(e.algorithm,"RSA-OAEP"))throw F("RSA-OAEP");let r=parseInt(t.slice(9),10)||1;if(B(e.algorithm.hash)!==r)throw F(`SHA-${r}`,"algorithm.hash");break}default:throw TypeError("CryptoKey does not support this operation")}q(e,r)}function G(e,t,...r){if((r=r.filter(Boolean)).length>2){let t=r.pop();e+=`one of type ${r.join(", ")}, or ${t}.`}else 2===r.length?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}var Z=(e,...t)=>G("Key must be ",e,...t);function X(e,t,...r){return G(`Key for the ${e} algorithm must be `,t,...r)}var Y=e=>!!l(e)||e?.[Symbol.toStringTag]==="KeyObject";let Q=["CryptoKey"];async function ee(e,t,r,i,a,o){let n,s;if(!(t instanceof Uint8Array))throw TypeError(Z(t,"Uint8Array"));let l=parseInt(e.slice(1,4),10),d=await c.subtle.importKey("raw",t.subarray(l>>3),"AES-CBC",!1,["decrypt"]),u=await c.subtle.importKey("raw",t.subarray(0,l>>3),{hash:`SHA-${l<<1}`,name:"HMAC"},!1,["sign"]),h=p(o,i,r,y(o.length<<3)),f=new Uint8Array((await c.subtle.sign("HMAC",u,h)).slice(0,l>>3));try{n=$(a,f)}catch{}if(!n)throw new O;try{s=new Uint8Array(await c.subtle.decrypt({iv:i,name:"AES-CBC"},d,r))}catch{}if(!s)throw new O;return s}async function et(e,t,r,i,a,o){let n;t instanceof Uint8Array?n=await c.subtle.importKey("raw",t,"AES-GCM",!1,["decrypt"]):(V(t,e,"decrypt"),n=t);try{return new Uint8Array(await c.subtle.decrypt({additionalData:o,iv:i,name:"AES-GCM",tagLength:128},n,p(r,a)))}catch{throw new O}}let er=async(e,t,r,i,a,o)=>{if(!l(t)&&!(t instanceof Uint8Array))throw TypeError(Z(t,...Q,"Uint8Array"));if(!i)throw new I("JWE Initialization Vector missing");if(!a)throw new I("JWE Authentication Tag missing");switch(J(e,i),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return t instanceof Uint8Array&&L(t,parseInt(e.slice(-3),10)),ee(e,t,r,i,a,o);case"A128GCM":case"A192GCM":case"A256GCM":return t instanceof Uint8Array&&L(t,parseInt(e.slice(1,4),10)),et(e,t,r,i,a,o);default:throw new R("Unsupported JWE Content Encryption Algorithm")}};var ei=(...e)=>{let t;let r=e.filter(Boolean);if(0===r.length||1===r.length)return!0;for(let e of r){let r=Object.keys(e);if(!t||0===t.size){t=new Set(r);continue}for(let e of r){if(t.has(e))return!1;t.add(e)}}return!0};function ea(e){if(!("object"==typeof e&&null!==e)||"[object Object]"!==Object.prototype.toString.call(e))return!1;if(null===Object.getPrototypeOf(e))return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}var eo=[{hash:"SHA-256",name:"HMAC"},!0,["sign"]];function en(e,t){if(e.algorithm.length!==parseInt(t.slice(1,4),10))throw TypeError(`Invalid key size for alg: ${t}`)}function es(e,t,r){if(l(e))return V(e,t,r),e;if(e instanceof Uint8Array)return c.subtle.importKey("raw",e,"AES-KW",!0,[r]);throw TypeError(Z(e,...Q,"Uint8Array"))}let ec=async(e,t,r)=>{let i=await es(t,e,"wrapKey");en(i,e);let a=await c.subtle.importKey("raw",r,...eo);return new Uint8Array(await c.subtle.wrapKey("raw",a,i,"AES-KW"))},el=async(e,t,r)=>{let i=await es(t,e,"unwrapKey");en(i,e);let a=await c.subtle.unwrapKey("raw",r,i,"AES-KW",...eo);return new Uint8Array(await c.subtle.exportKey("raw",a))};async function ed(e,t,r,i,a=new Uint8Array(0),o=new Uint8Array(0)){let n;if(!l(e))throw TypeError(Z(e,...Q));if(V(e,"ECDH"),!l(t))throw TypeError(Z(t,...Q));V(t,"ECDH","deriveBits");let s=p(w(u.encode(r)),w(a),w(o),m(i));return n="X25519"===e.algorithm.name?256:"X448"===e.algorithm.name?448:Math.ceil(parseInt(e.algorithm.namedCurve.substr(-3),10)/8)<<3,g(new Uint8Array(await c.subtle.deriveBits({name:e.algorithm.name,public:e},t,n)),i,s)}async function eu(e){if(!l(e))throw TypeError(Z(e,...Q));return c.subtle.generateKey(e.algorithm,!0,["deriveBits"])}function eh(e){if(!l(e))throw TypeError(Z(e,...Q));return["P-256","P-384","P-521"].includes(e.algorithm.namedCurve)||"X25519"===e.algorithm.name||"X448"===e.algorithm.name}async function ep(e,t,r,i){!function(e){if(!(e instanceof Uint8Array)||e.length<8)throw new I("PBES2 Salt Input must be 8 or more octets")}(e);let a=p(u.encode(t),new Uint8Array([0]),e),o=parseInt(t.slice(13,16),10),n={hash:`SHA-${t.slice(8,11)}`,iterations:r,name:"PBKDF2",salt:a},s=await function(e,t){if(e instanceof Uint8Array)return c.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits"]);if(l(e))return V(e,t,"deriveBits","deriveKey"),e;throw TypeError(Z(e,...Q,"Uint8Array"))}(i,t);if(s.usages.includes("deriveBits"))return new Uint8Array(await c.subtle.deriveBits(n,s,o));if(s.usages.includes("deriveKey"))return c.subtle.deriveKey(n,s,{length:o,name:"AES-KW"},!1,["wrapKey","unwrapKey"]);throw TypeError('PBKDF2 key "usages" must include "deriveBits" or "deriveKey"')}let ef=async(e,t,r,i=2048,a=H(new Uint8Array(16)))=>{let o=await ep(a,e,i,t);return{encryptedKey:await ec(e.slice(-6),o,r),p2c:i,p2s:v(a)}},ey=async(e,t,r,i,a)=>{let o=await ep(a,e,i,t);return el(e.slice(-6),o,r)};function em(e){switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return"RSA-OAEP";default:throw new R(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}var ew=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){let{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};let eg=async(e,t,r)=>{if(!l(t))throw TypeError(Z(t,...Q));if(V(t,e,"encrypt","wrapKey"),ew(e,t),t.usages.includes("encrypt"))return new Uint8Array(await c.subtle.encrypt(em(e),t,r));if(t.usages.includes("wrapKey")){let i=await c.subtle.importKey("raw",r,...eo);return new Uint8Array(await c.subtle.wrapKey("raw",i,t,em(e)))}throw TypeError('RSA-OAEP key "usages" must include "encrypt" or "wrapKey" for this operation')},eb=async(e,t,r)=>{if(!l(t))throw TypeError(Z(t,...Q));if(V(t,e,"decrypt","unwrapKey"),ew(e,t),t.usages.includes("decrypt"))return new Uint8Array(await c.subtle.decrypt(em(e),t,r));if(t.usages.includes("unwrapKey")){let i=await c.subtle.unwrapKey("raw",r,t,em(e),...eo);return new Uint8Array(await c.subtle.exportKey("raw",i))}throw TypeError('RSA-OAEP key "usages" must include "decrypt" or "unwrapKey" for this operation')};function ev(e){return ea(e)&&"string"==typeof e.kty}let e_=async e=>{if(!e.alg)throw TypeError('"alg" argument is required when "jwk.alg" is not present');let{algorithm:t,keyUsages:r}=function(e){let t,r;switch(e.kty){case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new R('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new R('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"Ed25519":t={name:"Ed25519"},r=e.d?["sign"]:["verify"];break;case"EdDSA":t={name:e.crv},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new R('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new R('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),i=[t,e.ext??!1,e.key_ops??r],a={...e};return delete a.alg,delete a.use,c.subtle.importKey("jwk",a,...i)},eS=e=>S(e),eE=e=>e?.[Symbol.toStringTag]==="KeyObject",eA=async(e,t,r,i,a=!1)=>{let o=e.get(t);if(o?.[i])return o[i];let n=await e_({...r,alg:i});return a&&Object.freeze(t),o?o[i]=n:e.set(t,{[i]:n}),n};var ek={normalizePublicKey:(e,t)=>{if(eE(e)){let r=e.export({format:"jwk"});return(delete r.d,delete r.dp,delete r.dq,delete r.p,delete r.q,delete r.qi,r.k)?eS(r.k):(a||(a=new WeakMap),eA(a,e,r,t))}return ev(e)?e.k?S(e.k):(a||(a=new WeakMap),eA(a,e,e,t,!0)):e},normalizePrivateKey:(e,t)=>{if(eE(e)){let r=e.export({format:"jwk"});return r.k?eS(r.k):(i||(i=new WeakMap),eA(i,e,r,t))}return ev(e)?e.k?S(e.k):(i||(i=new WeakMap),eA(i,e,e,t,!0)):e}};function eP(e){switch(e){case"A128GCM":return 128;case"A192GCM":return 192;case"A256GCM":case"A128CBC-HS256":return 256;case"A192CBC-HS384":return 384;case"A256CBC-HS512":return 512;default:throw new R(`Unsupported JWE Algorithm: ${e}`)}}var eR=e=>H(new Uint8Array(eP(e)>>3)),eO=(e,t)=>{let r=(e.match(/.{1,64}/g)||[]).join("\n");return`-----BEGIN ${t}-----
${r}
-----END ${t}-----`};let eI=async(e,t,r)=>{if(!l(r))throw TypeError(Z(r,...Q));if(!r.extractable)throw TypeError("CryptoKey is not extractable");if(r.type!==e)throw TypeError(`key is not a ${e} key`);return eO(b(new Uint8Array(await c.subtle.exportKey(t,r))),`${e.toUpperCase()} KEY`)},eT=e=>eI("public","spki",e),ej=e=>eI("private","pkcs8",e),ez=(e,t,r=0)=>{0===r&&(t.unshift(t.length),t.unshift(6));let i=e.indexOf(t[0],r);if(-1===i)return!1;let a=e.subarray(i,i+t.length);return a.length===t.length&&(a.every((e,r)=>e===t[r])||ez(e,t,i+1))},eC=e=>{switch(!0){case ez(e,[42,134,72,206,61,3,1,7]):return"P-256";case ez(e,[43,129,4,0,34]):return"P-384";case ez(e,[43,129,4,0,35]):return"P-521";case ez(e,[43,101,110]):return"X25519";case ez(e,[43,101,111]):return"X448";case ez(e,[43,101,112]):return"Ed25519";case ez(e,[43,101,113]):return"Ed448";default:throw new R("Invalid or unsupported EC Key Curve or OKP Key Sub Type")}},eD=async(e,t,r,i,a)=>{let o,n;let s=new Uint8Array(atob(r.replace(e,"")).split("").map(e=>e.charCodeAt(0))),l="spki"===t;switch(i){case"PS256":case"PS384":case"PS512":o={name:"RSA-PSS",hash:`SHA-${i.slice(-3)}`},n=l?["verify"]:["sign"];break;case"RS256":case"RS384":case"RS512":o={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${i.slice(-3)}`},n=l?["verify"]:["sign"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":o={name:"RSA-OAEP",hash:`SHA-${parseInt(i.slice(-3),10)||1}`},n=l?["encrypt","wrapKey"]:["decrypt","unwrapKey"];break;case"ES256":o={name:"ECDSA",namedCurve:"P-256"},n=l?["verify"]:["sign"];break;case"ES384":o={name:"ECDSA",namedCurve:"P-384"},n=l?["verify"]:["sign"];break;case"ES512":o={name:"ECDSA",namedCurve:"P-521"},n=l?["verify"]:["sign"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{let e=eC(s);o=e.startsWith("P-")?{name:"ECDH",namedCurve:e}:{name:e},n=l?[]:["deriveBits"];break}case"Ed25519":o={name:"Ed25519"},n=l?["verify"]:["sign"];break;case"EdDSA":o={name:eC(s)},n=l?["verify"]:["sign"];break;default:throw new R('Invalid or unsupported "alg" (Algorithm) value')}return c.subtle.importKey(t,s,o,a?.extractable??!1,n)},ex=(e,t,r)=>eD(/(?:-----(?:BEGIN|END) PRIVATE KEY-----|\s)/g,"pkcs8",e,t,r),eM=(e,t,r)=>eD(/(?:-----(?:BEGIN|END) PUBLIC KEY-----|\s)/g,"spki",e,t,r);function eW(e){let t=[],r=0;for(;r<e.length;){let i=eH(e.subarray(r));t.push(i),r+=i.byteLength}return t}function eH(e){let t=0,r=31&e[0];if(t++,31===r){for(r=0;e[t]>=128;)r=128*r+e[t]-128,t++;r=128*r+e[t]-128,t++}let i=0;if(e[t]<128)i=e[t],t++;else if(128===i){for(i=0;0!==e[t+i]||0!==e[t+i+1];){if(i>e.byteLength)throw TypeError("invalid indefinite form length");i++}let r=t+i+2;return{byteLength:r,contents:e.subarray(t,t+i),raw:e.subarray(0,r)}}else{let r=127&e[t];t++,i=0;for(let a=0;a<r;a++)i=256*i+e[t],t++}let a=t+i;return{byteLength:a,contents:e.subarray(t,a),raw:e.subarray(0,a)}}let eK=(e,t,r)=>{let i;try{i=eO(function(e){let t=eW(eW(eH(e).contents)[0].contents);return b(t[160===t[0].raw[0]?6:5].raw)}(_(e.replace(/(?:-----(?:BEGIN|END) CERTIFICATE-----|\s)/g,""))),"PUBLIC KEY")}catch(e){throw TypeError("Failed to parse the X.509 certificate",{cause:e})}return eM(i,t,r)};async function eU(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PUBLIC KEY-----"))throw TypeError('"spki" must be SPKI formatted string');return eM(e,t,r)}async function eJ(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN CERTIFICATE-----"))throw TypeError('"x509" must be X.509 formatted string');return eK(e,t,r)}async function eL(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PRIVATE KEY-----"))throw TypeError('"pkcs8" must be PKCS#8 formatted string');return ex(e,t,r)}async function e$(e,t){if(!ea(e))throw TypeError("JWK must be an object");switch(t||(t=e.alg),e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw TypeError('missing "k" (Key Value) Parameter value');return S(e.k);case"RSA":if("oth"in e&&void 0!==e.oth)throw new R('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return e_({...e,alg:t});default:throw new R('Unsupported "kty" (Key Type) Parameter value')}}let eF=e=>e?.[Symbol.toStringTag],eN=(e,t,r)=>{if(void 0!==t.use&&"sig"!==t.use)throw TypeError("Invalid key for this operation, when present its use must be sig");if(void 0!==t.key_ops&&t.key_ops.includes?.(r)!==!0)throw TypeError(`Invalid key for this operation, when present its key_ops must include ${r}`);if(void 0!==t.alg&&t.alg!==e)throw TypeError(`Invalid key for this operation, when present its alg must be ${e}`);return!0},eB=(e,t,r,i)=>{if(!(t instanceof Uint8Array)){if(i&&ev(t)){if(ev(t)&&"oct"===t.kty&&"string"==typeof t.k&&eN(e,t,r))return;throw TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!Y(t))throw TypeError(X(e,t,...Q,"Uint8Array",i?"JSON Web Key":null));if("secret"!==t.type)throw TypeError(`${eF(t)} instances for symmetric algorithms must be of type "secret"`)}},eq=(e,t,r,i)=>{if(i&&ev(t))switch(r){case"sign":if("oct"!==t.kty&&"string"==typeof t.d&&eN(e,t,r))return;throw TypeError("JSON Web Key for this operation be a private JWK");case"verify":if("oct"!==t.kty&&void 0===t.d&&eN(e,t,r))return;throw TypeError("JSON Web Key for this operation be a public JWK")}if(!Y(t))throw TypeError(X(e,t,...Q,i?"JSON Web Key":null));if("secret"===t.type)throw TypeError(`${eF(t)} instances for asymmetric algorithms must not be of type "secret"`);if("sign"===r&&"public"===t.type)throw TypeError(`${eF(t)} instances for asymmetric algorithm signing must be of type "private"`);if("decrypt"===r&&"public"===t.type)throw TypeError(`${eF(t)} instances for asymmetric algorithm decryption must be of type "private"`);if(t.algorithm&&"verify"===r&&"private"===t.type)throw TypeError(`${eF(t)} instances for asymmetric algorithm verifying must be of type "public"`);if(t.algorithm&&"encrypt"===r&&"private"===t.type)throw TypeError(`${eF(t)} instances for asymmetric algorithm encryption must be of type "public"`)};function eV(e,t,r,i){t.startsWith("HS")||"dir"===t||t.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(t)?eB(t,r,i,e):eq(t,r,i,e)}var eG=eV.bind(void 0,!1);let eZ=eV.bind(void 0,!0);async function eX(e,t,r,i,a){if(!(r instanceof Uint8Array))throw TypeError(Z(r,"Uint8Array"));let o=parseInt(e.slice(1,4),10),n=await c.subtle.importKey("raw",r.subarray(o>>3),"AES-CBC",!1,["encrypt"]),s=await c.subtle.importKey("raw",r.subarray(0,o>>3),{hash:`SHA-${o<<1}`,name:"HMAC"},!1,["sign"]),l=new Uint8Array(await c.subtle.encrypt({iv:i,name:"AES-CBC"},n,t)),d=p(a,i,l,y(a.length<<3));return{ciphertext:l,tag:new Uint8Array((await c.subtle.sign("HMAC",s,d)).slice(0,o>>3)),iv:i}}async function eY(e,t,r,i,a){let o;r instanceof Uint8Array?o=await c.subtle.importKey("raw",r,"AES-GCM",!1,["encrypt"]):(V(r,e,"encrypt"),o=r);let n=new Uint8Array(await c.subtle.encrypt({additionalData:a,iv:i,name:"AES-GCM",tagLength:128},o,t)),s=n.slice(-16);return{ciphertext:n.slice(0,-16),tag:s,iv:i}}let eQ=async(e,t,r,i,a)=>{if(!l(r)&&!(r instanceof Uint8Array))throw TypeError(Z(r,...Q,"Uint8Array"));switch(i?J(e,i):i=U(e),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return r instanceof Uint8Array&&L(r,parseInt(e.slice(-3),10)),eX(e,t,r,i,a);case"A128GCM":case"A192GCM":case"A256GCM":return r instanceof Uint8Array&&L(r,parseInt(e.slice(1,4),10)),eY(e,t,r,i,a);default:throw new R("Unsupported JWE Content Encryption Algorithm")}};async function e0(e,t,r,i){let a=e.slice(0,7),o=await eQ(a,r,t,i,new Uint8Array(0));return{encryptedKey:o.ciphertext,iv:v(o.iv),tag:v(o.tag)}}async function e1(e,t,r,i,a){return er(e.slice(0,7),t,r,i,a,new Uint8Array(0))}async function e2(e,t,r,i,a){switch(eG(e,t,"decrypt"),t=await ek.normalizePrivateKey?.(t,e)||t,e){case"dir":if(void 0!==r)throw new I("Encountered unexpected JWE Encrypted Key");return t;case"ECDH-ES":if(void 0!==r)throw new I("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{let a,o;if(!ea(i.epk))throw new I('JOSE Header "epk" (Ephemeral Public Key) missing or invalid');if(!eh(t))throw new R("ECDH with the provided key is not allowed or not supported by your javascript runtime");let n=await e$(i.epk,e);if(void 0!==i.apu){if("string"!=typeof i.apu)throw new I('JOSE Header "apu" (Agreement PartyUInfo) invalid');try{a=S(i.apu)}catch{throw new I("Failed to base64url decode the apu")}}if(void 0!==i.apv){if("string"!=typeof i.apv)throw new I('JOSE Header "apv" (Agreement PartyVInfo) invalid');try{o=S(i.apv)}catch{throw new I("Failed to base64url decode the apv")}}let s=await ed(n,t,"ECDH-ES"===e?i.enc:e,"ECDH-ES"===e?eP(i.enc):parseInt(e.slice(-5,-2),10),a,o);if("ECDH-ES"===e)return s;if(void 0===r)throw new I("JWE Encrypted Key missing");return el(e.slice(-6),s,r)}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":if(void 0===r)throw new I("JWE Encrypted Key missing");return eb(e,t,r);case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{let o;if(void 0===r)throw new I("JWE Encrypted Key missing");if("number"!=typeof i.p2c)throw new I('JOSE Header "p2c" (PBES2 Count) missing or invalid');let n=a?.maxPBES2Count||1e4;if(i.p2c>n)throw new I('JOSE Header "p2c" (PBES2 Count) out is of acceptable bounds');if("string"!=typeof i.p2s)throw new I('JOSE Header "p2s" (PBES2 Salt) missing or invalid');try{o=S(i.p2s)}catch{throw new I("Failed to base64url decode the p2s")}return ey(e,t,r,i.p2c,o)}case"A128KW":case"A192KW":case"A256KW":if(void 0===r)throw new I("JWE Encrypted Key missing");return el(e,t,r);case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{let a,o;if(void 0===r)throw new I("JWE Encrypted Key missing");if("string"!=typeof i.iv)throw new I('JOSE Header "iv" (Initialization Vector) missing or invalid');if("string"!=typeof i.tag)throw new I('JOSE Header "tag" (Authentication Tag) missing or invalid');try{a=S(i.iv)}catch{throw new I("Failed to base64url decode the iv")}try{o=S(i.tag)}catch{throw new I("Failed to base64url decode the tag")}return e1(e,t,r,a,o)}default:throw new R('Invalid or unsupported "alg" (JWE Algorithm) header value')}}var e4=function(e,t,r,i,a){let o;if(void 0!==a.crit&&i?.crit===void 0)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!i||void 0===i.crit)return new Set;if(!Array.isArray(i.crit)||0===i.crit.length||i.crit.some(e=>"string"!=typeof e||0===e.length))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');for(let n of(o=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t,i.crit)){if(!o.has(n))throw new R(`Extension Header Parameter "${n}" is not recognized`);if(void 0===a[n])throw new e(`Extension Header Parameter "${n}" is missing`);if(o.get(n)&&void 0===i[n])throw new e(`Extension Header Parameter "${n}" MUST be integrity protected`)}return new Set(i.crit)},e5=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};async function e6(e,t,r){let i,a,o,n,s,c,l;if(!ea(e))throw new I("Flattened JWE must be an object");if(void 0===e.protected&&void 0===e.header&&void 0===e.unprotected)throw new I("JOSE Header missing");if(void 0!==e.iv&&"string"!=typeof e.iv)throw new I("JWE Initialization Vector incorrect type");if("string"!=typeof e.ciphertext)throw new I("JWE Ciphertext missing or incorrect type");if(void 0!==e.tag&&"string"!=typeof e.tag)throw new I("JWE Authentication Tag incorrect type");if(void 0!==e.protected&&"string"!=typeof e.protected)throw new I("JWE Protected Header incorrect type");if(void 0!==e.encrypted_key&&"string"!=typeof e.encrypted_key)throw new I("JWE Encrypted Key incorrect type");if(void 0!==e.aad&&"string"!=typeof e.aad)throw new I("JWE AAD incorrect type");if(void 0!==e.header&&!ea(e.header))throw new I("JWE Shared Unprotected Header incorrect type");if(void 0!==e.unprotected&&!ea(e.unprotected))throw new I("JWE Per-Recipient Unprotected Header incorrect type");if(e.protected)try{let t=S(e.protected);i=JSON.parse(h.decode(t))}catch{throw new I("JWE Protected Header is invalid")}if(!ei(i,e.header,e.unprotected))throw new I("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");let d={...i,...e.header,...e.unprotected};if(e4(I,new Map,r?.crit,i,d),void 0!==d.zip)throw new R('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');let{alg:f,enc:y}=d;if("string"!=typeof f||!f)throw new I("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof y||!y)throw new I("missing JWE Encryption Algorithm (enc) in JWE Header");let m=r&&e5("keyManagementAlgorithms",r.keyManagementAlgorithms),w=r&&e5("contentEncryptionAlgorithms",r.contentEncryptionAlgorithms);if(m&&!m.has(f)||!m&&f.startsWith("PBES2"))throw new P('"alg" (Algorithm) Header Parameter value not allowed');if(w&&!w.has(y))throw new P('"enc" (Encryption Algorithm) Header Parameter value not allowed');if(void 0!==e.encrypted_key)try{a=S(e.encrypted_key)}catch{throw new I("Failed to base64url decode the encrypted_key")}let g=!1;"function"==typeof t&&(t=await t(i,e),g=!0);try{o=await e2(f,t,a,d,r)}catch(e){if(e instanceof TypeError||e instanceof I||e instanceof R)throw e;o=eR(y)}if(void 0!==e.iv)try{n=S(e.iv)}catch{throw new I("Failed to base64url decode the iv")}if(void 0!==e.tag)try{s=S(e.tag)}catch{throw new I("Failed to base64url decode the tag")}let b=u.encode(e.protected??"");c=void 0!==e.aad?p(b,u.encode("."),u.encode(e.aad)):b;try{l=S(e.ciphertext)}catch{throw new I("Failed to base64url decode the ciphertext")}let v={plaintext:await er(y,o,l,n,s,c)};if(void 0!==e.protected&&(v.protectedHeader=i),void 0!==e.aad)try{v.additionalAuthenticatedData=S(e.aad)}catch{throw new I("Failed to base64url decode the aad")}return(void 0!==e.unprotected&&(v.sharedUnprotectedHeader=e.unprotected),void 0!==e.header&&(v.unprotectedHeader=e.header),g)?{...v,key:t}:v}async function e8(e,t,r){if(e instanceof Uint8Array&&(e=h.decode(e)),"string"!=typeof e)throw new I("Compact JWE must be a string or Uint8Array");let{0:i,1:a,2:o,3:n,4:s,length:c}=e.split(".");if(5!==c)throw new I("Invalid Compact JWE");let l=await e6({ciphertext:n,iv:o||void 0,protected:i,tag:s||void 0,encrypted_key:a||void 0},t,r),d={plaintext:l.plaintext,protectedHeader:l.protectedHeader};return"function"==typeof t?{...d,key:l.key}:d}async function e3(e,t,r){if(!ea(e))throw new I("General JWE must be an object");if(!Array.isArray(e.recipients)||!e.recipients.every(ea))throw new I("JWE Recipients missing or incorrect type");if(!e.recipients.length)throw new I("JWE Recipients has no members");for(let i of e.recipients)try{return await e6({aad:e.aad,ciphertext:e.ciphertext,encrypted_key:i.encrypted_key,header:i.header,iv:e.iv,protected:e.protected,tag:e.tag,unprotected:e.unprotected},t,r)}catch{}throw new O}let e7=Symbol(),e9=async e=>{if(e instanceof Uint8Array)return{kty:"oct",k:v(e)};if(!l(e))throw TypeError(Z(e,...Q,"Uint8Array"));if(!e.extractable)throw TypeError("non-extractable CryptoKey cannot be exported as a JWK");let{ext:t,key_ops:r,alg:i,use:a,...o}=await c.subtle.exportKey("jwk",e);return o};async function te(e){return eT(e)}async function tt(e){return ej(e)}async function tr(e){return e9(e)}async function ti(e,t,r,i,a={}){let o,n,s;switch(eG(e,r,"encrypt"),r=await ek.normalizePublicKey?.(r,e)||r,e){case"dir":s=r;break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!eh(r))throw new R("ECDH with the provided key is not allowed or not supported by your javascript runtime");let{apu:c,apv:l}=a,{epk:d}=a;d||(d=(await eu(r)).privateKey);let{x:u,y:h,crv:p,kty:f}=await tr(d),y=await ed(r,d,"ECDH-ES"===e?t:e,"ECDH-ES"===e?eP(t):parseInt(e.slice(-5,-2),10),c,l);if(n={epk:{x:u,crv:p,kty:f}},"EC"===f&&(n.epk.y=h),c&&(n.apu=v(c)),l&&(n.apv=v(l)),"ECDH-ES"===e){s=y;break}s=i||eR(t);let m=e.slice(-6);o=await ec(m,y,s);break}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":s=i||eR(t),o=await eg(e,r,s);break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{s=i||eR(t);let{p2c:c,p2s:l}=a;({encryptedKey:o,...n}=await ef(e,r,s,c,l));break}case"A128KW":case"A192KW":case"A256KW":s=i||eR(t),o=await ec(e,r,s);break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{s=i||eR(t);let{iv:c}=a;({encryptedKey:o,...n}=await e0(e,r,s,c));break}default:throw new R('Invalid or unsupported "alg" (JWE Algorithm) header value')}return{cek:s,encryptedKey:o,parameters:n}}class ta{constructor(e){if(!(e instanceof Uint8Array))throw TypeError("plaintext must be an instance of Uint8Array");this._plaintext=e}setKeyManagementParameters(e){if(this._keyManagementParameters)throw TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setProtectedHeader(e){if(this._protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._sharedUnprotectedHeader)throw TypeError("setSharedUnprotectedHeader can only be called once");return this._sharedUnprotectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}setContentEncryptionKey(e){if(this._cek)throw TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw TypeError("setInitializationVector can only be called once");return this._iv=e,this}async encrypt(e,t){let r,i,a,o,n;if(!this._protectedHeader&&!this._unprotectedHeader&&!this._sharedUnprotectedHeader)throw new I("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!ei(this._protectedHeader,this._unprotectedHeader,this._sharedUnprotectedHeader))throw new I("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");let s={...this._protectedHeader,...this._unprotectedHeader,...this._sharedUnprotectedHeader};if(e4(I,new Map,t?.crit,this._protectedHeader,s),void 0!==s.zip)throw new R('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');let{alg:c,enc:l}=s;if("string"!=typeof c||!c)throw new I('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof l||!l)throw new I('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if(this._cek&&("dir"===c||"ECDH-ES"===c))throw TypeError(`setContentEncryptionKey cannot be called with JWE "alg" (Algorithm) Header ${c}`);{let a;({cek:i,encryptedKey:r,parameters:a}=await ti(c,l,e,this._cek,this._keyManagementParameters)),a&&(t&&e7 in t?this._unprotectedHeader?this._unprotectedHeader={...this._unprotectedHeader,...a}:this.setUnprotectedHeader(a):this._protectedHeader?this._protectedHeader={...this._protectedHeader,...a}:this.setProtectedHeader(a))}o=this._protectedHeader?u.encode(v(JSON.stringify(this._protectedHeader))):u.encode(""),this._aad?(n=v(this._aad),a=p(o,u.encode("."),u.encode(n))):a=o;let{ciphertext:d,tag:f,iv:y}=await eQ(l,this._plaintext,i,this._iv,a),m={ciphertext:v(d)};return y&&(m.iv=v(y)),f&&(m.tag=v(f)),r&&(m.encrypted_key=v(r)),n&&(m.aad=n),this._protectedHeader&&(m.protected=h.decode(o)),this._sharedUnprotectedHeader&&(m.unprotected=this._sharedUnprotectedHeader),this._unprotectedHeader&&(m.header=this._unprotectedHeader),m}}class to{constructor(e,t,r){this.parent=e,this.key=t,this.options=r}setUnprotectedHeader(e){if(this.unprotectedHeader)throw TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addRecipient(...e){return this.parent.addRecipient(...e)}encrypt(...e){return this.parent.encrypt(...e)}done(){return this.parent}}class tn{constructor(e){this._recipients=[],this._plaintext=e}addRecipient(e,t){let r=new to(this,e,{crit:t?.crit});return this._recipients.push(r),r}setProtectedHeader(e){if(this._protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._unprotectedHeader)throw TypeError("setSharedUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}async encrypt(){let e;if(!this._recipients.length)throw new I("at least one recipient must be added");if(1===this._recipients.length){let[e]=this._recipients,t=await new ta(this._plaintext).setAdditionalAuthenticatedData(this._aad).setProtectedHeader(this._protectedHeader).setSharedUnprotectedHeader(this._unprotectedHeader).setUnprotectedHeader(e.unprotectedHeader).encrypt(e.key,{...e.options}),r={ciphertext:t.ciphertext,iv:t.iv,recipients:[{}],tag:t.tag};return t.aad&&(r.aad=t.aad),t.protected&&(r.protected=t.protected),t.unprotected&&(r.unprotected=t.unprotected),t.encrypted_key&&(r.recipients[0].encrypted_key=t.encrypted_key),t.header&&(r.recipients[0].header=t.header),r}for(let t=0;t<this._recipients.length;t++){let r=this._recipients[t];if(!ei(this._protectedHeader,this._unprotectedHeader,r.unprotectedHeader))throw new I("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");let i={...this._protectedHeader,...this._unprotectedHeader,...r.unprotectedHeader},{alg:a}=i;if("string"!=typeof a||!a)throw new I('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("dir"===a||"ECDH-ES"===a)throw new I('"dir" and "ECDH-ES" alg may only be used with a single recipient');if("string"!=typeof i.enc||!i.enc)throw new I('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if(e){if(e!==i.enc)throw new I('JWE "enc" (Encryption Algorithm) Header Parameter must be the same for all recipients')}else e=i.enc;if(e4(I,new Map,r.options.crit,this._protectedHeader,i),void 0!==i.zip)throw new R('JWE "zip" (Compression Algorithm) Header Parameter is not supported.')}let t=eR(e),r={ciphertext:"",iv:"",recipients:[],tag:""};for(let i=0;i<this._recipients.length;i++){let a=this._recipients[i],o={};r.recipients.push(o);let n=({...this._protectedHeader,...this._unprotectedHeader,...a.unprotectedHeader}).alg.startsWith("PBES2")?2048+i:void 0;if(0===i){let e=await new ta(this._plaintext).setAdditionalAuthenticatedData(this._aad).setContentEncryptionKey(t).setProtectedHeader(this._protectedHeader).setSharedUnprotectedHeader(this._unprotectedHeader).setUnprotectedHeader(a.unprotectedHeader).setKeyManagementParameters({p2c:n}).encrypt(a.key,{...a.options,[e7]:!0});r.ciphertext=e.ciphertext,r.iv=e.iv,r.tag=e.tag,e.aad&&(r.aad=e.aad),e.protected&&(r.protected=e.protected),e.unprotected&&(r.unprotected=e.unprotected),o.encrypted_key=e.encrypted_key,e.header&&(o.header=e.header);continue}let{encryptedKey:s,parameters:c}=await ti(a.unprotectedHeader?.alg||this._protectedHeader?.alg||this._unprotectedHeader?.alg,e,a.key,t,{p2c:n});o.encrypted_key=v(s),(a.unprotectedHeader||c)&&(o.header={...a.unprotectedHeader,...c})}return r}}function ts(e,t){let r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"Ed25519":return{name:"Ed25519"};case"EdDSA":return{name:t.name};default:throw new R(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}async function tc(e,t,r){if("sign"===r&&(t=await ek.normalizePrivateKey(t,e)),"verify"===r&&(t=await ek.normalizePublicKey(t,e)),l(t))return!function(e,t,...r){switch(t){case"HS256":case"HS384":case"HS512":{if(!N(e.algorithm,"HMAC"))throw F("HMAC");let r=parseInt(t.slice(2),10);if(B(e.algorithm.hash)!==r)throw F(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!N(e.algorithm,"RSASSA-PKCS1-v1_5"))throw F("RSASSA-PKCS1-v1_5");let r=parseInt(t.slice(2),10);if(B(e.algorithm.hash)!==r)throw F(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!N(e.algorithm,"RSA-PSS"))throw F("RSA-PSS");let r=parseInt(t.slice(2),10);if(B(e.algorithm.hash)!==r)throw F(`SHA-${r}`,"algorithm.hash");break}case"EdDSA":if("Ed25519"!==e.algorithm.name&&"Ed448"!==e.algorithm.name)throw F("Ed25519 or Ed448");break;case"Ed25519":if(!N(e.algorithm,"Ed25519"))throw F("Ed25519");break;case"ES256":case"ES384":case"ES512":{if(!N(e.algorithm,"ECDSA"))throw F("ECDSA");let r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw F(r,"algorithm.namedCurve");break}default:throw TypeError("CryptoKey does not support this operation")}q(e,r)}(t,e,r),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw TypeError(Z(t,...Q));return c.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}throw TypeError(Z(t,...Q,"Uint8Array","JSON Web Key"))}let tl=async(e,t,r,i)=>{let a=await tc(e,t,"verify");ew(e,a);let o=ts(e,a.algorithm);try{return await c.subtle.verify(o,a,r,i)}catch{return!1}};async function td(e,t,r){let i,a;if(!ea(e))throw new T("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new T('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new T("JWS Protected Header incorrect type");if(void 0===e.payload)throw new T("JWS Payload missing");if("string"!=typeof e.signature)throw new T("JWS Signature missing or incorrect type");if(void 0!==e.header&&!ea(e.header))throw new T("JWS Unprotected Header incorrect type");let o={};if(e.protected)try{let t=S(e.protected);o=JSON.parse(h.decode(t))}catch{throw new T("JWS Protected Header is invalid")}if(!ei(o,e.header))throw new T("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let n={...o,...e.header},s=e4(T,new Map([["b64",!0]]),r?.crit,o,n),c=!0;if(s.has("b64")&&"boolean"!=typeof(c=o.b64))throw new T('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:l}=n;if("string"!=typeof l||!l)throw new T('JWS "alg" (Algorithm) Header Parameter missing or invalid');let d=r&&e5("algorithms",r.algorithms);if(d&&!d.has(l))throw new P('"alg" (Algorithm) Header Parameter value not allowed');if(c){if("string"!=typeof e.payload)throw new T("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new T("JWS Payload must be a string or an Uint8Array instance");let f=!1;"function"==typeof t?(t=await t(o,e),f=!0,eZ(l,t,"verify"),ev(t)&&(t=await e$(t,l))):eZ(l,t,"verify");let y=p(u.encode(e.protected??""),u.encode("."),"string"==typeof e.payload?u.encode(e.payload):e.payload);try{i=S(e.signature)}catch{throw new T("Failed to base64url decode the signature")}if(!await tl(l,t,i,y))throw new W;if(c)try{a=S(e.payload)}catch{throw new T("Failed to base64url decode the payload")}else a="string"==typeof e.payload?u.encode(e.payload):e.payload;let m={payload:a};return(void 0!==e.protected&&(m.protectedHeader=o),void 0!==e.header&&(m.unprotectedHeader=e.header),f)?{...m,key:t}:m}async function tu(e,t,r){if(e instanceof Uint8Array&&(e=h.decode(e)),"string"!=typeof e)throw new T("Compact JWS must be a string or Uint8Array");let{0:i,1:a,2:o,length:n}=e.split(".");if(3!==n)throw new T("Invalid Compact JWS");let s=await td({payload:a,protected:i,signature:o},t,r),c={payload:s.payload,protectedHeader:s.protectedHeader};return"function"==typeof t?{...c,key:s.key}:c}async function th(e,t,r){if(!ea(e))throw new T("General JWS must be an object");if(!Array.isArray(e.signatures)||!e.signatures.every(ea))throw new T("JWS Signatures missing or incorrect type");for(let i of e.signatures)try{return await td({header:i.header,payload:e.payload,protected:i.protected,signature:i.signature},t,r)}catch{}throw new W}var tp=e=>Math.floor(e.getTime()/1e3);let tf=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i;var ty=e=>{let t;let r=tf.exec(e);if(!r||r[4]&&r[1])throw TypeError("Invalid time period format");let i=parseFloat(r[2]);switch(r[3].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":t=Math.round(i);break;case"minute":case"minutes":case"min":case"mins":case"m":t=Math.round(60*i);break;case"hour":case"hours":case"hr":case"hrs":case"h":t=Math.round(3600*i);break;case"day":case"days":case"d":t=Math.round(86400*i);break;case"week":case"weeks":case"w":t=Math.round(604800*i);break;default:t=Math.round(31557600*i)}return"-"===r[1]||"ago"===r[4]?-t:t};let tm=e=>e.toLowerCase().replace(/^application\//,""),tw=(e,t)=>"string"==typeof e?t.includes(e):!!Array.isArray(e)&&t.some(Set.prototype.has.bind(new Set(e)));var tg=(e,t,r={})=>{let i,a;try{i=JSON.parse(h.decode(t))}catch{}if(!ea(i))throw new j("JWT Claims Set must be a top-level JSON object");let{typ:o}=r;if(o&&("string"!=typeof e.typ||tm(e.typ)!==tm(o)))throw new A('unexpected "typ" JWT header value',i,"typ","check_failed");let{requiredClaims:n=[],issuer:s,subject:c,audience:l,maxTokenAge:d}=r,u=[...n];for(let e of(void 0!==d&&u.push("iat"),void 0!==l&&u.push("aud"),void 0!==c&&u.push("sub"),void 0!==s&&u.push("iss"),new Set(u.reverse())))if(!(e in i))throw new A(`missing required "${e}" claim`,i,e,"missing");if(s&&!(Array.isArray(s)?s:[s]).includes(i.iss))throw new A('unexpected "iss" claim value',i,"iss","check_failed");if(c&&i.sub!==c)throw new A('unexpected "sub" claim value',i,"sub","check_failed");if(l&&!tw(i.aud,"string"==typeof l?[l]:l))throw new A('unexpected "aud" claim value',i,"aud","check_failed");switch(typeof r.clockTolerance){case"string":a=ty(r.clockTolerance);break;case"number":a=r.clockTolerance;break;case"undefined":a=0;break;default:throw TypeError("Invalid clockTolerance option type")}let{currentDate:p}=r,f=tp(p||new Date);if((void 0!==i.iat||d)&&"number"!=typeof i.iat)throw new A('"iat" claim must be a number',i,"iat","invalid");if(void 0!==i.nbf){if("number"!=typeof i.nbf)throw new A('"nbf" claim must be a number',i,"nbf","invalid");if(i.nbf>f+a)throw new A('"nbf" claim timestamp check failed',i,"nbf","check_failed")}if(void 0!==i.exp){if("number"!=typeof i.exp)throw new A('"exp" claim must be a number',i,"exp","invalid");if(i.exp<=f-a)throw new k('"exp" claim timestamp check failed',i,"exp","check_failed")}if(d){let e=f-i.iat;if(e-a>("number"==typeof d?d:ty(d)))throw new k('"iat" claim timestamp check failed (too far in the past)',i,"iat","check_failed");if(e<0-a)throw new A('"iat" claim timestamp check failed (it should be in the past)',i,"iat","check_failed")}return i};async function tb(e,t,r){let i=await tu(e,t,r);if(i.protectedHeader.crit?.includes("b64")&&!1===i.protectedHeader.b64)throw new j("JWTs MUST NOT use unencoded payload");let a={payload:tg(i.protectedHeader,i.payload,r),protectedHeader:i.protectedHeader};return"function"==typeof t?{...a,key:i.key}:a}async function tv(e,t,r){let i=await e8(e,t,r),a=tg(i.protectedHeader,i.plaintext,r),{protectedHeader:o}=i;if(void 0!==o.iss&&o.iss!==a.iss)throw new A('replicated "iss" claim header parameter mismatch',a,"iss","mismatch");if(void 0!==o.sub&&o.sub!==a.sub)throw new A('replicated "sub" claim header parameter mismatch',a,"sub","mismatch");if(void 0!==o.aud&&JSON.stringify(o.aud)!==JSON.stringify(a.aud))throw new A('replicated "aud" claim header parameter mismatch',a,"aud","mismatch");let n={payload:a,protectedHeader:o};return"function"==typeof t?{...n,key:i.key}:n}class t_{constructor(e){this._flattened=new ta(e)}setContentEncryptionKey(e){return this._flattened.setContentEncryptionKey(e),this}setInitializationVector(e){return this._flattened.setInitializationVector(e),this}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}setKeyManagementParameters(e){return this._flattened.setKeyManagementParameters(e),this}async encrypt(e,t){let r=await this._flattened.encrypt(e,t);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}let tS=async(e,t,r)=>{let i=await tc(e,t,"sign");return ew(e,i),new Uint8Array(await c.subtle.sign(ts(e,i.algorithm),i,r))};class tE{constructor(e){if(!(e instanceof Uint8Array))throw TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){let r;if(!this._protectedHeader&&!this._unprotectedHeader)throw new T("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!ei(this._protectedHeader,this._unprotectedHeader))throw new T("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let i={...this._protectedHeader,...this._unprotectedHeader},a=e4(T,new Map([["b64",!0]]),t?.crit,this._protectedHeader,i),o=!0;if(a.has("b64")&&"boolean"!=typeof(o=this._protectedHeader.b64))throw new T('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:n}=i;if("string"!=typeof n||!n)throw new T('JWS "alg" (Algorithm) Header Parameter missing or invalid');eZ(n,e,"sign");let s=this._payload;o&&(s=u.encode(v(s)));let c=p(r=this._protectedHeader?u.encode(v(JSON.stringify(this._protectedHeader))):u.encode(""),u.encode("."),s),l={signature:v(await tS(n,e,c)),payload:""};return o&&(l.payload=h.decode(s)),this._unprotectedHeader&&(l.header=this._unprotectedHeader),this._protectedHeader&&(l.protected=h.decode(r)),l}}class tA{constructor(e){this._flattened=new tE(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){let r=await this._flattened.sign(e,t);if(void 0===r.payload)throw TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}class tk{constructor(e,t,r){this.parent=e,this.key=t,this.options=r}setProtectedHeader(e){if(this.protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this.protectedHeader=e,this}setUnprotectedHeader(e){if(this.unprotectedHeader)throw TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addSignature(...e){return this.parent.addSignature(...e)}sign(...e){return this.parent.sign(...e)}done(){return this.parent}}class tP{constructor(e){this._signatures=[],this._payload=e}addSignature(e,t){let r=new tk(this,e,t);return this._signatures.push(r),r}async sign(){if(!this._signatures.length)throw new T("at least one signature must be added");let e={signatures:[],payload:""};for(let t=0;t<this._signatures.length;t++){let r=this._signatures[t],i=new tE(this._payload);i.setProtectedHeader(r.protectedHeader),i.setUnprotectedHeader(r.unprotectedHeader);let{payload:a,...o}=await i.sign(r.key,r.options);if(0===t)e.payload=a;else if(e.payload!==a)throw new T("inconsistent use of JWS Unencoded Payload (RFC7797)");e.signatures.push(o)}return e}}function tR(e,t){if(!Number.isFinite(t))throw TypeError(`Invalid ${e} input`);return t}class tO{constructor(e={}){if(!ea(e))throw TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return"number"==typeof e?this._payload={...this._payload,nbf:tR("setNotBefore",e)}:e instanceof Date?this._payload={...this._payload,nbf:tR("setNotBefore",tp(e))}:this._payload={...this._payload,nbf:tp(new Date)+ty(e)},this}setExpirationTime(e){return"number"==typeof e?this._payload={...this._payload,exp:tR("setExpirationTime",e)}:e instanceof Date?this._payload={...this._payload,exp:tR("setExpirationTime",tp(e))}:this._payload={...this._payload,exp:tp(new Date)+ty(e)},this}setIssuedAt(e){return void 0===e?this._payload={...this._payload,iat:tp(new Date)}:e instanceof Date?this._payload={...this._payload,iat:tR("setIssuedAt",tp(e))}:"string"==typeof e?this._payload={...this._payload,iat:tR("setIssuedAt",tp(new Date)+ty(e))}:this._payload={...this._payload,iat:tR("setIssuedAt",e)},this}}class tI extends tO{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){let r=new tA(u.encode(JSON.stringify(this._payload)));if(r.setProtectedHeader(this._protectedHeader),Array.isArray(this._protectedHeader?.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new j("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}class tT extends tO{setProtectedHeader(e){if(this._protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setKeyManagementParameters(e){if(this._keyManagementParameters)throw TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setContentEncryptionKey(e){if(this._cek)throw TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw TypeError("setInitializationVector can only be called once");return this._iv=e,this}replicateIssuerAsHeader(){return this._replicateIssuerAsHeader=!0,this}replicateSubjectAsHeader(){return this._replicateSubjectAsHeader=!0,this}replicateAudienceAsHeader(){return this._replicateAudienceAsHeader=!0,this}async encrypt(e,t){let r=new t_(u.encode(JSON.stringify(this._payload)));return this._replicateIssuerAsHeader&&(this._protectedHeader={...this._protectedHeader,iss:this._payload.iss}),this._replicateSubjectAsHeader&&(this._protectedHeader={...this._protectedHeader,sub:this._payload.sub}),this._replicateAudienceAsHeader&&(this._protectedHeader={...this._protectedHeader,aud:this._payload.aud}),r.setProtectedHeader(this._protectedHeader),this._iv&&r.setInitializationVector(this._iv),this._cek&&r.setContentEncryptionKey(this._cek),this._keyManagementParameters&&r.setKeyManagementParameters(this._keyManagementParameters),r.encrypt(e,t)}}let tj=(e,t)=>{if("string"!=typeof e||!e)throw new z(`${t} missing or invalid`)};async function tz(e,t){let r;if(!ea(e))throw TypeError("JWK must be an object");if(t??(t="sha256"),"sha256"!==t&&"sha384"!==t&&"sha512"!==t)throw TypeError('digestAlgorithm must one of "sha256", "sha384", or "sha512"');switch(e.kty){case"EC":tj(e.crv,'"crv" (Curve) Parameter'),tj(e.x,'"x" (X Coordinate) Parameter'),tj(e.y,'"y" (Y Coordinate) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":tj(e.crv,'"crv" (Subtype of Key Pair) Parameter'),tj(e.x,'"x" (Public Key) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x};break;case"RSA":tj(e.e,'"e" (Exponent) Parameter'),tj(e.n,'"n" (Modulus) Parameter'),r={e:e.e,kty:e.kty,n:e.n};break;case"oct":tj(e.k,'"k" (Key Value) Parameter'),r={k:e.k,kty:e.kty};break;default:throw new R('"kty" (Key Type) Parameter missing or unsupported')}let i=u.encode(JSON.stringify(r));return v(await d(t,i))}async function tC(e,t){t??(t="sha256");let r=await tz(e,t);return`urn:ietf:params:oauth:jwk-thumbprint:sha-${t.slice(-3)}:${r}`}async function tD(e,t){let r={...e,...t?.header};if(!ea(r.jwk))throw new T('"jwk" (JSON Web Key) Header Parameter must be a JSON object');let i=await e$({...r.jwk,ext:!0},r.alg);if(i instanceof Uint8Array||"public"!==i.type)throw new T('"jwk" (JSON Web Key) Header Parameter must be a public key');return i}function tx(e){return ea(e)}function tM(e){return"function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))}class tW{constructor(e){if(this._cached=new WeakMap,!(e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(tx)))throw new C("JSON Web Key Set malformed");this._jwks=tM(e)}async getKey(e,t){let{alg:r,kid:i}={...e,...t?.header},a=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new R('Unsupported "alg" value for a JSON Web Key Set')}}(r),o=this._jwks.keys.filter(e=>{let t=a===e.kty;if(t&&"string"==typeof i&&(t=i===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES256K":t="secp256k1"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv;break;case"Ed25519":t="Ed25519"===e.crv;break;case"EdDSA":t="Ed25519"===e.crv||"Ed448"===e.crv}return t}),{0:n,length:s}=o;if(0===s)throw new D;if(1!==s){let e=new x,{_cached:t}=this;throw e[Symbol.asyncIterator]=async function*(){for(let e of o)try{yield await tH(t,e,r)}catch{}},e}return tH(this._cached,n,r)}}async function tH(e,t,r){let i=e.get(t)||e.set(t,{}).get(t);if(void 0===i[r]){let e=await e$({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new C("JSON Web Key Set members must be public keys");i[r]=e}return i[r]}function tK(e){let t=new tW(e),r=async(e,r)=>t.getKey(e,r);return Object.defineProperties(r,{jwks:{value:()=>tM(t._jwks),enumerable:!0,configurable:!1,writable:!1}}),r}let tU=async(e,t,r)=>{let i,a;let o=!1;"function"==typeof AbortController&&(i=new AbortController,a=setTimeout(()=>{o=!0,i.abort()},t));let n=await fetch(e.href,{signal:i?i.signal:void 0,redirect:"manual",headers:r.headers}).catch(e=>{if(o)throw new M;throw e});if(void 0!==a&&clearTimeout(a),200!==n.status)throw new E("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await n.json()}catch{throw new E("Failed to parse the JSON Web Key Set HTTP response as JSON")}};"undefined"!=typeof navigator&&navigator.userAgent?.startsWith?.("Mozilla/5.0 ")||(o="jose/v5.10.0");let tJ=Symbol();class tL{constructor(e,t){if(!(e instanceof URL))throw TypeError("url must be an instance of URL");if(this._url=new URL(e.href),this._options={agent:t?.agent,headers:t?.headers},this._timeoutDuration="number"==typeof t?.timeoutDuration?t?.timeoutDuration:5e3,this._cooldownDuration="number"==typeof t?.cooldownDuration?t?.cooldownDuration:3e4,this._cacheMaxAge="number"==typeof t?.cacheMaxAge?t?.cacheMaxAge:6e5,t?.[tJ]!==void 0){var r,i;this._cache=t?.[tJ],r=t?.[tJ],i=this._cacheMaxAge,!("object"!=typeof r||null===r||!("uat"in r)||"number"!=typeof r.uat||Date.now()-r.uat>=i)&&"jwks"in r&&ea(r.jwks)&&Array.isArray(r.jwks.keys)&&Array.prototype.every.call(r.jwks.keys,ea)&&(this._jwksTimestamp=this._cache.uat,this._local=tK(this._cache.jwks))}}coolingDown(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cooldownDuration}fresh(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cacheMaxAge}async getKey(e,t){this._local&&this.fresh()||await this.reload();try{return await this._local(e,t)}catch(r){if(r instanceof D&&!1===this.coolingDown())return await this.reload(),this._local(e,t);throw r}}async reload(){this._pendingFetch&&("undefined"!=typeof WebSocketPair||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"undefined"!=typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this._pendingFetch=void 0);let e=new Headers(this._options.headers);o&&!e.has("User-Agent")&&(e.set("User-Agent",o),this._options.headers=Object.fromEntries(e.entries())),this._pendingFetch||(this._pendingFetch=tU(this._url,this._timeoutDuration,this._options).then(e=>{this._local=tK(e),this._cache&&(this._cache.uat=Date.now(),this._cache.jwks=e),this._jwksTimestamp=Date.now(),this._pendingFetch=void 0}).catch(e=>{throw this._pendingFetch=void 0,e})),await this._pendingFetch}}function t$(e,t){let r=new tL(e,t),i=async(e,t)=>r.getKey(e,t);return Object.defineProperties(i,{coolingDown:{get:()=>r.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>r.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>r.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>!!r._pendingFetch,enumerable:!0,configurable:!1},jwks:{value:()=>r._local?.jwks(),enumerable:!0,configurable:!1,writable:!1}}),i}let tF=tJ;class tN extends tO{encode(){let e=v(JSON.stringify({alg:"none"})),t=v(JSON.stringify(this._payload));return`${e}.${t}.`}static decode(e,t){let r;if("string"!=typeof e)throw new j("Unsecured JWT must be a string");let{0:i,1:a,2:o,length:n}=e.split(".");if(3!==n||""!==o)throw new j("Invalid Unsecured JWT");try{if(r=JSON.parse(h.decode(S(i))),"none"!==r.alg)throw Error()}catch{throw new j("Invalid Unsecured JWT")}return{payload:tg(r,S(a),t),header:r}}}let tB=v,tq=S;function tV(e){let t;if("string"==typeof e){let r=e.split(".");(3===r.length||5===r.length)&&([t]=r)}else if("object"==typeof e&&e){if("protected"in e)t=e.protected;else throw TypeError("Token does not contain a Protected Header")}try{if("string"!=typeof t||!t)throw Error();let e=JSON.parse(h.decode(tq(t)));if(!ea(e))throw Error();return e}catch{throw TypeError("Invalid Token or Protected Header formatting")}}function tG(e){let t,r;if("string"!=typeof e)throw new j("JWTs must use Compact JWS serialization, JWT must be a string");let{1:i,length:a}=e.split(".");if(5===a)throw new j("Only JWTs using Compact JWS serialization can be decoded");if(3!==a)throw new j("Invalid JWT");if(!i)throw new j("JWTs must contain a payload");try{t=tq(i)}catch{throw new j("Failed to base64url decode the payload")}try{r=JSON.parse(h.decode(t))}catch{throw new j("Failed to parse the decoded payload as JSON")}if(!ea(r))throw new j("Invalid JWT Claims Set");return r}async function tZ(e,t){let r,i,a;switch(e){case"HS256":case"HS384":case"HS512":r=parseInt(e.slice(-3),10),i={name:"HMAC",hash:`SHA-${r}`,length:r},a=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return H(new Uint8Array((r=parseInt(e.slice(-3),10))>>3));case"A128KW":case"A192KW":case"A256KW":i={name:"AES-KW",length:r=parseInt(e.slice(1,4),10)},a=["wrapKey","unwrapKey"];break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":case"A128GCM":case"A192GCM":case"A256GCM":i={name:"AES-GCM",length:r=parseInt(e.slice(1,4),10)},a=["encrypt","decrypt"];break;default:throw new R('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return c.subtle.generateKey(i,t?.extractable??!1,a)}function tX(e){let t=e?.modulusLength??2048;if("number"!=typeof t||t<2048)throw new R("Invalid or unsupported modulusLength option provided, 2048 bits or larger keys must be used");return t}async function tY(e,t){let r,i;switch(e){case"PS256":case"PS384":case"PS512":r={name:"RSA-PSS",hash:`SHA-${e.slice(-3)}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:tX(t)},i=["sign","verify"];break;case"RS256":case"RS384":case"RS512":r={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.slice(-3)}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:tX(t)},i=["sign","verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":r={name:"RSA-OAEP",hash:`SHA-${parseInt(e.slice(-3),10)||1}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:tX(t)},i=["decrypt","unwrapKey","encrypt","wrapKey"];break;case"ES256":r={name:"ECDSA",namedCurve:"P-256"},i=["sign","verify"];break;case"ES384":r={name:"ECDSA",namedCurve:"P-384"},i=["sign","verify"];break;case"ES512":r={name:"ECDSA",namedCurve:"P-521"},i=["sign","verify"];break;case"Ed25519":r={name:"Ed25519"},i=["sign","verify"];break;case"EdDSA":{i=["sign","verify"];let e=t?.crv??"Ed25519";switch(e){case"Ed25519":case"Ed448":r={name:e};break;default:throw new R("Invalid or unsupported crv option provided")}break}case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{i=["deriveKey","deriveBits"];let e=t?.crv??"P-256";switch(e){case"P-256":case"P-384":case"P-521":r={name:"ECDH",namedCurve:e};break;case"X25519":case"X448":r={name:e};break;default:throw new R("Invalid or unsupported crv option provided, supported values are P-256, P-384, P-521, X25519, and X448")}break}default:throw new R('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return c.subtle.generateKey(r,t?.extractable??!1,i)}async function tQ(e,t){return tY(e,t)}async function t0(e,t){return tZ(e,t)}var t1="WebCryptoAPI"}}]);